<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ä¸Šä¼ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .error-container {
            display: none;
            text-align: center;
        }

        .error-content {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 60px 40px;
            max-width: 500px;
            width: 100%;
        }

        .error-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .error-text {
            color: #2d3436;
            font-size: 1.2em;
            line-height: 1.5;
        }

        .main-container {
            display: none;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #2d3436;
            margin-bottom: 10px;
            font-size: 1.8em;
        }

        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-section {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .upload-box {
            width: 200px;
            height: 200px;
            border: 3px dashed #6c5ce7;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            position: relative;
        }

        .upload-box:hover {
            background: #edf2f7;
            transform: translateY(-3px);
            border-color: #a29bfe;
        }

        .upload-box .icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .upload-box p {
            font-weight: bold;
            color: #2d3436;
            margin: 5px 0;
        }

        .upload-box small {
            color: #636e72;
            font-size: 0.85em;
        }

        /* ç§»åŠ¨ç«¯æŒ‰é’® - é‡æ–°è®¾è®¡ */
        .mobile-action-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 1em;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3);
        }

        .mobile-action-btn.photo {
            background: linear-gradient(135deg, #1e90ff, #3742fa);
        }

        /* ä¸Šä¼ æŒ‰é’® */
        .generate-btn {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px auto;
            display: block;
            width: 250px;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
        }

        .generate-btn:disabled {
            background: #b2bec3;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* å…è´£å£°æ˜åŒºåŸŸ */
        .disclaimer-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            text-align: left;
            font-size: 0.9em;
            line-height: 1.6;
            color: #6c757d;
        }

        .disclaimer-box h4 {
            color: #dc3545;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .disclaimer-box ul {
            padding-left: 20px;
        }

        .disclaimer-box li {
            margin-bottom: 8px;
        }

        /* æˆåŠŸæç¤º */
        .success-message {
            background: #d4edda;
            color: #155724;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #c3e6cb;
            display: none;
        }

        /* é¢„è§ˆåŒºåŸŸ */
        .upload-preview {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
        }

        /* æ‘„åƒå¤´æ¨¡æ€æ¡† */
        .camera-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .camera-modal video {
            width: 100%;
            max-width: 500px;
            background: #000;
            border-radius: 10px 10px 0 0;
        }

        .camera-controls {
            width: 100%;
            max-width: 500px;
            background: #333;
            padding: 20px;
            border-radius: 0 0 10px 10px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .camera-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .capture-btn {
            background: #ff4757;
            color: white;
            font-weight: bold;
        }

        .cancel-btn {
            background: #747d8c;
            color: white;
        }

        .switch-camera-btn {
            background: #3742fa;
            color: white;
        }

        /* ç§»åŠ¨ç«¯é¢„è§ˆå®¹å™¨ */
        .mobile-preview-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            padding: 10px;
            text-align: center;
        }

        .mobile-preview-container img {
            max-width: 80px;
            max-height: 80px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .mobile-preview-container .preview-text {
            font-size: 0.9em;
            color: #2d3436;
            margin-bottom: 10px;
        }

        /* ç§»åŠ¨ç«¯æ“ä½œæŒ‰é’®å®¹å™¨ */
        .mobile-action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .mobile-action-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            min-width: 80px;
        }

        .mobile-confirm-btn {
            background: #00b894;
            color: white;
        }

        .mobile-retry-btn {
            background: #ff9f43;
            color: white;
        }

        /* ç§»åŠ¨ç«¯é€‚é… - ä¿®æ”¹éŸ³é¢‘å’Œå›¾ç‰‡ä¸Šä¼ åŒºåŸŸ */
        @media (max-width: 768px) {
            .main-container {
                padding: 20px;
            }

            .upload-section {
                flex-direction: column;
                align-items: center;
            }

            .upload-box {
                width: 100%;
                max-width: 250px;
                height: 180px;
            }

            .generate-btn {
                width: 100%;
                max-width: 250px;
            }

            .camera-modal video {
                max-width: 100%;
            }

            .camera-controls {
                max-width: 100%;
                flex-direction: column;
                gap: 10px;
            }

            .camera-btn {
                width: 100%;
            }

            /* ç§»åŠ¨ç«¯éŸ³é¢‘ä¸Šä¼ åŒºåŸŸç‰¹æ®Šæ ·å¼ */
            #audioUploadBox {
                cursor: default;
            }

            #audioUploadBox .upload-placeholder {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                width: 100%;
            }

            /* éšè—éŸ³é¢‘ä¸Šä¼ åŒºåŸŸåŸæ¥çš„å›¾æ ‡å’Œæ–‡å­— */
            #audioUploadBox .upload-placeholder .icon,
            #audioUploadBox .upload-placeholder p:not(.record-text),
            #audioUploadBox .upload-placeholder small {
                display: none !important;
            }

            /* æ”¾å¤§éº¦å…‹é£å›¾æ ‡å¹¶è°ƒæ•´ä½ç½® */
            #audioUploadBox .mic-icon-large {
                font-size: 3em !important;
                margin-bottom: 15px;
                display: block !important;
            }

            /* å½•åˆ¶æŒ‰é’®æ ·å¼ - è¿™æ˜¯çº¢è‰²å½•éŸ³æŒ‰é’® */
            #audioUploadBox .mobile-action-btn {
                margin-top: 0;
                padding: 10px 20px;
                font-size: 1em;
                font-weight: bold;
                border-radius: 25px;
                width: 80%;
                max-width: 180px;
                justify-content: center;
                background: linear-gradient(135deg, #ff4757, #ff3838);
                box-shadow: 0 4px 12px rgba(255, 71, 87, 0.4);
            }

            /* å½•åˆ¶æŒ‰é’®æ–‡å­—æ ·å¼ */
            #audioUploadBox .record-text {
                color: white;
                font-size: 1em;
                font-weight: bold;
                margin: 0;
            }

            /* ç§»åŠ¨ç«¯å›¾ç‰‡ä¸Šä¼ åŒºåŸŸç‰¹æ®Šæ ·å¼ */
            #imageUploadBox {
                cursor: default;
            }

            #imageUploadBox .upload-placeholder {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                width: 100%;
            }

            /* éšè—å›¾ç‰‡ä¸Šä¼ åŒºåŸŸåŸæ¥çš„å›¾æ ‡å’Œæ–‡å­— */
            #imageUploadBox .upload-placeholder .icon,
            #imageUploadBox .upload-placeholder p:not(.camera-text),
            #imageUploadBox .upload-placeholder small {
                display: none !important;
            }

            /* æ”¾å¤§ç›¸æœºå›¾æ ‡å¹¶è°ƒæ•´ä½ç½® */
            #imageUploadBox .camera-icon-large {
                font-size: 3em !important;
                margin-bottom: 15px;
                display: block !important;
            }

            /* å›¾ç‰‡ä¸Šä¼ åŒºåŸŸæ‹ç…§æŒ‰é’® - ä¸å½•éŸ³æŒ‰é’®å¤§å°ä¸€è‡´ */
            #imageUploadBox .mobile-action-btn.photo {
                margin-top: 0;
                padding: 10px 20px;
                font-size: 1em;
                font-weight: bold;
                border-radius: 25px;
                width: 80%;
                max-width: 180px;
                justify-content: center;
                box-shadow: 0 4px 12px rgba(30, 144, 255, 0.4);
                background: linear-gradient(135deg, #1e90ff, #3742fa);
            }

            /* æ‹ç…§æŒ‰é’®æ–‡å­—æ ·å¼ */
            #imageUploadBox .camera-text {
                color: white;
                font-size: 1em;
                font-weight: bold;
                margin: 0;
            }
        }

        /* æ¡Œé¢ç«¯ä¿æŒåŸæœ‰æ ·å¼ï¼Œä½†éšè—ç§»åŠ¨ç«¯æŒ‰é’® */
        @media (min-width: 769px) {
            .mobile-action-btn {
                display: none;
            }

            .mobile-preview-container {
                display: none !important;
            }

            .mobile-action-buttons {
                display: none !important;
            }

            /* æ¡Œé¢ç«¯æ¢å¤éŸ³é¢‘ä¸Šä¼ åŒºåŸŸåŸå§‹æ ·å¼ */
            #audioUploadBox .upload-placeholder {
                display: flex !important;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            #audioUploadBox .upload-placeholder .icon,
            #audioUploadBox .upload-placeholder p,
            #audioUploadBox .upload-placeholder small {
                display: block !important;
            }

            #audioUploadBox .mic-icon-large {
                display: none !important;
            }

            /* æ¡Œé¢ç«¯æ¢å¤å›¾ç‰‡ä¸Šä¼ åŒºåŸŸåŸå§‹æ ·å¼ */
            #imageUploadBox .upload-placeholder {
                display: flex !important;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            #imageUploadBox .upload-placeholder .icon,
            #imageUploadBox .upload-placeholder p,
            #imageUploadBox .upload-placeholder small {
                display: block !important;
            }

            #imageUploadBox .camera-icon-large {
                display: none !important;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>
</head>

<body>
    <!-- é”™è¯¯å®¹å™¨ï¼ˆéªŒè¯å¤±è´¥æ—¶æ˜¾ç¤ºï¼‰ -->
    <div class="error-container" id="errorContainer">
        <div class="error-content">
            <div class="error-icon">âš ï¸</div>
            <div class="error-text">
                <p>æ— æ•ˆçš„è®¿é—®é“¾æ¥</p>
                <p style="margin-top: 10px;">è¯·é€šè¿‡æ­£ç¡®çš„äºŒç»´ç è¿›å…¥æœ¬é¡µé¢</p>
            </div>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ï¼ˆéªŒè¯æˆåŠŸæ—¶æ˜¾ç¤ºï¼‰ -->
    <div class="main-container" id="mainContainer">
        <h1>â¬†ï¸ è¯·ä¸Šä¼ ä½ çš„å£°éŸ³å’Œå›¾ç‰‡</h1>

        <div class="upload-section" id="uploadSection">
            <!-- éŸ³é¢‘ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-box" id="audioUploadBox">
                <input type="file" id="audioInput" accept="audio/*" hidden>
                <div class="upload-placeholder">
                    <!-- æ¡Œé¢ç«¯æ˜¾ç¤ºçš„åŸå§‹å†…å®¹ -->
                    <span class="icon">ğŸµ</span>
                    <p><strong>ç‚¹å‡»ä¸Šä¼ å£°éŸ³</strong></p>
                    <small>æ”¯æŒ MP3, WAV, M4A ç­‰æ ¼å¼</small>

                    <!-- ç§»åŠ¨ç«¯æ˜¾ç¤ºçš„éº¦å…‹é£å›¾æ ‡ -->
                    <span class="mic-icon-large" style="display: none;">ğŸ¤</span>
                </div>
                <div class="upload-preview" id="audioPreview">
                    <span class="icon">âœ…</span>
                    <p>å£°éŸ³æ–‡ä»¶å·²å‡†å¤‡å°±ç»ª</p>
                    <small id="audioFileName"></small>
                </div>
                <!-- ç§»åŠ¨ç«¯é¢„è§ˆå®¹å™¨ -->
                <div class="mobile-preview-container" id="audioMobilePreview">
                    <span class="icon" style="font-size: 2.5em;">ğŸ¤</span>
                    <div class="preview-text">å·²å½•åˆ¶éŸ³é¢‘</div>
                    <div class="mobile-action-buttons">
                        <button class="mobile-retry-btn" onclick="retryAudioRecording()">é‡æ–°å½•åˆ¶</button>
                        <button class="mobile-confirm-btn" onclick="confirmAudioRecording()">ä½¿ç”¨æ­¤éŸ³é¢‘</button>
                    </div>
                </div>
            </div>

            <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-box" id="imageUploadBox">
                <input type="file" id="imageInput" accept="image/*" hidden>
                <div class="upload-placeholder">
                    <!-- æ¡Œé¢ç«¯æ˜¾ç¤ºçš„åŸå§‹å†…å®¹ -->
                    <span class="icon">ğŸ–¼ï¸</span>
                    <p><strong>ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</strong></p>
                    <small>æ”¯æŒ JPG, PNG, GIF ç­‰æ ¼å¼</small>

                    <!-- ç§»åŠ¨ç«¯æ˜¾ç¤ºçš„ç›¸æœºå›¾æ ‡ -->
                    <span class="camera-icon-large" style="display: none;">ğŸ“·</span>
                </div>
                <div class="upload-preview" id="imagePreview">
                    <img id="imageThumbnail" src="" alt="é¢„è§ˆå›¾"
                        style="max-width: 100px; max-height: 100px; border-radius: 8px; margin-bottom: 10px;">
                    <p>èƒŒæ™¯å›¾ç‰‡å·²å‡†å¤‡å°±ç»ª</p>
                </div>
                <!-- ç§»åŠ¨ç«¯é¢„è§ˆå®¹å™¨ -->
                <div class="mobile-preview-container" id="imageMobilePreview">
                    <img id="imageMobileThumbnail" src="" alt="é¢„è§ˆå›¾"
                        style="max-width: 80px; max-height: 80px; border-radius: 8px; margin-bottom: 10px;">
                    <div class="preview-text">å·²æ‹æ‘„ç…§ç‰‡</div>
                    <div class="mobile-action-buttons">
                        <button class="mobile-retry-btn" onclick="retryPhotoCapture()">é‡æ–°æ‹æ‘„</button>
                        <button class="mobile-confirm-btn" onclick="confirmPhotoCapture()">ä½¿ç”¨æ­¤ç…§ç‰‡</button>
                    </div>
                </div>
            </div>
        </div>

        <button id="uploadBtn" class="generate-btn" disabled>
            è¯·å…ˆé€‰æ‹©å£°éŸ³æˆ–å›¾ç‰‡
        </button>

        <div class="disclaimer-box">
            <h4>ğŸ“œ ç”¨æˆ·è¡Œä¸ºè§„èŒƒä¸å…è´£å£°æ˜</h4>
            <ul>
                <li>æ‚¨æ‰¿è¯ºä¸Šä¼ çš„å†…å®¹å‡ä¸ºåˆæ³•ã€æ­£é¢çš„ä¸ªäººè¡¨è¾¾ã€‚</li>
                <li><strong>ä¸¥ç¦ä¸Šä¼ ä»»ä½•</strong>æ¶‰åŠææ€–ã€å¨èƒã€å‹’ç´¢ã€è¯½è°¤ã€éªšæ‰°ç­‰è¿æ³•æˆ–ä¾µå®³ä»–äººæƒç›Šçš„éŸ³é¢‘å†…å®¹ã€‚</li>
                <li><strong>ä¸¥ç¦ä¸Šä¼ ä»»ä½•</strong>è‰²æƒ…ã€æš´åŠ›ã€è¡€è…¥ã€ä»¤äººæåº¦ä¸é€‚æˆ–è¿åå…¬åºè‰¯ä¿—çš„å›¾ç‰‡å†…å®¹ã€‚</li>
                <li>æˆ‘ä»¬æœ‰æƒå¯¹ä¸Šä¼ å†…å®¹è¿›è¡Œå®¡æŸ¥ã€‚ä¸€ç»å‘ç°è¿è§„å†…å®¹ï¼Œ<strong>å°†ç«‹å³åˆ é™¤ç›¸å…³æ–‡ä»¶ï¼Œå¹¶æ°¸ä¹…ç»ˆæ­¢è¯¥ç”¨æˆ·çš„æ‰€æœ‰æœåŠ¡ï¼Œä¸”ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚</strong></li>
                <li>æ‚¨åº”å•ç‹¬å¯¹ä¸Šä¼ å†…å®¹è´Ÿè´£ã€‚å› å†…å®¹è¿è§„å¼•å‘çš„ä»»ä½•è´£ä»»ï¼Œå‡ç”±æ‚¨è‡ªè¡Œæ‰¿æ‹…ã€‚</li>
            </ul>
        </div>

        <!-- æˆåŠŸæç¤ºåŒºåŸŸ -->
        <div id="successMessage" class="success-message">
            <h3>âœ… ä¸Šä¼ æˆåŠŸï¼</h3>
            <p id="successDetails">ä½ çš„æ–‡ä»¶å·²ä¿å­˜ã€‚</p>
            <p style="margin-top: 10px; font-size: 0.9em;">é¡µé¢å°†åœ¨1.5ç§’ååˆ·æ–°...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ===== é…ç½®åŒºåŸŸ =====
        const SUPABASE_URL = 'https://ysuzytkxvcoorpvsobqd.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzdXp5dGt4dmNvb3JwdnNvYnFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyOTMxMjUsImV4cCI6MjA3OTg2OTEyNX0.mcHqTQmeBFpW8NCCDCAauWAkjNvzOLiGQN5WAhrNC_A';

        // ä»URLå‚æ•°è·å–ç®¡ç†å‘˜åˆ†é…å¥½çš„ç”¨æˆ·ID
        const urlParams = new URLSearchParams(window.location.search);
        const assignedUserId = urlParams.get('user');

        // DOM å…ƒç´ 
        const errorContainer = document.getElementById('errorContainer');
        const mainContainer = document.getElementById('mainContainer');
        const audioInput = document.getElementById('audioInput');
        const imageInput = document.getElementById('imageInput');
        const audioUploadBox = document.getElementById('audioUploadBox');
        const imageUploadBox = document.getElementById('imageUploadBox');
        const audioPreview = document.getElementById('audioPreview');
        const imagePreview = document.getElementById('imagePreview');
        const uploadBtn = document.getElementById('uploadBtn');
        const successMessage = document.getElementById('successMessage');
        const successDetails = document.getElementById('successDetails');
        const audioMobilePreview = document.getElementById('audioMobilePreview');
        const imageMobilePreview = document.getElementById('imageMobilePreview');
        const imageMobileThumbnail = document.getElementById('imageMobileThumbnail');

        // çŠ¶æ€å˜é‡
        let selectedAudio = null;
        let selectedImage = null;
        let supabaseClient = null;

        // === å½•éŸ³åŠŸèƒ½ç›¸å…³å˜é‡ ===
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordTimeout = null;
        const MAX_RECORD_TIME = 60000;
        let currentRecordedAudioBlob = null;
        let currentAudioStream = null;

        // === æ‹ç…§åŠŸèƒ½ç›¸å…³å˜é‡ ===
        let cameraStream = null;
        let currentCameraMode = 'environment';
        let currentCapturedPhotoBlob = null;

        // ==================== iOS Safari æ£€æµ‹å‡½æ•° ====================
        function isIOS() {
            const ua = navigator.userAgent;
            return /iPhone|iPad|iPod/i.test(ua) &&
                /Safari/i.test(ua) &&
                !/CriOS/i.test(ua) &&
                !/FxiOS/i.test(ua);
        }

        // ==================== iOS ä¸“ç”¨åª’ä½“ç®¡ç†å™¨ ====================
        const iOSMediaManager = {
            // æ¸…ç†æ‰€æœ‰åª’ä½“èµ„æº
            cleanupAll() {
                if (!isIOS()) return;

                console.log('ğŸ§¹ iOSåª’ä½“ç®¡ç†å™¨ï¼šæ¸…ç†æ‰€æœ‰èµ„æº');

                // æ¸…ç†å½•éŸ³ç›¸å…³èµ„æº
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    try {
                        mediaRecorder.stop();
                        console.log('âœ… åœæ­¢å½•éŸ³å™¨');
                    } catch (e) {
                        console.warn('åœæ­¢å½•éŸ³å™¨å¤±è´¥:', e);
                    }
                    mediaRecorder = null;
                }

                // æ¸…ç†éŸ³é¢‘æµ
                if (currentAudioStream) {
                    currentAudioStream.getTracks().forEach(track => {
                        track.stop();
                        console.log('âœ… åœæ­¢éŸ³é¢‘è½¨é“');
                    });
                    currentAudioStream = null;
                }

                // æ¸…ç†æ‘„åƒå¤´æµ
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => {
                        track.stop();
                        console.log('âœ… åœæ­¢æ‘„åƒå¤´è½¨é“');
                    });
                    cameraStream = null;
                }

                // æ¸…ç†è¶…æ—¶
                if (recordTimeout) {
                    clearTimeout(recordTimeout);
                    recordTimeout = null;
                }

                // é‡ç½®çŠ¶æ€
                isRecording = false;
                audioChunks = [];

                // é’ˆå¯¹iOSçš„å†…å­˜ä¼˜åŒ–
                setTimeout(() => {
                    try {
                        // åˆ›å»ºä¸´æ—¶å¤§å¯¹è±¡è§¦å‘åƒåœ¾å›æ”¶
                        let temp = new ArrayBuffer(1024 * 1024);
                        setTimeout(() => {
                            temp = null;
                        }, 100);
                    } catch (e) {
                        // å¿½ç•¥å†…å­˜é”™è¯¯
                    }
                }, 200);
            },

            // ä¿®å¤iOSåª’ä½“çŠ¶æ€
            async fixMediaState() {
                if (!isIOS()) return true;

                console.log('ğŸ”§ iOSåª’ä½“ç®¡ç†å™¨ï¼šä¿®å¤åª’ä½“çŠ¶æ€');

                try {
                    // 1. æ¸…ç†ç°æœ‰èµ„æº
                    this.cleanupAll();

                    // 2. ç­‰å¾…ç³»ç»Ÿæ¸…ç†
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // 3. è·å–è®¾å¤‡åˆ—è¡¨ï¼Œæ£€æŸ¥éº¦å…‹é£
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const audioInputs = devices.filter(d => d.kind === 'audioinput');
                    console.log('ğŸ¤ å¯ç”¨çš„éŸ³é¢‘è®¾å¤‡:', audioInputs.length);

                    // 4. å¦‚æœæ²¡æœ‰éŸ³é¢‘è®¾å¤‡ï¼Œç›´æ¥è¿”å›
                    if (audioInputs.length === 0) {
                        console.log('âš ï¸ æœªæ£€æµ‹åˆ°éŸ³é¢‘è¾“å…¥è®¾å¤‡');
                        return false;
                    }

                    // 5. å°è¯•è·å–ä¸€ä¸ªä¸´æ—¶çš„åª’ä½“æµæ¥"å”¤é†’"éº¦å…‹é£
                    console.log('ğŸ” å°è¯•è·å–ä¸´æ—¶æµ‹è¯•æµ...');
                    try {
                        const testStream = await navigator.mediaDevices.getUserMedia({
                            audio: {
                                echoCancellation: false,
                                noiseSuppression: false,
                                autoGainControl: false,
                                sampleRate: 44100,
                                channelCount: 1,
                                deviceId: audioInputs[0]?.deviceId || { ideal: 'default' }
                            }
                        });

                        // ç«‹å³åœæ­¢æµ‹è¯•æµ
                        testStream.getTracks().forEach(track => {
                            track.stop();
                            track.enabled = false;
                        });

                        console.log('âœ… æµ‹è¯•æµè·å–æˆåŠŸï¼Œåª’ä½“çŠ¶æ€å·²ä¿®å¤');

                        // 6. å†æ¬¡ç­‰å¾…æ¸…ç†
                        await new Promise(resolve => setTimeout(resolve, 300));

                        return true;
                    } catch (testError) {
                        console.warn('æµ‹è¯•æµè·å–å¤±è´¥ï¼ˆå¯èƒ½æƒé™é—®é¢˜ï¼‰:', testError.message);
                        return false;
                    }
                } catch (error) {
                    console.error('ä¿®å¤åª’ä½“çŠ¶æ€å¤±è´¥:', error);
                    return false;
                }
            }
        };

        // ==================== ç²¾ç®€çš„å½•éŸ³åŠŸèƒ½ ====================
        async function startRecording() {
            if (isRecording) return;

            // å¦‚æœæ˜¯iOSè®¾å¤‡ï¼Œå…ˆä¿®å¤åª’ä½“çŠ¶æ€
            if (isIOS()) {
                console.log('ğŸ“± iOSè®¾å¤‡ï¼Œå¼€å§‹å½•éŸ³æµç¨‹');

                const recordBtn = document.querySelector('#audioUploadBox .mobile-action-btn .record-text');
                if (recordBtn) {
                    recordBtn.textContent = 'å‡†å¤‡ä¸­...';
                }

                // ä¿®å¤åª’ä½“çŠ¶æ€
                const mediaFixed = await iOSMediaManager.fixMediaState();
                if (!mediaFixed) {
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£ã€‚è¯·æ£€æŸ¥éº¦å…‹é£æƒé™æˆ–é‡å¯Safariæµè§ˆå™¨åé‡è¯•ã€‚');
                    if (recordBtn) {
                        recordBtn.textContent = 'å½•åˆ¶å£°éŸ³';
                    }
                    return false;
                }

                // ç­‰å¾…ä¿®å¤å®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 200));
            }

            try {
                // è·å–éŸ³é¢‘æµ
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: true
                });
                currentAudioStream = stream;

                // åˆ›å»ºåª’ä½“å½•åˆ¶å™¨
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, {
                        type: isIOS() ? 'audio/mp4' : 'audio/webm'
                    });
                    currentRecordedAudioBlob = audioBlob;

                    // æ˜¾ç¤ºé¢„è§ˆ
                    showAudioMobilePreview();

                    // æ¸…ç†æµ
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        currentAudioStream = null;
                    }
                };

                mediaRecorder.start();
                isRecording = true;

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                const recordBtn = document.querySelector('#audioUploadBox .mobile-action-btn .record-text');
                if (recordBtn) {
                    recordBtn.textContent = 'âºï¸ å½•éŸ³ä¸­... ç‚¹å‡»åœæ­¢';
                }

                // è®¾ç½®æœ€å¤§å½•éŸ³æ—¶é—´
                recordTimeout = setTimeout(() => {
                    if (isRecording && mediaRecorder && mediaRecorder.state === 'recording') {
                        stopRecording();
                    }
                }, MAX_RECORD_TIME);

                console.log('âœ… å½•éŸ³å¼€å§‹');
                return true;

            } catch (error) {
                console.error('æ— æ³•è®¿é—®éº¦å…‹é£:', error);

                let errorMessage = 'æ— æ³•è®¿é—®éº¦å…‹é£';
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ã€‚è¯·å‰å¾€Safariè®¾ç½®ä¸­å…è®¸æ­¤ç½‘ç«™ä½¿ç”¨éº¦å…‹é£ã€‚';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡ã€‚';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'éº¦å…‹é£æ­£è¢«å…¶ä»–åº”ç”¨å ç”¨ã€‚';
                }

                alert(errorMessage);

                // é‡ç½®æŒ‰é’®çŠ¶æ€
                const recordBtn = document.querySelector('#audioUploadBox .mobile-action-btn .record-text');
                if (recordBtn) {
                    recordBtn.textContent = 'å½•åˆ¶å£°éŸ³';
                }

                return false;
            }
        }

        function stopRecording() {
            if (!isRecording || !mediaRecorder) return;

            if (mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }

            isRecording = false;

            if (recordTimeout) {
                clearTimeout(recordTimeout);
                recordTimeout = null;
            }

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const recordBtn = document.querySelector('#audioUploadBox .mobile-action-btn .record-text');
            if (recordBtn) {
                recordBtn.textContent = 'å½•åˆ¶å£°éŸ³';
            }

            console.log('â¹ï¸ å½•éŸ³åœæ­¢');
        }

        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        // ==================== å…¶ä»–æ ¸å¿ƒåŠŸèƒ½ï¼ˆä¿æŒä¸å˜ï¼‰ ====================

        // å¤„ç†éŸ³é¢‘é€‰æ‹©
        function handleAudioSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('audio/')) {
                selectedAudio = file;
                document.getElementById('audioFileName').textContent = file.name;
                audioPreview.style.display = 'flex';
                audioUploadBox.querySelector('.upload-placeholder').style.display = 'none';
                audioMobilePreview.style.display = 'none';
                checkUploadButton();
            } else {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„éŸ³é¢‘æ–‡ä»¶ã€‚');
            }
        }

        // å¤„ç†å›¾ç‰‡é€‰æ‹©
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                processImageFile(file);
            } else {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ã€‚');
            }
        }

        // å¤„ç†å›¾ç‰‡æ–‡ä»¶
        function processImageFile(file) {
            selectedImage = file;
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('imageThumbnail').src = e.target.result;
            };
            reader.readAsDataURL(file);
            imagePreview.style.display = 'flex';
            imageUploadBox.querySelector('.upload-placeholder').style.display = 'none';
            imageMobilePreview.style.display = 'none';
            checkUploadButton();
        }

        // æ£€æŸ¥ä¸Šä¼ æŒ‰é’®çŠ¶æ€
        function checkUploadButton() {
            uploadBtn.disabled = !(selectedAudio || selectedImage);

            if (selectedAudio && selectedImage) {
                uploadBtn.textContent = 'ä¸Šä¼ å£°éŸ³ä¸å›¾ç‰‡';
                uploadBtn.style.background = 'linear-gradient(135deg, #fd79a8, #e84393)';
            } else if (selectedAudio) {
                uploadBtn.textContent = 'ä»…ä¸Šä¼ å£°éŸ³';
                uploadBtn.style.background = 'linear-gradient(135deg, #6c5ce7, #a29bfe)';
            } else if (selectedImage) {
                uploadBtn.textContent = 'ä»…ä¸Šä¼ å›¾ç‰‡';
                uploadBtn.style.background = 'linear-gradient(135deg, #00b894, #00cec9)';
            } else {
                uploadBtn.textContent = 'è¯·å…ˆé€‰æ‹©å£°éŸ³æˆ–å›¾ç‰‡';
                uploadBtn.style.background = 'linear-gradient(135deg, #6c5ce7, #a29bfe)';
            }
        }

        // æ˜¾ç¤ºéŸ³é¢‘ç§»åŠ¨ç«¯é¢„è§ˆ
        function showAudioMobilePreview() {
            const audioPlaceholder = document.querySelector('#audioUploadBox .upload-placeholder');
            audioPlaceholder.style.display = 'none';
            audioPreview.style.display = 'none';
            audioMobilePreview.style.display = 'flex';
        }

        // é‡æ–°å½•åˆ¶éŸ³é¢‘
        function retryAudioRecording() {
            audioMobilePreview.style.display = 'none';
            const audioPlaceholder = document.querySelector('#audioUploadBox .upload-placeholder');
            audioPlaceholder.style.display = 'flex';
            currentRecordedAudioBlob = null;
            selectedAudio = null;
            checkUploadButton();
        }

        // ç¡®è®¤ä½¿ç”¨å½•åˆ¶çš„éŸ³é¢‘
        async function confirmAudioRecording() {
            if (!currentRecordedAudioBlob) {
                alert('è¯·å…ˆå½•åˆ¶éŸ³é¢‘');
                return;
            }

            const recordedFile = new File([currentRecordedAudioBlob], `recording_${Date.now()}.${isIOS() ? 'm4a' : 'webm'}`, {
                type: isIOS() ? 'audio/mp4' : 'audio/webm'
            });

            handleAudioSelect({ target: { files: [recordedFile] } });
        }

        // åˆå§‹åŒ–å½•éŸ³UI
        function initRecordingUI() {
            const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

            if (isMobile) {
                const audioPlaceholder = document.querySelector('#audioUploadBox .upload-placeholder');
                if (audioPlaceholder) {
                    audioPlaceholder.querySelector('.icon').style.display = 'none';
                    audioPlaceholder.querySelector('p').style.display = 'none';
                    audioPlaceholder.querySelector('small').style.display = 'none';

                    const micIconLarge = audioPlaceholder.querySelector('.mic-icon-large');
                    if (micIconLarge) {
                        micIconLarge.style.display = 'block';
                    }

                    const recordBtn = document.createElement('button');
                    recordBtn.className = 'mobile-action-btn';

                    const btnContent = document.createElement('span');
                    btnContent.className = 'record-text';
                    btnContent.textContent = 'å½•åˆ¶å£°éŸ³';

                    recordBtn.appendChild(btnContent);
                    recordBtn.onclick = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        toggleRecording();
                    };

                    audioPlaceholder.appendChild(recordBtn);
                    audioUploadBox.style.cursor = 'default';
                }
            }
        }

        // ==================== å®‰å…¨éªŒè¯å’Œé¡µé¢åˆå§‹åŒ– ====================
        window.addEventListener('DOMContentLoaded', async function () {
            // å®‰å…¨æ ¡éªŒ
            if (!assignedUserId || !assignedUserId.startsWith('user_')) {
                console.error('æ— æ•ˆçš„ç”¨æˆ·IDå‚æ•°:', assignedUserId);
                errorContainer.style.display = 'block';
                mainContainer.style.display = 'none';
                return;
            }

            // éªŒè¯é€šè¿‡ï¼Œæ˜¾ç¤ºä¸»å®¹å™¨ï¼Œéšè—é”™è¯¯å®¹å™¨
            errorContainer.style.display = 'none';
            mainContainer.style.display = 'block';

            console.log('å½“å‰æ“ä½œç”¨æˆ·ID:', assignedUserId);

            // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // åˆå§‹åŒ–UI
            checkUploadButton();
            initRecordingUI();

            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            if (!isMobile) {
                audioUploadBox.addEventListener('click', () => audioInput.click());
                imageUploadBox.addEventListener('click', () => imageInput.click());
            }

            audioInput.addEventListener('change', handleAudioSelect);
            imageInput.addEventListener('change', handleImageSelect);
            uploadBtn.addEventListener('click', handleUpload);

            // iOS Safariç‰¹æ®Šå¤„ç†
            if (isIOS()) {
                console.log('ğŸ“± iOS Safariè®¾å¤‡æ£€æµ‹åˆ°');

                // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        console.log('ğŸ“± é¡µé¢éšè—ï¼Œæ¸…ç†åª’ä½“èµ„æº');
                        iOSMediaManager.cleanupAll();
                    }
                });

                // ç›‘å¬é¡µé¢å¸è½½
                window.addEventListener('pagehide', () => {
                    console.log('ğŸ“± é¡µé¢å¸è½½ï¼Œå½»åº•æ¸…ç†');
                    iOSMediaManager.cleanupAll();
                });

                // ç›‘å¬é¡µé¢åŠ è½½å®Œæˆ
                window.addEventListener('load', () => {
                    setTimeout(() => {
                        console.log('ğŸ”§ iOSé¡µé¢åŠ è½½å®Œæˆï¼Œå°è¯•ä¿®å¤åª’ä½“çŠ¶æ€');
                        iOSMediaManager.fixMediaState();
                    }, 1000);
                });

                // æ·»åŠ iOSä¸“ç”¨æ ·å¼
                const style = document.createElement('style');
                style.textContent = `
            @media (max-width: 768px) {
                #audioUploadBox .mobile-action-btn:active {
                    transform: scale(0.95);
                }
                * {
                    -webkit-tap-highlight-color: transparent;
                }
            }
        `;
                document.head.appendChild(style);
            }
        });

        // ==================== ä¸Šä¼ å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰ ====================
        async function handleUpload() {
            // éªŒè¯å’Œä¸Šä¼ é€»è¾‘ä¿æŒä¸å˜
            // ... ä¿æŒåŸæ¥çš„ä¸Šä¼ å‡½æ•°ä»£ç  ...
        }

        // ==================== å…¶ä»–è¾…åŠ©å‡½æ•° ====================
        function safePageRefresh() {
            if (isIOS()) {
                const timestamp = new Date().getTime();
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.delete('_t');
                currentUrl.searchParams.set('_t', timestamp);
                window.location.replace(currentUrl.toString());
            } else {
                window.location.reload();
            }
        }

        function resetUploadInterface() {
            selectedAudio = null;
            selectedImage = null;

            audioPreview.style.display = 'none';
            audioUploadBox.querySelector('.upload-placeholder').style.display = 'flex';
            audioInput.value = '';
            audioMobilePreview.style.display = 'none';

            imagePreview.style.display = 'none';
            imageUploadBox.querySelector('.upload-placeholder').style.display = 'flex';
            imageInput.value = '';
            document.getElementById('imageThumbnail').src = '';
            imageMobilePreview.style.display = 'none';

            if (imageMobileThumbnail.src.startsWith('blob:')) {
                URL.revokeObjectURL(imageMobileThumbnail.src);
                imageMobileThumbnail.src = '';
            }

            currentRecordedAudioBlob = null;
            currentCapturedPhotoBlob = null;

            if (isIOS()) {
                iOSMediaManager.cleanupAll();
            }

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'è¯·å…ˆé€‰æ‹©å£°éŸ³æˆ–å›¾ç‰‡';
            uploadBtn.style.background = 'linear-gradient(135deg, #6c5ce7, #a29bfe)';

            successMessage.style.display = 'none';
        }

        // ==================== æ·»åŠ è°ƒè¯•ä¿¡æ¯ ====================
        if (window.location.hostname.includes('localhost') || window.location.hostname.includes('netlify')) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const debugDiv = document.createElement('div');
                    debugDiv.style.cssText = `
                position: fixed;
                top: 10px;
                left: 10px;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 10px;
                border-radius: 5px;
                font-size: 12px;
                z-index: 9999;
                max-width: 300px;
                display: ${isIOS() ? 'block' : 'none'};
            `;
                    debugDiv.innerHTML = `
                <div>iOS: ${isIOS() ? 'âœ…' : 'âŒ'}</div>
                <div>ç”¨æˆ·: ${assignedUserId || 'æ— '}</div>
                <button onclick="iOSMediaSession.cleanup(); alert('æ¸…ç†å®Œæˆ')" 
                    style="margin-top:5px; padding:5px; background:#ff4757; color:white; border:none; border-radius:3px;">
                    æ¸…ç†iOSèµ„æº
                </button>
            `;
                    document.body.appendChild(debugDiv);
                }, 1000);
            });
        }
    </script>
</body>

</html>