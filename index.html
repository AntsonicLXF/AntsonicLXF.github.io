<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ä¸Šä¼ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .error-container {
            display: none;
            text-align: center;
        }

        .error-content {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 60px 40px;
            max-width: 500px;
            width: 100%;
        }

        .error-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .error-text {
            color: #2d3436;
            font-size: 1.2em;
            line-height: 1.5;
        }

        .main-container {
            display: none;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #2d3436;
            margin-bottom: 10px;
            font-size: 1.8em;
        }

        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-section {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .upload-box {
            width: 200px;
            height: 200px;
            border: 3px dashed #6c5ce7;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            position: relative;
        }

        .upload-box:hover {
            background: #edf2f7;
            transform: translateY(-3px);
            border-color: #a29bfe;
        }

        .upload-box .icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .upload-box p {
            font-weight: bold;
            color: #2d3436;
            margin: 5px 0;
        }

        .upload-box small {
            color: #636e72;
            font-size: 0.85em;
        }

        /* ç§»åŠ¨ç«¯æŒ‰é’® - é‡æ–°è®¾è®¡ */
        .mobile-action-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 1em;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3);
        }

        .mobile-action-btn.photo {
            background: linear-gradient(135deg, #1e90ff, #3742fa);
        }

        /* ä¸Šä¼ æŒ‰é’® */
        .generate-btn {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px auto;
            display: block;
            width: 250px;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
        }

        .generate-btn:disabled {
            background: #b2bec3;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* å…è´£å£°æ˜åŒºåŸŸ */
        .disclaimer-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            text-align: left;
            font-size: 0.9em;
            line-height: 1.6;
            color: #6c757d;
        }

        .disclaimer-box h4 {
            color: #dc3545;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .disclaimer-box ul {
            padding-left: 20px;
        }

        .disclaimer-box li {
            margin-bottom: 8px;
        }

        /* æˆåŠŸæç¤º */
        .success-message {
            background: #d4edda;
            color: #155724;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #c3e6cb;
            display: none;
        }

        /* é¢„è§ˆåŒºåŸŸ */
        .upload-preview {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
        }

        /* æ‘„åƒå¤´æ¨¡æ€æ¡† */
        .camera-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .camera-modal video {
            width: 100%;
            max-width: 500px;
            background: #000;
            border-radius: 10px 10px 0 0;
        }

        .camera-controls {
            width: 100%;
            max-width: 500px;
            background: #333;
            padding: 20px;
            border-radius: 0 0 10px 10px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .camera-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .capture-btn {
            background: #ff4757;
            color: white;
            font-weight: bold;
        }

        .cancel-btn {
            background: #747d8c;
            color: white;
        }

        .switch-camera-btn {
            background: #3742fa;
            color: white;
        }

        /* ç§»åŠ¨ç«¯é¢„è§ˆå®¹å™¨ */
        .mobile-preview-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            padding: 10px;
            text-align: center;
        }

        .mobile-preview-container img {
            max-width: 80px;
            max-height: 80px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .mobile-preview-container .preview-text {
            font-size: 0.9em;
            color: #2d3436;
            margin-bottom: 10px;
        }

        /* ç§»åŠ¨ç«¯æ“ä½œæŒ‰é’®å®¹å™¨ */
        .mobile-action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .mobile-action-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            min-width: 80px;
        }

        .mobile-confirm-btn {
            background: #00b894;
            color: white;
        }

        .mobile-retry-btn {
            background: #ff9f43;
            color: white;
        }

        /* ç§»åŠ¨ç«¯é€‚é… - ä¿®æ”¹éŸ³é¢‘å’Œå›¾ç‰‡ä¸Šä¼ åŒºåŸŸ */
        @media (max-width: 768px) {
            .main-container {
                padding: 20px;
            }

            .upload-section {
                flex-direction: column;
                align-items: center;
            }

            .upload-box {
                width: 100%;
                max-width: 250px;
                height: 180px;
            }

            .generate-btn {
                width: 100%;
                max-width: 250px;
            }

            .camera-modal video {
                max-width: 100%;
            }

            .camera-controls {
                max-width: 100%;
                flex-direction: column;
                gap: 10px;
            }

            .camera-btn {
                width: 100%;
            }

            /* ç§»åŠ¨ç«¯éŸ³é¢‘ä¸Šä¼ åŒºåŸŸç‰¹æ®Šæ ·å¼ */
            #audioUploadBox {
                cursor: default;
            }

            #audioUploadBox .upload-placeholder {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                width: 100%;
            }

            /* éšè—éŸ³é¢‘ä¸Šä¼ åŒºåŸŸåŸæ¥çš„å›¾æ ‡å’Œæ–‡å­— */
            #audioUploadBox .upload-placeholder .icon,
            #audioUploadBox .upload-placeholder p:not(.record-text),
            #audioUploadBox .upload-placeholder small {
                display: none !important;
            }

            /* æ”¾å¤§éº¦å…‹é£å›¾æ ‡å¹¶è°ƒæ•´ä½ç½® */
            #audioUploadBox .mic-icon-large {
                font-size: 3em !important;
                margin-bottom: 15px;
                display: block !important;
            }

            /* å½•åˆ¶æŒ‰é’®æ ·å¼ - è¿™æ˜¯çº¢è‰²å½•éŸ³æŒ‰é’® */
            #audioUploadBox .mobile-action-btn {
                margin-top: 0;
                padding: 10px 20px;
                font-size: 1em;
                font-weight: bold;
                border-radius: 25px;
                width: 80%;
                max-width: 180px;
                justify-content: center;
                background: linear-gradient(135deg, #ff4757, #ff3838);
                box-shadow: 0 4px 12px rgba(255, 71, 87, 0.4);
            }

            /* å½•åˆ¶æŒ‰é’®æ–‡å­—æ ·å¼ */
            #audioUploadBox .record-text {
                color: white;
                font-size: 1em;
                font-weight: bold;
                margin: 0;
            }

            /* ç§»åŠ¨ç«¯å›¾ç‰‡ä¸Šä¼ åŒºåŸŸç‰¹æ®Šæ ·å¼ */
            #imageUploadBox {
                cursor: default;
            }

            #imageUploadBox .upload-placeholder {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                width: 100%;
            }

            /* éšè—å›¾ç‰‡ä¸Šä¼ åŒºåŸŸåŸæ¥çš„å›¾æ ‡å’Œæ–‡å­— */
            #imageUploadBox .upload-placeholder .icon,
            #imageUploadBox .upload-placeholder p:not(.camera-text),
            #imageUploadBox .upload-placeholder small {
                display: none !important;
            }

            /* æ”¾å¤§ç›¸æœºå›¾æ ‡å¹¶è°ƒæ•´ä½ç½® */
            #imageUploadBox .camera-icon-large {
                font-size: 3em !important;
                margin-bottom: 15px;
                display: block !important;
            }

            /* å›¾ç‰‡ä¸Šä¼ åŒºåŸŸæ‹ç…§æŒ‰é’® - ä¸å½•éŸ³æŒ‰é’®å¤§å°ä¸€è‡´ */
            #imageUploadBox .mobile-action-btn.photo {
                margin-top: 0;
                padding: 10px 20px;
                font-size: 1em;
                font-weight: bold;
                border-radius: 25px;
                width: 80%;
                max-width: 180px;
                justify-content: center;
                box-shadow: 0 4px 12px rgba(30, 144, 255, 0.4);
                background: linear-gradient(135deg, #1e90ff, #3742fa);
            }

            /* æ‹ç…§æŒ‰é’®æ–‡å­—æ ·å¼ */
            #imageUploadBox .camera-text {
                color: white;
                font-size: 1em;
                font-weight: bold;
                margin: 0;
            }
        }

        /* æ¡Œé¢ç«¯ä¿æŒåŸæœ‰æ ·å¼ï¼Œä½†éšè—ç§»åŠ¨ç«¯æŒ‰é’® */
        @media (min-width: 769px) {
            .mobile-action-btn {
                display: none;
            }

            .mobile-preview-container {
                display: none !important;
            }

            .mobile-action-buttons {
                display: none !important;
            }

            /* æ¡Œé¢ç«¯æ¢å¤éŸ³é¢‘ä¸Šä¼ åŒºåŸŸåŸå§‹æ ·å¼ */
            #audioUploadBox .upload-placeholder {
                display: flex !important;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            #audioUploadBox .upload-placeholder .icon,
            #audioUploadBox .upload-placeholder p,
            #audioUploadBox .upload-placeholder small {
                display: block !important;
            }

            #audioUploadBox .mic-icon-large {
                display: none !important;
            }

            /* æ¡Œé¢ç«¯æ¢å¤å›¾ç‰‡ä¸Šä¼ åŒºåŸŸåŸå§‹æ ·å¼ */
            #imageUploadBox .upload-placeholder {
                display: flex !important;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            #imageUploadBox .upload-placeholder .icon,
            #imageUploadBox .upload-placeholder p,
            #imageUploadBox .upload-placeholder small {
                display: block !important;
            }

            #imageUploadBox .camera-icon-large {
                display: none !important;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>
</head>

<body>
    <!-- é”™è¯¯å®¹å™¨ï¼ˆéªŒè¯å¤±è´¥æ—¶æ˜¾ç¤ºï¼‰ -->
    <div class="error-container" id="errorContainer">
        <div class="error-content">
            <div class="error-icon">âš ï¸</div>
            <div class="error-text">
                <p>æ— æ•ˆçš„è®¿é—®é“¾æ¥</p>
                <p style="margin-top: 10px;">è¯·é€šè¿‡æ­£ç¡®çš„äºŒç»´ç è¿›å…¥æœ¬é¡µé¢</p>
            </div>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ï¼ˆéªŒè¯æˆåŠŸæ—¶æ˜¾ç¤ºï¼‰ -->
    <div class="main-container" id="mainContainer">
        <h1>â¬†ï¸ è¯·ä¸Šä¼ ä½ çš„å£°éŸ³å’Œå›¾ç‰‡</h1>

        <div class="upload-section" id="uploadSection">
            <!-- éŸ³é¢‘ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-box" id="audioUploadBox">
                <input type="file" id="audioInput" accept="audio/*" hidden>
                <div class="upload-placeholder">
                    <!-- æ¡Œé¢ç«¯æ˜¾ç¤ºçš„åŸå§‹å†…å®¹ -->
                    <span class="icon">ğŸµ</span>
                    <p><strong>ç‚¹å‡»ä¸Šä¼ å£°éŸ³</strong></p>
                    <small>æ”¯æŒ MP3, WAV, M4A ç­‰æ ¼å¼</small>

                    <!-- ç§»åŠ¨ç«¯æ˜¾ç¤ºçš„éº¦å…‹é£å›¾æ ‡ -->
                    <span class="mic-icon-large" style="display: none;">ğŸ¤</span>
                </div>
                <div class="upload-preview" id="audioPreview">
                    <span class="icon">âœ…</span>
                    <p>å£°éŸ³æ–‡ä»¶å·²å‡†å¤‡å°±ç»ª</p>
                    <small id="audioFileName"></small>
                </div>
                <!-- ç§»åŠ¨ç«¯é¢„è§ˆå®¹å™¨ -->
                <div class="mobile-preview-container" id="audioMobilePreview">
                    <span class="icon" style="font-size: 2.5em;">ğŸ¤</span>
                    <div class="preview-text">å·²å½•åˆ¶éŸ³é¢‘</div>
                    <div class="mobile-action-buttons">
                        <button class="mobile-retry-btn" onclick="retryAudioRecording()">é‡æ–°å½•åˆ¶</button>
                        <button class="mobile-confirm-btn" onclick="confirmAudioRecording()">ä½¿ç”¨æ­¤éŸ³é¢‘</button>
                    </div>
                </div>
            </div>

            <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-box" id="imageUploadBox">
                <input type="file" id="imageInput" accept="image/*" hidden>
                <div class="upload-placeholder">
                    <!-- æ¡Œé¢ç«¯æ˜¾ç¤ºçš„åŸå§‹å†…å®¹ -->
                    <span class="icon">ğŸ–¼ï¸</span>
                    <p><strong>ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</strong></p>
                    <small>æ”¯æŒ JPG, PNG, GIF ç­‰æ ¼å¼</small>

                    <!-- ç§»åŠ¨ç«¯æ˜¾ç¤ºçš„ç›¸æœºå›¾æ ‡ -->
                    <span class="camera-icon-large" style="display: none;">ğŸ“·</span>
                </div>
                <div class="upload-preview" id="imagePreview">
                    <img id="imageThumbnail" src="" alt="é¢„è§ˆå›¾"
                        style="max-width: 100px; max-height: 100px; border-radius: 8px; margin-bottom: 10px;">
                    <p>èƒŒæ™¯å›¾ç‰‡å·²å‡†å¤‡å°±ç»ª</p>
                </div>
                <!-- ç§»åŠ¨ç«¯é¢„è§ˆå®¹å™¨ -->
                <div class="mobile-preview-container" id="imageMobilePreview">
                    <img id="imageMobileThumbnail" src="" alt="é¢„è§ˆå›¾"
                        style="max-width: 80px; max-height: 80px; border-radius: 8px; margin-bottom: 10px;">
                    <div class="preview-text">å·²æ‹æ‘„ç…§ç‰‡</div>
                    <div class="mobile-action-buttons">
                        <button class="mobile-retry-btn" onclick="retryPhotoCapture()">é‡æ–°æ‹æ‘„</button>
                        <button class="mobile-confirm-btn" onclick="confirmPhotoCapture()">ä½¿ç”¨æ­¤ç…§ç‰‡</button>
                    </div>
                </div>
            </div>
        </div>

        <button id="uploadBtn" class="generate-btn" disabled>
            è¯·å…ˆé€‰æ‹©å£°éŸ³æˆ–å›¾ç‰‡
        </button>

        <div class="disclaimer-box">
            <h4>ğŸ“œ ç”¨æˆ·è¡Œä¸ºè§„èŒƒä¸å…è´£å£°æ˜</h4>
            <ul>
                <li>æ‚¨æ‰¿è¯ºä¸Šä¼ çš„å†…å®¹å‡ä¸ºåˆæ³•ã€æ­£é¢çš„ä¸ªäººè¡¨è¾¾ã€‚</li>
                <li><strong>ä¸¥ç¦ä¸Šä¼ ä»»ä½•</strong>æ¶‰åŠææ€–ã€å¨èƒã€å‹’ç´¢ã€è¯½è°¤ã€éªšæ‰°ç­‰è¿æ³•æˆ–ä¾µå®³ä»–äººæƒç›Šçš„éŸ³é¢‘å†…å®¹ã€‚</li>
                <li><strong>ä¸¥ç¦ä¸Šä¼ ä»»ä½•</strong>è‰²æƒ…ã€æš´åŠ›ã€è¡€è…¥ã€ä»¤äººæåº¦ä¸é€‚æˆ–è¿åå…¬åºè‰¯ä¿—çš„å›¾ç‰‡å†…å®¹ã€‚</li>
                <li>æˆ‘ä»¬æœ‰æƒå¯¹ä¸Šä¼ å†…å®¹è¿›è¡Œå®¡æŸ¥ã€‚ä¸€ç»å‘ç°è¿è§„å†…å®¹ï¼Œ<strong>å°†ç«‹å³åˆ é™¤ç›¸å…³æ–‡ä»¶ï¼Œå¹¶æ°¸ä¹…ç»ˆæ­¢è¯¥ç”¨æˆ·çš„æ‰€æœ‰æœåŠ¡ï¼Œä¸”ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚</strong></li>
                <li>æ‚¨åº”å•ç‹¬å¯¹ä¸Šä¼ å†…å®¹è´Ÿè´£ã€‚å› å†…å®¹è¿è§„å¼•å‘çš„ä»»ä½•è´£ä»»ï¼Œå‡ç”±æ‚¨è‡ªè¡Œæ‰¿æ‹…ã€‚</li>
            </ul>
        </div>

        <!-- æˆåŠŸæç¤ºåŒºåŸŸ -->
        <div id="successMessage" class="success-message">
            <h3>âœ… ä¸Šä¼ æˆåŠŸï¼</h3>
            <p id="successDetails">ä½ çš„æ–‡ä»¶å·²ä¿å­˜ã€‚</p>
            <p style="margin-top: 10px; font-size: 0.9em;">é¡µé¢å°†åœ¨1.5ç§’ååˆ·æ–°...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ===== é…ç½®åŒºåŸŸ =====
        const SUPABASE_URL = 'https://ysuzytkxvcoorpvsobqd.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzdXp5dGt4dmNvb3JwdnNvYnFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyOTMxMjUsImV4cCI6MjA3OTg2OTEyNX0.mcHqTQmeBFpW8NCCDCAauWAkjNvzOLiGQN5WAhrNC_A';

        // ä»URLå‚æ•°è·å–ç®¡ç†å‘˜åˆ†é…å¥½çš„ç”¨æˆ·ID
        const urlParams = new URLSearchParams(window.location.search);
        const assignedUserId = urlParams.get('user');

        // DOM å…ƒç´ 
        const errorContainer = document.getElementById('errorContainer');
        const mainContainer = document.getElementById('mainContainer');
        const audioInput = document.getElementById('audioInput');
        const imageInput = document.getElementById('imageInput');
        const audioUploadBox = document.getElementById('audioUploadBox');
        const imageUploadBox = document.getElementById('imageUploadBox');
        const audioPreview = document.getElementById('audioPreview');
        const imagePreview = document.getElementById('imagePreview');
        const uploadBtn = document.getElementById('uploadBtn');
        const successMessage = document.getElementById('successMessage');
        const successDetails = document.getElementById('successDetails');
        const audioMobilePreview = document.getElementById('audioMobilePreview');
        const imageMobilePreview = document.getElementById('imageMobilePreview');
        const imageMobileThumbnail = document.getElementById('imageMobileThumbnail');

        // çŠ¶æ€å˜é‡
        let selectedAudio = null;
        let selectedImage = null;
        let supabaseClient = null;

        // === å½•éŸ³åŠŸèƒ½ç›¸å…³å˜é‡ ===
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordTimeout = null;
        const MAX_RECORD_TIME = 60000;
        let currentRecordedAudioBlob = null;
        let currentAudioStream = null;

        // === æ‹ç…§åŠŸèƒ½ç›¸å…³å˜é‡ ===
        let cameraStream = null;
        let currentCameraMode = 'environment';
        let currentCapturedPhotoBlob = null;

        // ==================== iOS Safari æ£€æµ‹å‡½æ•° ====================
        function isIOS() {
            const ua = navigator.userAgent;
            return /iPhone|iPad|iPod/i.test(ua) &&
                /Safari/i.test(ua) &&
                !/CriOS/i.test(ua) &&
                !/FxiOS/i.test(ua);
        }

        // ==================== iOS åª’ä½“ä¼šè¯ç®¡ç†å™¨ ====================
        const iOSMediaSession = {
            isActive: false,
            hasPermission: false,
            isPageActive: true,
            cleanupPromise: null,

            init() {
                if (!isIOS()) return;

                console.log('ğŸ“± åˆå§‹åŒ–iOSåª’ä½“ä¼šè¯ç®¡ç†å™¨');

                // é¡µé¢æ˜¾ç¤ºæ—¶é‡ç½®çŠ¶æ€
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        this.isPageActive = true;
                        console.log('ğŸ“± é¡µé¢æ˜¾ç¤ºï¼Œé‡ç½®çŠ¶æ€');
                        // é‡ç½®å½•éŸ³æŒ‰é’®çŠ¶æ€
                        const recordBtn = document.querySelector('#audioUploadBox .mobile-action-btn .record-text');
                        if (recordBtn && recordBtn.textContent.includes('å½•éŸ³ä¸­')) {
                            recordBtn.textContent = 'å½•åˆ¶å£°éŸ³';
                            isRecording = false;
                        }
                    }
                });

                // é¡µé¢å¸è½½æ—¶æ·±åº¦æ¸…ç†
                window.addEventListener('pagehide', () => {
                    console.log('ğŸ“± é¡µé¢å¸è½½ï¼Œæ‰§è¡Œæ·±åº¦æ¸…ç†');
                    this.deepCleanup();
                });

                window.addEventListener('beforeunload', () => {
                    console.log('ğŸ“± é¡µé¢å³å°†å¸è½½ï¼Œæ‰§è¡Œæ¸…ç†');
                    this.deepCleanup();
                });
            },

            async deepCleanup() {
                if (!isIOS()) return;
                
                console.log('ğŸ§¹ iOSæ·±åº¦æ¸…ç† - å¼€å§‹');
                
                // ç­‰å¾…ä»»ä½•è¿›è¡Œä¸­çš„æ¸…ç†å®Œæˆ
                if (this.cleanupPromise) {
                    await this.cleanupPromise;
                }
                
                this.cleanupPromise = new Promise(async (resolve) => {
                    // æ¸…ç†åª’ä½“å½•åˆ¶å™¨
                    if (mediaRecorder) {
                        try {
                            if (mediaRecorder.state === 'recording') {
                                mediaRecorder.stop();
                                console.log('âœ… åœæ­¢åª’ä½“å½•åˆ¶å™¨');
                            }
                            // ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
                            mediaRecorder.ondataavailable = null;
                            mediaRecorder.onstop = null;
                            mediaRecorder.onerror = null;
                        } catch (e) {
                            console.warn('åœæ­¢åª’ä½“å½•åˆ¶å™¨å¤±è´¥:', e);
                        }
                        mediaRecorder = null;
                    }

                    // æ¸…ç†iOSå½•éŸ³å™¨
                    if (iOSRecorder) {
                        iOSRecorder.cleanup();
                    }

                    // å½»åº•æ¸…ç†éŸ³é¢‘æµ
                    if (currentAudioStream) {
                        try {
                            const tracks = currentAudioStream.getTracks();
                            tracks.forEach(track => {
                                track.stop();
                                track.enabled = false;
                                console.log('âœ… åœæ­¢éŸ³é¢‘è½¨é“:', track.kind, track.readyState);
                            });
                            currentAudioStream = null;
                        } catch (e) {
                            console.warn('æ¸…ç†éŸ³é¢‘æµå¤±è´¥:', e);
                        }
                    }

                    // æ¸…ç†æ‘„åƒå¤´æµ
                    if (cameraStream) {
                        try {
                            const tracks = cameraStream.getTracks();
                            tracks.forEach(track => {
                                track.stop();
                                track.enabled = false;
                                console.log('âœ… åœæ­¢æ‘„åƒå¤´è½¨é“:', track.kind, track.readyState);
                            });
                            cameraStream = null;
                        } catch (e) {
                            console.warn('æ¸…ç†æ‘„åƒå¤´æµå¤±è´¥:', e);
                        }
                    }

                    // æ¸…ç†è¶…æ—¶
                    if (recordTimeout) {
                        clearTimeout(recordTimeout);
                        recordTimeout = null;
                    }

                    // é‡ç½®çŠ¶æ€
                    isRecording = false;
                    audioChunks = [];
                    currentRecordedAudioBlob = null;
                    this.isActive = false;

                    // å¼ºåˆ¶è¯·æ±‚ä¸€æ¬¡ç©ºåª’ä½“ï¼Œç¡®ä¿æƒé™é‡Šæ”¾
                    try {
                        await navigator.mediaDevices.getUserMedia({ audio: true, video: true })
                            .then(stream => {
                                stream.getTracks().forEach(track => {
                                    track.stop();
                                    console.log('ğŸ”„ å¼ºåˆ¶å…³é—­è®¾å¤‡è½¨é“:', track.kind);
                                });
                            })
                            .catch(e => console.log('è®¾å¤‡æ¸…ç†å®Œæˆ:', e.message));
                    } catch (e) {
                        console.log('è®¾å¤‡æ¸…ç†è·³è¿‡:', e.message);
                    }

                    console.log('ğŸ§¹ iOSæ·±åº¦æ¸…ç† - å®Œæˆ');
                    this.cleanupPromise = null;
                    resolve();
                });
                
                return this.cleanupPromise;
            },

            cleanup() {
                if (!isIOS()) return;
                
                console.log('ğŸ§¹ iOSå¸¸è§„æ¸…ç†');
                
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    try {
                        mediaRecorder.stop();
                        console.log('âœ… åœæ­¢åª’ä½“å½•åˆ¶å™¨');
                    } catch (e) {
                        console.warn('åœæ­¢åª’ä½“å½•åˆ¶å™¨å¤±è´¥:', e);
                    }
                    mediaRecorder = null;
                }

                if (iOSRecorder && iOSRecorder.isRecording) {
                    iOSRecorder.stop();
                }

                if (currentAudioStream) {
                    currentAudioStream.getTracks().forEach(track => {
                        try {
                            track.stop();
                            console.log('âœ… åœæ­¢éŸ³é¢‘è½¨é“');
                        } catch (e) {
                            console.warn('åœæ­¢éŸ³é¢‘è½¨é“å¤±è´¥:', e);
                        }
                    });
                    currentAudioStream = null;
                }

                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => {
                        try {
                            track.stop();
                            console.log('âœ… åœæ­¢æ‘„åƒå¤´è½¨é“');
                        } catch (e) {
                            console.warn('åœæ­¢æ‘„åƒå¤´è½¨é“å¤±è´¥:', e);
                        }
                    });
                    cameraStream = null;
                }

                if (recordTimeout) {
                    clearTimeout(recordTimeout);
                    recordTimeout = null;
                }

                isRecording = false;
                audioChunks = [];
                this.isActive = false;
            },

            // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¼€å§‹å½•éŸ³
            async canStartRecording() {
                if (!isIOS()) return true;

                // å¦‚æœå½“å‰æœ‰æ´»åŠ¨ä¼šè¯ï¼Œå…ˆæ¸…ç†
                if (this.isActive) {
                    this.cleanup();
                    // ç»™iOSä¸€ç‚¹æ—¶é—´æ¸…ç†èµ„æº
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                // æ£€æŸ¥é¡µé¢æ˜¯å¦æ´»è·ƒ
                if (!this.isPageActive || document.hidden) {
                    console.warn('ğŸ“± é¡µé¢ä¸æ´»è·ƒï¼Œä¸èƒ½å¼€å§‹å½•éŸ³');
                    return false;
                }

                return true;
            },

            // iOSä¸“ç”¨ - åœ¨é¡µé¢é‡æ–°åŠ è½½ååˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
            async initAudioContext() {
                if (!isIOS()) return true;
                
                try {
                    console.log('ğŸµ åˆå§‹åŒ–iOSéŸ³é¢‘ä¸Šä¸‹æ–‡');
                    
                    // å…ˆæ¸…ç†æ—§çš„éŸ³é¢‘ä¸Šä¸‹æ–‡
                    if (window.activeAudioContext) {
                        try {
                            await window.activeAudioContext.close();
                        } catch (e) {
                            // å¿½ç•¥å…³é—­é”™è¯¯
                        }
                        window.activeAudioContext = null;
                    }
                    
                    // åˆ›å»ºæ–°çš„éŸ³é¢‘ä¸Šä¸‹æ–‡
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    const audioContext = new AudioContext();
                    window.activeAudioContext = audioContext;
                    
                    // ç­‰å¾…éŸ³é¢‘ä¸Šä¸‹æ–‡å‡†å¤‡å°±ç»ª
                    if (audioContext.state === 'suspended') {
                        await audioContext.resume();
                    }
                    
                    console.log('âœ… iOSéŸ³é¢‘ä¸Šä¸‹æ–‡åˆå§‹åŒ–å®Œæˆï¼ŒçŠ¶æ€:', audioContext.state);
                    return true;
                } catch (error) {
                    console.warn('iOSéŸ³é¢‘ä¸Šä¸‹æ–‡åˆå§‹åŒ–å¤±è´¥:', error);
                    return false;
                }
            }
        };

        // ==================== iOS Safari ä¸“ç”¨éŸ³é¢‘å½•åˆ¶æ–¹æ¡ˆ ====================
        class iOSAudioRecorder {
            constructor() {
                this.stream = null;
                this.recorder = null;
                this.chunks = [];
                this.isRecording = false;
                this.audioContext = null;
            }

            async init() {
                if (!isIOS()) return true;
                
                console.log('ğŸ”„ iOSå½•éŸ³å™¨åˆå§‹åŒ–');
                
                // å…ˆå½»åº•æ¸…ç†
                this.cleanup();
                iOSMediaSession.cleanup();
                
                // ç­‰å¾…ç³»ç»Ÿèµ„æºé‡Šæ”¾
                await new Promise(resolve => setTimeout(resolve, 800));
                
                return true;
            }

            async start() {
                if (!isIOS()) return false;

                console.log('ğŸ¤ å¼€å§‹iOSä¸“ç”¨å½•éŸ³æµç¨‹');
                
                // åˆå§‹åŒ–å½•éŸ³å™¨
                await this.init();
                
                try {
                    // ç­‰å¾…é¡µé¢å®Œå…¨æ¿€æ´»
                    if (document.hidden) {
                        console.warn('ğŸ“± é¡µé¢éšè—ï¼Œç­‰å¾…æ¿€æ´»');
                        await new Promise(resolve => {
                            const checkVisibility = () => {
                                if (!document.hidden) {
                                    resolve();
                                } else {
                                    setTimeout(checkVisibility, 100);
                                }
                            };
                            checkVisibility();
                        });
                    }
                    
                    // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
                    await iOSMediaSession.initAudioContext();

                    // 1. å…ˆæ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§ä¼šè¯
                    iOSMediaSession.cleanup();
                    await new Promise(resolve => setTimeout(resolve, 300));

                    // 2. è·å–ç”¨æˆ·åª’ä½“ï¼ˆä½¿ç”¨è¯¦ç»†é…ç½®ï¼‰
                    const constraints = {
                        audio: {
                            channelCount: 1,
                            sampleRate: 44100,
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false
                        }
                    };

                    console.log('ğŸ“± è¯·æ±‚éº¦å…‹é£æƒé™...');
                    
                    // æ·»åŠ è¶…æ—¶æœºåˆ¶
                    const getMediaPromise = navigator.mediaDevices.getUserMedia(constraints);
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('éº¦å…‹é£æƒé™è¯·æ±‚è¶…æ—¶')), 5000)
                    );
                    
                    const stream = await Promise.race([getMediaPromise, timeoutPromise]);
                    
                    this.stream = stream;
                    currentAudioStream = stream;

                    console.log('âœ… è·å¾—éº¦å…‹é£æƒé™ï¼Œè½¨é“çŠ¶æ€:',
                        stream.getAudioTracks().map(t => `${t.kind}:${t.readyState}`));

                    // 3. æ£€æŸ¥è½¨é“æ˜¯å¦å¯ç”¨
                    const audioTracks = stream.getAudioTracks();
                    if (audioTracks.length === 0) {
                        throw new Error('æ²¡æœ‰å¯ç”¨çš„éŸ³é¢‘è½¨é“');
                    }
                    
                    const audioTrack = audioTracks[0];
                    if (audioTrack.readyState !== 'live') {
                        console.warn('éŸ³é¢‘è½¨é“çŠ¶æ€å¼‚å¸¸:', audioTrack.readyState);
                        // å°è¯•é‡æ–°å¯ç”¨è½¨é“
                        audioTrack.enabled = true;
                        await new Promise(resolve => setTimeout(resolve, 200));
                        
                        if (audioTrack.readyState !== 'live') {
                            throw new Error('éŸ³é¢‘è½¨é“ä¸å¯ç”¨');
                        }
                    }

                    // 4. åˆ›å»ºMediaRecorder
                    let options = {};
                    
                    // iOS Safariæ”¯æŒçš„MIMEç±»å‹æœ‰é™ï¼Œéœ€è¦æŒ‰ä¼˜å…ˆçº§å°è¯•
                    const supportedTypes = [
                        'audio/mp4',
                        'audio/aac',
                        'audio/webm;codecs=opus',
                        'audio/webm'
                    ];
                    
                    let selectedType = '';
                    for (const type of supportedTypes) {
                        if (MediaRecorder.isTypeSupported(type)) {
                            selectedType = type;
                            break;
                        }
                    }
                    
                    if (selectedType) {
                        options.mimeType = selectedType;
                        console.log('ğŸ“± ä½¿ç”¨éŸ³é¢‘æ ¼å¼:', selectedType);
                    } else {
                        console.log('ğŸ“± ä½¿ç”¨é»˜è®¤éŸ³é¢‘æ ¼å¼');
                    }

                    this.recorder = new MediaRecorder(stream, options);
                    this.chunks = [];

                    // 5. è®¾ç½®äº‹ä»¶å¤„ç†å™¨
                    this.recorder.ondataavailable = (event) => {
                        if (event.data && event.data.size > 0) {
                            this.chunks.push(event.data);
                            console.log('ğŸ“¦ æ”¶åˆ°éŸ³é¢‘æ•°æ®å—:', event.data.size, 'bytes');
                        }
                    };

                    this.recorder.onstop = () => {
                        console.log('â¹ï¸ iOSå½•éŸ³åœæ­¢ï¼Œæ•°æ®å—æ•°é‡:', this.chunks.length);

                        if (this.chunks.length === 0) {
                            console.error('âŒ æ²¡æœ‰å½•åˆ°éŸ³é¢‘æ•°æ®');
                            setTimeout(() => {
                                this.retryWithFallback();
                            }, 500);
                            return;
                        }

                        const audioBlob = new Blob(this.chunks, {
                            type: this.recorder.mimeType || 'audio/mp4'
                        });

                        console.log('ğŸµ å½•éŸ³å®Œæˆï¼Œå¤§å°:', audioBlob.size, 'bytes');

                        if (audioBlob.size === 0) {
                            console.error('âŒ å½•éŸ³æ•°æ®ä¸ºç©º');
                            alert('å½•éŸ³å¤±è´¥ï¼Œæ²¡æœ‰å½•åˆ°å£°éŸ³ã€‚è¯·é‡è¯•ã€‚');
                            return;
                        }

                        // ä¿å­˜å½•éŸ³
                        currentRecordedAudioBlob = audioBlob;
                        showAudioMobilePreview();

                        // å»¶è¿Ÿæ¸…ç†æµ
                        setTimeout(() => {
                            this.cleanupStream();
                        }, 1000);
                    };

                    this.recorder.onerror = (event) => {
                        console.error('ğŸ¤ å½•éŸ³é”™è¯¯:', event.error);
                        
                        // å‹å¥½çš„é”™è¯¯æç¤º
                        let errorMessage = 'å½•éŸ³å‡ºé”™';
                        if (event.error.name === 'NotAllowedError') {
                            errorMessage = 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ã€‚è¯·å…è®¸ç½‘é¡µè®¿é—®éº¦å…‹é£ã€‚';
                        } else if (event.error.name === 'NotFoundError') {
                            errorMessage = 'æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡ã€‚';
                        } else if (event.error.name === 'NotReadableError') {
                            errorMessage = 'éº¦å…‹é£æ­£è¢«å…¶ä»–åº”ç”¨å ç”¨ã€‚';
                        }
                        
                        alert(errorMessage);
                        this.isRecording = false;
                        
                        // æ¸…ç†å¹¶é‡è¯•
                        this.cleanup();
                    };

                    // 6. å¼€å§‹å½•éŸ³
                    this.recorder.start(250);
                    this.isRecording = true;
                    iOSMediaSession.isActive = true;

                    console.log('âœ… iOSå½•éŸ³å¼€å§‹æˆåŠŸï¼ŒMIMEç±»å‹:', this.recorder.mimeType);
                    return true;

                } catch (error) {
                    console.error('ğŸ¤ iOSå½•éŸ³å¯åŠ¨å¤±è´¥:', error);

                    let errorMessage = 'æ— æ³•å¼€å§‹å½•éŸ³';
                    
                    if (error.name === 'NotAllowedError') {
                        errorMessage = 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ã€‚\n\nè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š\n1. ç‚¹å‡»åœ°å€æ å·¦ä¾§çš„"AA"å›¾æ ‡\n2. é€‰æ‹©"ç½‘ç«™è®¾ç½®"\n3. å…è®¸"éº¦å…‹é£"æƒé™\n4. åˆ·æ–°é¡µé¢åé‡è¯•';
                    } else if (error.name === 'NotFoundError') {
                        errorMessage = 'æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡ã€‚è¯·æ£€æŸ¥è®¾å¤‡éº¦å…‹é£æ˜¯å¦æ­£å¸¸ã€‚';
                    } else if (error.name === 'NotReadableError') {
                        errorMessage = 'éº¦å…‹é£æ­£è¢«å…¶ä»–åº”ç”¨å ç”¨ã€‚è¯·å…³é—­å…¶ä»–ä½¿ç”¨éº¦å…‹é£çš„åº”ç”¨åé‡è¯•ã€‚';
                    } else if (error.name === 'AbortError') {
                        errorMessage = 'å½•éŸ³è¢«ä¸­æ–­ã€‚è¯·ä¿æŒåœ¨å½“å‰é¡µé¢å®Œæˆå½•éŸ³ã€‚';
                    } else if (error.message === 'éº¦å…‹é£æƒé™è¯·æ±‚è¶…æ—¶') {
                        errorMessage = 'éº¦å…‹é£æƒé™è¯·æ±‚è¶…æ—¶ã€‚\n\nå»ºè®®ï¼š\n1. å®Œå…¨å…³é—­Safariæµè§ˆå™¨\n2. é‡æ–°æ‰«æäºŒç»´ç \n3. å…è®¸éº¦å…‹é£æƒé™åé‡è¯•';
                    } else {
                        errorMessage = 'æ— æ³•è®¿é—®éº¦å…‹é£: ' + error.message;
                    }
                    
                    // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯æç¤º
                    alert(errorMessage + '\n\nå¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·å°è¯•å®Œå…¨å…³é—­Safariæµè§ˆå™¨åé‡è¯•ã€‚');

                    this.cleanup();
                    return false;
                }
            }

            stop() {
                if (this.recorder && this.recorder.state === 'recording') {
                    this.recorder.stop();
                    this.isRecording = false;
                    iOSMediaSession.isActive = false;
                }
            }

            cleanup() {
                console.log('ğŸ§¹ iOSå½•éŸ³å™¨æ¸…ç†');
                
                if (this.stream) {
                    this.stream.getTracks().forEach(track => {
                        try {
                            track.stop();
                            console.log('âœ… åœæ­¢è½¨é“:', track.kind);
                        } catch (e) {
                            console.warn('åœæ­¢è½¨é“å¤±è´¥:', e);
                        }
                    });
                    this.stream = null;
                    currentAudioStream = null;
                }

                if (this.recorder) {
                    if (this.recorder.state === 'recording') {
                        try {
                            this.recorder.stop();
                        } catch (e) {
                            console.warn('åœæ­¢å½•éŸ³å™¨å¤±è´¥:', e);
                        }
                    }
                    this.recorder = null;
                }

                this.chunks = [];
                this.isRecording = false;
                iOSMediaSession.isActive = false;
                
                // æ¸…ç†éŸ³é¢‘ä¸Šä¸‹æ–‡
                if (this.audioContext) {
                    try {
                        this.audioContext.close();
                    } catch (e) {
                        // å¿½ç•¥å…³é—­é”™è¯¯
                    }
                    this.audioContext = null;
                }
            }

            cleanupStream() {
                setTimeout(() => {
                    if (this.stream) {
                        this.stream.getTracks().forEach(track => {
                            try {
                                track.stop();
                            } catch (e) {
                                // å¿½ç•¥é”™è¯¯
                            }
                        });
                        this.stream = null;
                        currentAudioStream = null;
                    }
                }, 500);
            }

            async retryWithFallback() {
                console.log('ğŸ”„ å°è¯•å¤‡ç”¨å½•éŸ³æ–¹æ¡ˆ...');

                try {
                    this.cleanup();
                    await new Promise(resolve => setTimeout(resolve, 800));

                    // ç®€åŒ–é…ç½®ï¼Œé¿å…iOSå…¼å®¹æ€§é—®é¢˜
                    const simpleStream = await navigator.mediaDevices.getUserMedia({
                        audio: true
                    });

                    // ä½¿ç”¨æœ€ç®€å•çš„é…ç½®
                    const simpleRecorder = new MediaRecorder(simpleStream);
                    const chunks = [];

                    simpleRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) chunks.push(event.data);
                    };

                    simpleRecorder.onstop = () => {
                        if (chunks.length > 0) {
                            const audioBlob = new Blob(chunks, { type: 'audio/webm' });
                            currentRecordedAudioBlob = audioBlob;
                            showAudioMobilePreview();
                        }
                        simpleStream.getTracks().forEach(t => {
                            try {
                                t.stop();
                            } catch (e) {
                                // å¿½ç•¥é”™è¯¯
                            }
                        });
                    };

                    simpleRecorder.start();

                    // å½•åˆ¶3ç§’æµ‹è¯•éŸ³é¢‘
                    setTimeout(() => {
                        if (simpleRecorder.state === 'recording') {
                            simpleRecorder.stop();
                        }
                    }, 3000);

                    console.log('âœ… å¤‡ç”¨å½•éŸ³æ–¹æ¡ˆå¯åŠ¨');
                    return true;
                } catch (error) {
                    console.error('å¤‡ç”¨æ–¹æ¡ˆä¹Ÿå¤±è´¥äº†:', error);
                    return false;
                }
            }
        }

        // åˆ›å»ºiOSå½•éŸ³å™¨å®ä¾‹
        const iOSRecorder = new iOSAudioRecorder();

        // ==================== éŸ³é¢‘è½¬æ¢å‡½æ•° ====================
        async function convertAudioToMP3(audioFile) {
            console.log('ğŸµ å¼€å§‹éŸ³é¢‘è½¬æ¢:', audioFile.name);

            // iOSè®¾å¤‡ä½¿ç”¨ç®€åŒ–è½¬æ¢
            if (isIOS()) {
                console.log('ğŸ“± iOSè®¾å¤‡ï¼Œä½¿ç”¨ç®€åŒ–è½¬æ¢');

                try {
                    // å¯¹äºiOSå½•åˆ¶çš„æ–‡ä»¶ï¼Œå°è¯•ä¿æŒåŸæ ¼å¼
                    if (audioFile.type.includes('m4a') || audioFile.type.includes('mp4') || audioFile.name.includes('m4a')) {
                        console.log('ğŸ“± ä½¿ç”¨iOSåŸå§‹éŸ³é¢‘æ ¼å¼');
                        // å¦‚æœæ˜¯m4aæ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨ï¼Œä½†é‡å‘½åä¸ºmp3
                        const renamedFile = new File([audioFile], `audio_${assignedUserId}.m4a`, {
                            type: 'audio/mp4',
                            lastModified: Date.now()
                        });
                        return renamedFile;
                    }

                    // å¯¹äºå…¶ä»–æ ¼å¼ï¼Œå°è¯•ç®€å•è½¬æ¢
                    console.log('ğŸ“± å°è¯•ç®€å•éŸ³é¢‘è½¬æ¢');
                    const arrayBuffer = await audioFile.arrayBuffer();

                    // å°è¯•ä½¿ç”¨lamejsè¿›è¡Œè½¬æ¢
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

                    const sampleRate = Math.min(44100, audioBuffer.sampleRate);
                    const bitRate = 128;
                    const mp3Encoder = new lamejs.Mp3Encoder(1, sampleRate, bitRate);

                    const channelData = audioBuffer.getChannelData(0);
                    const sampleBlockSize = 1152;
                    let mp3Data = [];

                    const convertBuffer = (input) => {
                        const len = input.length;
                        const output = new Int16Array(len);
                        for (let i = 0; i < len; i++) {
                            const s = Math.max(-1, Math.min(1, input[i]));
                            output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                        }
                        return output;
                    };

                    for (let i = 0; i < channelData.length; i += sampleBlockSize) {
                        const chunk = channelData.subarray(i, i + sampleBlockSize);
                        const int16Data = convertBuffer(chunk);
                        const mp3Chunk = mp3Encoder.encodeBuffer(int16Data);
                        if (mp3Chunk.length > 0) {
                            mp3Data.push(new Int8Array(mp3Chunk));
                        }
                    }

                    const finalChunk = mp3Encoder.flush();
                    if (finalChunk.length > 0) {
                        mp3Data.push(new Int8Array(finalChunk));
                    }

                    const totalLength = mp3Data.reduce((acc, chunk) => acc + chunk.length, 0);
                    const mergedArray = new Int8Array(totalLength);
                    let offset = 0;
                    for (const chunk of mp3Data) {
                        mergedArray.set(chunk, offset);
                        offset += chunk.length;
                    }

                    const mp3Blob = new Blob([mergedArray.buffer], { type: 'audio/mpeg' });
                    const convertedFile = new File([mp3Blob], `audio_${assignedUserId}.mp3`, {
                        type: 'audio/mpeg',
                        lastModified: Date.now()
                    });

                    console.log('âœ… iOSéŸ³é¢‘è½¬æ¢æˆåŠŸï¼å¤§å°:', (convertedFile.size / 1024).toFixed(2), 'KB');
                    return convertedFile;

                } catch (error) {
                    console.error('iOSéŸ³é¢‘è½¬æ¢å¤±è´¥:', error);

                    // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥ä¸Šä¼ åŸå§‹æ–‡ä»¶
                    const safeFile = new File([audioFile], `audio_${assignedUserId}_original.${audioFile.name.split('.').pop() || 'webm'}`, {
                        type: audioFile.type,
                        lastModified: Date.now()
                    });

                    return safeFile;
                }
            }

            // éiOSè®¾å¤‡ä½¿ç”¨æ ‡å‡†è½¬æ¢é€»è¾‘
            try {
                const arrayBuffer = await audioFile.arrayBuffer();
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

                const sampleRate = Math.min(44100, audioBuffer.sampleRate);
                const bitRate = 128;
                const mp3Encoder = new lamejs.Mp3Encoder(1, sampleRate, bitRate);

                const channelData = audioBuffer.getChannelData(0);
                const sampleBlockSize = 1152;
                let mp3Data = [];

                const convertBuffer = (input) => {
                    const len = input.length;
                    const output = new Int16Array(len);
                    for (let i = 0; i < len; i++) {
                        const s = Math.max(-1, Math.min(1, input[i]));
                        output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                    }
                    return output;
                };

                for (let i = 0; i < channelData.length; i += sampleBlockSize) {
                    const chunk = channelData.subarray(i, i + sampleBlockSize);
                    const int16Data = convertBuffer(chunk);
                    const mp3Chunk = mp3Encoder.encodeBuffer(int16Data);
                    if (mp3Chunk.length > 0) {
                        mp3Data.push(new Int8Array(mp3Chunk));
                    }
                }

                const finalChunk = mp3Encoder.flush();
                if (finalChunk.length > 0) {
                    mp3Data.push(new Int8Array(finalChunk));
                }

                const totalLength = mp3Data.reduce((acc, chunk) => acc + chunk.length, 0);
                const mergedArray = new Int8Array(totalLength);
                let offset = 0;
                for (const chunk of mp3Data) {
                    mergedArray.set(chunk, offset);
                    offset += chunk.length;
                }

                const mp3Blob = new Blob([mergedArray.buffer], { type: 'audio/mpeg' });
                const convertedFile = new File([mp3Blob], `audio_${assignedUserId}.mp3`, {
                    type: 'audio/mpeg',
                    lastModified: Date.now()
                });

                console.log('âœ… éŸ³é¢‘è½¬æ¢æˆåŠŸï¼å¤§å°:', (convertedFile.size / 1024).toFixed(2), 'KB');
                return convertedFile;

            } catch (error) {
                console.error('éŸ³é¢‘è½¬æ¢å¤±è´¥:', error);

                // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥ä½¿ç”¨åŸå§‹æ–‡ä»¶
                const safeFile = new File([audioFile], `audio_${assignedUserId}_original.${audioFile.name.split('.').pop() || 'webm'}`, {
                    type: audioFile.type,
                    lastModified: Date.now()
                });

                return safeFile;
            }
        }

        // ==================== å®‰å…¨éªŒè¯å’Œé¡µé¢åˆå§‹åŒ– ====================
        window.addEventListener('DOMContentLoaded', async function () {
            // å®‰å…¨æ ¡éªŒ
            if (!assignedUserId || !assignedUserId.startsWith('user_')) {
                console.error('æ— æ•ˆçš„ç”¨æˆ·IDå‚æ•°:', assignedUserId);
                errorContainer.style.display = 'block';
                mainContainer.style.display = 'none';
                return;
            }

            // éªŒè¯é€šè¿‡ï¼Œæ˜¾ç¤ºä¸»å®¹å™¨ï¼Œéšè—é”™è¯¯å®¹å™¨
            errorContainer.style.display = 'none';
            mainContainer.style.display = 'block';

            console.log('å½“å‰æ“ä½œç”¨æˆ·ID:', assignedUserId);

            // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // iOSä¸“ç”¨åˆå§‹åŒ–
            if (isIOS()) {
                console.log('ğŸ“± iOS Safari è®¾å¤‡æ£€æµ‹åˆ°');
                
                // é¡µé¢åŠ è½½æ—¶ç«‹å³æ·±åº¦æ¸…ç†
                setTimeout(() => {
                    iOSMediaSession.deepCleanup();
                }, 300);
                
                // å»¶è¿Ÿåˆå§‹åŒ–
                setTimeout(() => {
                    iOSMediaSession.init();
                    console.log('âœ… iOSåª’ä½“ä¼šè¯åˆå§‹åŒ–å®Œæˆ');
                }, 1500);
                
                // æ·»åŠ iOSä¸“ç”¨æ ·å¼
                const style = document.createElement('style');
                style.textContent = `
                    @media (max-width: 768px) {
                        #audioUploadBox {
                            position: relative;
                            overflow: hidden;
                        }
                        
                        #audioUploadBox .mobile-action-btn {
                            position: relative;
                            z-index: 10;
                            transition: all 0.2s ease;
                        }
                        
                        #audioUploadBox .mobile-action-btn:active {
                            transform: scale(0.95);
                            opacity: 0.9;
                        }
                        
                        * {
                            -webkit-tap-highlight-color: transparent;
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            // ç»§ç»­æ­£å¸¸åˆå§‹åŒ–
            checkUploadButton();
            initRecordingUI();
            initCameraUI();

            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            if (!isMobile) {
                audioUploadBox.addEventListener('click', () => audioInput.click());
                imageUploadBox.addEventListener('click', () => imageInput.click());
            }

            audioInput.addEventListener('change', handleAudioSelect);
            imageInput.addEventListener('change', handleImageSelect);
            uploadBtn.addEventListener('click', handleUpload);

            // æ·»åŠ iOSé¡µé¢çŠ¶æ€ç›‘å¬
            if (isIOS()) {
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        console.log('ğŸ“± é¡µé¢é‡æ–°æ˜¾ç¤º');
                        const recordBtn = document.querySelector('#audioUploadBox .mobile-action-btn .record-text');
                        if (recordBtn) {
                            recordBtn.textContent = 'å½•åˆ¶å£°éŸ³';
                        }
                        isRecording = false;
                    }
                });
            }
        });

        // ==================== æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ====================

        // å¤„ç†éŸ³é¢‘é€‰æ‹©
        function handleAudioSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('audio/')) {
                selectedAudio = file;
                document.getElementById('audioFileName').textContent = file.name;
                audioPreview.style.display = 'flex';
                audioUploadBox.querySelector('.upload-placeholder').style.display = 'none';

                audioMobilePreview.style.display = 'none';

                checkUploadButton();
            } else {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„éŸ³é¢‘æ–‡ä»¶ã€‚');
            }
        }

        // å¤„ç†å›¾ç‰‡é€‰æ‹©
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                processImageFile(file);
            } else {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ã€‚');
            }
        }

        // å¤„ç†å›¾ç‰‡æ–‡ä»¶
        function processImageFile(file) {
            selectedImage = file;
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('imageThumbnail').src = e.target.result;
            };
            reader.readAsDataURL(file);
            imagePreview.style.display = 'flex';
            imageUploadBox.querySelector('.upload-placeholder').style.display = 'none';

            imageMobilePreview.style.display = 'none';

            checkUploadButton();
        }

        // æ£€æŸ¥ä¸Šä¼ æŒ‰é’®çŠ¶æ€
        function checkUploadButton() {
            uploadBtn.disabled = !(selectedAudio || selectedImage);

            if (selectedAudio && selectedImage) {
                uploadBtn.textContent = 'ä¸Šä¼ å£°éŸ³ä¸å›¾ç‰‡';
                uploadBtn.style.background = 'linear-gradient(135deg, #fd79a8, #e84393)';
            } else if (selectedAudio) {
                uploadBtn.textContent = 'ä»…ä¸Šä¼ å£°éŸ³';
                uploadBtn.style.background = 'linear-gradient(135deg, #6c5ce7, #a29bfe)';
            } else if (selectedImage) {
                uploadBtn.textContent = 'ä»…ä¸Šä¼ å›¾ç‰‡';
                uploadBtn.style.background = 'linear-gradient(135deg, #00b894, #00cec9)';
            } else {
                uploadBtn.textContent = 'è¯·å…ˆé€‰æ‹©å£°éŸ³æˆ–å›¾ç‰‡';
                uploadBtn.style.background = 'linear-gradient(135deg, #6c5ce7, #a29bfe)';
            }
        }

        // ==================== ç§»åŠ¨ç«¯å½•éŸ³åŠŸèƒ½ ====================

        // åˆå§‹åŒ–å½•éŸ³UI
        function initRecordingUI() {
            const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

            if (isMobile) {
                const audioPlaceholder = document.querySelector('#audioUploadBox .upload-placeholder');
                if (audioPlaceholder) {
                    audioPlaceholder.querySelector('.icon').style.display = 'none';
                    audioPlaceholder.querySelector('p').style.display = 'none';
                    audioPlaceholder.querySelector('small').style.display = 'none';

                    const micIconLarge = audioPlaceholder.querySelector('.mic-icon-large');
                    if (micIconLarge) {
                        micIconLarge.style.display = 'block';
                    }

                    const recordBtn = document.createElement('button');
                    recordBtn.className = 'mobile-action-btn';

                    const btnContent = document.createElement('span');
                    btnContent.className = 'record-text';
                    btnContent.textContent = 'å½•åˆ¶å£°éŸ³';

                    recordBtn.appendChild(btnContent);
                    recordBtn.onclick = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        toggleRecording();
                    };

                    audioPlaceholder.appendChild(recordBtn);

                    audioUploadBox.style.cursor = 'default';
                }
            }
        }

        // å½•éŸ³æ§åˆ¶å‡½æ•°
        async function toggleRecording() {
            if (!isRecording) {
                if (isIOS()) {
                    console.log('ğŸ“± iOSå½•éŸ³å¼€å§‹');

                    const recordBtn = document.querySelector('#audioUploadBox .mobile-action-btn .record-text');
                    if (recordBtn) {
                        recordBtn.textContent = 'å‡†å¤‡ä¸­...';
                        recordBtn.parentElement.disabled = true;
                    }

                    // æ£€æŸ¥é¡µé¢çŠ¶æ€
                    if (document.hidden) {
                        alert('è¯·ç¡®ä¿é¡µé¢å®Œå…¨æ˜¾ç¤ºåå†å¼€å§‹å½•éŸ³ã€‚');
                        if (recordBtn) {
                            recordBtn.textContent = 'å½•åˆ¶å£°éŸ³';
                            recordBtn.parentElement.disabled = false;
                        }
                        return;
                    }

                    // æ˜¾ç¤ºiOSä¸“ç”¨æç¤º
                    if (window.location.href.indexOf('_t=') === -1) {
                        // é¦–æ¬¡è¿›å…¥é¡µé¢ï¼Œæ˜¾ç¤ºè¯¦ç»†æŒ‡å¼•
                        const userConfirmed = confirm(
                            'iOS Safariéœ€è¦é‡æ–°è¯·æ±‚éº¦å…‹é£æƒé™ã€‚\n\nå¦‚æœå½•éŸ³å¤±è´¥ï¼Œè¯·å°è¯•ï¼š\n1. ç‚¹å‡»"å…è®¸"æˆæƒéº¦å…‹é£\n2. å¦‚æœé—®é¢˜æŒç»­ï¼Œå®Œå…¨å…³é—­Safariåé‡è¯•\n\nç‚¹å‡»"ç¡®å®š"å¼€å§‹å½•éŸ³ã€‚'
                        );
                        
                        if (!userConfirmed) {
                            if (recordBtn) {
                                recordBtn.textContent = 'å½•åˆ¶å£°éŸ³';
                                recordBtn.parentElement.disabled = false;
                            }
                            return;
                        }
                    }

                    const success = await iOSRecorder.start();

                    if (success) {
                        isRecording = true;
                        if (recordBtn) {
                            recordBtn.textContent = 'âºï¸ å½•éŸ³ä¸­... ç‚¹å‡»åœæ­¢';
                            recordBtn.parentElement.disabled = false;
                        }

                        recordTimeout = setTimeout(() => {
                            if (iOSRecorder.isRecording) {
                                console.log('â±ï¸ è¾¾åˆ°æœ€å¤§å½•éŸ³æ—¶é—´');
                                iOSRecorder.stop();
                                isRecording = false;
                                if (recordBtn) {
                                    recordBtn.textContent = 'å½•åˆ¶å£°éŸ³';
                                }
                            }
                        }, MAX_RECORD_TIME);
                    } else {
                        // å½•éŸ³å¤±è´¥ï¼Œæä¾›é‡è¯•é€‰é¡¹
                        if (recordBtn) {
                            recordBtn.textContent = 'å½•åˆ¶å£°éŸ³';
                            recordBtn.parentElement.disabled = false;
                        }
                        
                        // è‡ªåŠ¨é‡è¯•ä¸€æ¬¡
                        setTimeout(async () => {
                            if (confirm('å½•éŸ³å¯åŠ¨å¤±è´¥ï¼Œæ˜¯å¦é‡è¯•ï¼Ÿ')) {
                                console.log('ğŸ”„ ç”¨æˆ·é€‰æ‹©é‡è¯•');
                                await new Promise(resolve => setTimeout(resolve, 500));
                                toggleRecording();
                            }
                        }, 300);
                    }
                    return;
                }

                // éiOSè®¾å¤‡çš„å½•éŸ³é€»è¾‘
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    currentAudioStream = stream;

                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        currentRecordedAudioBlob = audioBlob;
                        showAudioMobilePreview();
                        stream.getTracks().forEach(track => track.stop());
                        currentAudioStream = null;
                    };

                    mediaRecorder.start();
                    isRecording = true;

                    const recordBtn = document.querySelector('#audioUploadBox .mobile-action-btn .record-text');
                    if (recordBtn) {
                        recordBtn.textContent = 'âºï¸ å½•éŸ³ä¸­... ç‚¹å‡»åœæ­¢';
                    }

                    recordTimeout = setTimeout(() => {
                        if (isRecording && mediaRecorder && mediaRecorder.state === 'recording') {
                            mediaRecorder.stop();
                            isRecording = false;
                            clearTimeout(recordTimeout);

                            if (recordBtn) {
                                recordBtn.textContent = 'å½•åˆ¶å£°éŸ³';
                            }
                        }
                    }, MAX_RECORD_TIME);

                } catch (error) {
                    console.error('æ— æ³•è®¿é—®éº¦å…‹é£:', error);
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®ã€‚');
                }
            } else {
                // åœæ­¢å½•éŸ³
                if (isIOS()) {
                    iOSRecorder.stop();
                } else if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }

                isRecording = false;
                if (recordTimeout) {
                    clearTimeout(recordTimeout);
                    recordTimeout = null;
                }

                const recordBtn = document.querySelector('#audioUploadBox .mobile-action-btn .record-text');
                if (recordBtn) {
                    recordBtn.textContent = 'å½•åˆ¶å£°éŸ³';
                }
            }
        }

        // æ˜¾ç¤ºéŸ³é¢‘ç§»åŠ¨ç«¯é¢„è§ˆ
        function showAudioMobilePreview() {
            const audioPlaceholder = document.querySelector('#audioUploadBox .upload-placeholder');
            audioPlaceholder.style.display = 'none';
            audioPreview.style.display = 'none';
            audioMobilePreview.style.display = 'flex';
        }

        // é‡æ–°å½•åˆ¶éŸ³é¢‘
        function retryAudioRecording() {
            audioMobilePreview.style.display = 'none';

            const audioPlaceholder = document.querySelector('#audioUploadBox .upload-placeholder');
            audioPlaceholder.style.display = 'flex';

            if (isIOS()) {
                iOSRecorder.cleanup();
            }
            currentRecordedAudioBlob = null;
            selectedAudio = null;
            checkUploadButton();
        }

        // ç¡®è®¤ä½¿ç”¨å½•åˆ¶çš„éŸ³é¢‘
        async function confirmAudioRecording() {
            if (!currentRecordedAudioBlob) {
                alert('è¯·å…ˆå½•åˆ¶éŸ³é¢‘');
                return;
            }

            const recordedFile = new File([currentRecordedAudioBlob], `recording_${Date.now()}.${isIOS() ? 'm4a' : 'webm'}`, {
                type: isIOS() ? 'audio/mp4' : 'audio/webm'
            });

            handleAudioSelect({ target: { files: [recordedFile] } });
        }

        // ==================== ç§»åŠ¨ç«¯æ‹ç…§åŠŸèƒ½ ====================
        function initCameraUI() {
            const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

            if (isMobile) {
                const imagePlaceholder = document.querySelector('#imageUploadBox .upload-placeholder');
                if (imagePlaceholder) {
                    imagePlaceholder.querySelector('.icon').style.display = 'none';
                    imagePlaceholder.querySelector('p').style.display = 'none';
                    imagePlaceholder.querySelector('small').style.display = 'none';

                    const cameraIconLarge = imagePlaceholder.querySelector('.camera-icon-large');
                    if (cameraIconLarge) {
                        cameraIconLarge.style.display = 'block';
                    }

                    const cameraBtn = document.createElement('button');
                    cameraBtn.className = 'mobile-action-btn photo';

                    const btnContent = document.createElement('span');
                    btnContent.className = 'camera-text';
                    btnContent.textContent = 'æ‹ç…§ä¸Šä¼ ';

                    cameraBtn.appendChild(btnContent);
                    cameraBtn.onclick = (e) => {
                        e.stopPropagation();
                        openCamera();
                    };

                    imagePlaceholder.appendChild(cameraBtn);

                    imageUploadBox.style.cursor = 'default';
                }
            }
        }

        async function openCamera() {
            try {
                if (isIOS()) {
                    iOSMediaSession.cleanup();
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                currentCameraMode = 'environment';

                await startCamera(currentCameraMode);

            } catch (error) {
                console.error('æ— æ³•è®¿é—®æ‘„åƒå¤´:', error);
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®ã€‚');
            }
        }

        async function startCamera(cameraMode) {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }

            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: cameraMode },
                    audio: false
                });

                const cameraModal = document.createElement('div');
                cameraModal.className = 'camera-modal';

                const video = document.createElement('video');
                video.srcObject = cameraStream;
                video.autoplay = true;
                video.playsInline = true;

                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'camera-controls';

                const captureBtn = document.createElement('button');
                captureBtn.innerHTML = 'ğŸ“¸ æ‹ç…§';
                captureBtn.className = 'camera-btn capture-btn';

                const switchBtn = document.createElement('button');
                switchBtn.innerHTML = currentCameraMode === 'environment' ? 'ğŸ”„ å‰ç½®æ‘„åƒå¤´' : 'ğŸ”„ åç½®æ‘„åƒå¤´';
                switchBtn.className = 'camera-btn switch-camera-btn';

                const cancelBtn = document.createElement('button');
                cancelBtn.innerHTML = 'å–æ¶ˆ';
                cancelBtn.className = 'camera-btn cancel-btn';

                buttonContainer.appendChild(captureBtn);
                buttonContainer.appendChild(switchBtn);
                buttonContainer.appendChild(cancelBtn);

                cameraModal.appendChild(video);
                cameraModal.appendChild(buttonContainer);
                document.body.appendChild(cameraModal);

                captureBtn.onclick = () => capturePhoto(video, cameraModal);

                switchBtn.onclick = () => {
                    currentCameraMode = currentCameraMode === 'environment' ? 'user' : 'environment';
                    switchBtn.innerHTML = currentCameraMode === 'environment' ? 'ğŸ”„ å‰ç½®æ‘„åƒå¤´' : 'ğŸ”„ åç½®æ‘„åƒå¤´';

                    startCamera(currentCameraMode).then(() => {
                        video.srcObject = cameraStream;

                        if (cameraModal && cameraModal.parentNode) {
                            cameraModal.parentNode.removeChild(cameraModal);
                        }
                    });
                };

                cancelBtn.onclick = () => closeCamera(cameraModal);

            } catch (error) {
                console.error('å¯åŠ¨æ‘„åƒå¤´å¤±è´¥:', error);
                if (cameraMode === 'environment') {
                    alert('æ— æ³•è®¿é—®åç½®æ‘„åƒå¤´ï¼Œå°è¯•ä½¿ç”¨å‰ç½®æ‘„åƒå¤´...');
                    currentCameraMode = 'user';
                    await startCamera(currentCameraMode);
                } else {
                    alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®ã€‚');
                }
            }
        }

        function capturePhoto(videoElement, modalElement) {
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;

            const context = canvas.getContext('2d');
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

            canvas.toBlob((blob) => {
                if (blob) {
                    currentCapturedPhotoBlob = blob;
                    showPhotoMobilePreview(blob);
                }
                closeCamera(modalElement);
            }, 'image/jpeg', 0.9);
        }

        function showPhotoMobilePreview(blob) {
            const imageUrl = URL.createObjectURL(blob);
            imageMobileThumbnail.src = imageUrl;

            const imagePlaceholder = document.querySelector('#imageUploadBox .upload-placeholder');
            imagePlaceholder.style.display = 'none';
            imagePreview.style.display = 'none';
            imageMobilePreview.style.display = 'flex';
        }

        function retryPhotoCapture() {
            imageMobilePreview.style.display = 'none';

            const imagePlaceholder = document.querySelector('#imageUploadBox .upload-placeholder');
            imagePlaceholder.style.display = 'flex';

            if (imageMobileThumbnail.src.startsWith('blob:')) {
                URL.revokeObjectURL(imageMobileThumbnail.src);
            }
            currentCapturedPhotoBlob = null;
            selectedImage = null;
            imageMobileThumbnail.src = '';
            checkUploadButton();
        }

        function confirmPhotoCapture() {
            if (!currentCapturedPhotoBlob) {
                alert('è¯·å…ˆæ‹æ‘„ç…§ç‰‡');
                return;
            }

            const photoFile = new File([currentCapturedPhotoBlob], `photo_${Date.now()}.jpg`, {
                type: 'image/jpeg'
            });

            processImageFile(photoFile);
        }

        function closeCamera(modalElement) {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            if (modalElement && modalElement.parentNode) {
                modalElement.parentNode.removeChild(modalElement);
            }
        }

        // ==================== ä¸Šä¼ å‡½æ•° ====================
        async function handleUpload() {
            const client = supabaseClient;
            let uploadAudio = selectedAudio !== null;
            let uploadImage = selectedImage !== null;

            if (!uploadAudio && !uploadImage) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ ã€‚');
                return;
            }

            const MAX_AUDIO_SIZE = 5 * 1024 * 1024;
            const MAX_IMAGE_SIZE = 2 * 1024 * 1024;

            if (uploadAudio && selectedAudio.size > MAX_AUDIO_SIZE) {
                alert(`éŸ³é¢‘æ–‡ä»¶å¤§å°è¯·æ§åˆ¶åœ¨5MBä»¥å†…ã€‚`);
                return;
            }
            if (uploadImage && selectedImage.size > MAX_IMAGE_SIZE) {
                alert(`å›¾ç‰‡æ–‡ä»¶å¤§å°è¯·æ§åˆ¶åœ¨2MBä»¥å†…ã€‚`);
                return;
            }

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'å¤„ç†ä¸­...';
            let uploadSuccess = { audio: false, image: false };

            try {
                console.log(`å¼€å§‹ä¸ºç”¨æˆ· ${assignedUserId} å¤„ç†æ–‡ä»¶...`);

                // 1. å›¾ç‰‡å¤„ç†
                if (uploadImage) {
                    uploadBtn.textContent = 'æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...';
                    const { error: imageError } = await client.storage
                        .from('love-letters')
                        .upload(`${assignedUserId}/image.jpg`, selectedImage, {
                            upsert: true,
                            cacheControl: 'public, max-age=31536000'
                        });
                    if (imageError) throw new Error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${imageError.message}`);
                    uploadSuccess.image = true;
                    console.log('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ');
                }

                // 2. éŸ³é¢‘å¤„ç†
                if (uploadAudio) {
                    uploadBtn.textContent = 'æ­£åœ¨å¤„ç†éŸ³é¢‘...';

                    // ä½¿ç”¨ convertAudioToMP3 å‡½æ•°ï¼ˆæ³¨æ„ï¼šä¸æ˜¯ convertAudioToMP3_iOSï¼‰
                    const finalAudioFile = await convertAudioToMP3(selectedAudio);

                    uploadBtn.textContent = 'æ­£åœ¨ä¸Šä¼ éŸ³é¢‘...';
                    const { error: audioError } = await client.storage
                        .from('love-letters')
                        .upload(`${assignedUserId}/audio.mp3`, finalAudioFile, {
                            upsert: true,
                            cacheControl: 'public, max-age=31536000',
                            contentType: 'audio/mpeg'
                        });
                    if (audioError) throw new Error(`éŸ³é¢‘ä¸Šä¼ å¤±è´¥: ${audioError.message}`);
                    uploadSuccess.audio = true;
                    console.log('âœ… éŸ³é¢‘ä¸Šä¼ æˆåŠŸ');
                }

                // 3. ç”ŸæˆæˆåŠŸä¿¡æ¯
                let successText = '';
                if (uploadSuccess.audio && uploadSuccess.image) {
                    successText = 'å£°éŸ³å’Œå›¾ç‰‡æ–‡ä»¶éƒ½å·²ä¸Šä¼ æˆåŠŸï¼';
                } else if (uploadSuccess.audio) {
                    successText = 'å£°éŸ³æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼';
                } else if (uploadSuccess.image) {
                    successText = 'å›¾ç‰‡æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼';
                }

                successDetails.textContent = successText;
                successMessage.style.display = 'block';
                uploadBtn.textContent = 'âœ… ä¸Šä¼ å®Œæˆ';
                uploadBtn.style.background = '#00b894';
                successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // iOS Safari ä¼˜åŒ–
                if (isIOS()) {
                    console.log('ğŸ“± iOSä¸Šä¼ å®Œæˆï¼Œæ¸…ç†èµ„æº...');

                    setTimeout(() => {
                        iOSMediaSession.deepCleanup();
                        iOSRecorder.cleanup();
                        console.log('ğŸ§¹ iOSèµ„æºæ¸…ç†å®Œæˆ');
                    }, 100);
                }

                // é¡µé¢åˆ·æ–°
                const refreshDelay = isIOS() ? 2000 : 1500;

                setTimeout(() => {
                    if (isIOS()) {
                        iOSMediaSession.deepCleanup();
                        iOSRecorder.cleanup();
                    }

                    safePageRefresh();
                }, refreshDelay);

            } catch (error) {
                console.error('ä¸Šä¼ è¿‡ç¨‹å‡ºé”™:', error);
                alert(`ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚\né”™è¯¯ä¿¡æ¯: ${error.message}`);

                uploadBtn.disabled = false;
                checkUploadButton();

                if (isIOS()) {
                    setTimeout(() => {
                        iOSMediaSession.deepCleanup();
                        iOSRecorder.cleanup();
                    }, 100);
                }
            }
        }

        // ==================== å®‰å…¨é¡µé¢åˆ·æ–°å‡½æ•° ====================
        function safePageRefresh() {
            if (isIOS()) {
                // åœ¨iOSä¸Šï¼Œä½¿ç”¨replaceè€Œä¸æ˜¯reloadï¼Œé¿å…ç¼“å­˜é—®é¢˜
                const timestamp = new Date().getTime();
                const currentUrl = new URL(window.location.href);
                
                // ç§»é™¤æ—§çš„æ—¶é—´æˆ³
                currentUrl.searchParams.delete('_t');
                // æ·»åŠ æ–°çš„æ—¶é—´æˆ³
                currentUrl.searchParams.set('_t', timestamp);
                
                console.log('ğŸ”„ iOSå®‰å…¨åˆ·æ–°é¡µé¢ï¼ŒURL:', currentUrl.toString());
                
                // å…ˆæ·±åº¦æ¸…ç†å†è·³è½¬
                setTimeout(() => {
                    iOSMediaSession.deepCleanup();
                    iOSRecorder.cleanup();
                    
                    // ä½¿ç”¨replaceé¿å…å†å²è®°å½•é—®é¢˜
                    window.location.replace(currentUrl.toString());
                }, 300);
            } else {
                window.location.reload();
            }
        }

        // ==================== é‡ç½®ä¸Šä¼ ç•Œé¢ ====================
        function resetUploadInterface() {
            selectedAudio = null;
            selectedImage = null;

            audioPreview.style.display = 'none';
            audioUploadBox.querySelector('.upload-placeholder').style.display = 'flex';
            audioInput.value = '';
            audioMobilePreview.style.display = 'none';

            imagePreview.style.display = 'none';
            imageUploadBox.querySelector('.upload-placeholder').style.display = 'flex';
            imageInput.value = '';
            document.getElementById('imageThumbnail').src = '';
            imageMobilePreview.style.display = 'none';

            if (imageMobileThumbnail.src.startsWith('blob:')) {
                URL.revokeObjectURL(imageMobileThumbnail.src);
                imageMobileThumbnail.src = '';
            }

            currentRecordedAudioBlob = null;
            currentCapturedPhotoBlob = null;

            if (isIOS()) {
                iOSRecorder.cleanup();
                iOSMediaSession.cleanup();
            }

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'è¯·å…ˆé€‰æ‹©å£°éŸ³æˆ–å›¾ç‰‡';
            uploadBtn.style.background = 'linear-gradient(135deg, #6c5ce7, #a29bfe)';

            successMessage.style.display = 'none';
        }

        // ==================== æ·»åŠ è°ƒè¯•ä¿¡æ¯ ====================
        if (window.location.hostname.includes('localhost') || window.location.hostname.includes('netlify')) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const debugDiv = document.createElement('div');
                    debugDiv.style.cssText = `
                        position: fixed;
                        top: 10px;
                        left: 10px;
                        background: rgba(0,0,0,0.8);
                        color: white;
                        padding: 10px;
                        border-radius: 5px;
                        font-size: 12px;
                        z-index: 9999;
                        max-width: 300px;
                        display: ${isIOS() ? 'block' : 'none'};
                    `;
                    debugDiv.innerHTML = `
                        <div>iOS: ${isIOS() ? 'âœ…' : 'âŒ'}</div>
                        <div>ç”¨æˆ·: ${assignedUserId || 'æ— '}</div>
                        <div>é¡µé¢çŠ¶æ€: ${document.hidden ? 'éšè—' : 'æ˜¾ç¤º'}</div>
                        <button onclick="forceCleanup()" 
                            style="margin-top:5px; padding:5px; background:#ff4757; color:white; border:none; border-radius:3px;">
                            å¼ºåˆ¶æ¸…ç†iOSåª’ä½“èµ„æº
                        </button>
                        <button onclick="testMicrophone()" 
                            style="margin-top:5px; padding:5px; background:#3742fa; color:white; border:none; border-radius:3px;">
                            æµ‹è¯•éº¦å…‹é£æƒé™
                        </button>
                    `;
                    document.body.appendChild(debugDiv);
                }, 1000);
            });
        }

        // æ·»åŠ æ–°çš„è°ƒè¯•å‡½æ•°
        function forceCleanup() {
            console.log('ğŸ”§ æ‰‹åŠ¨å¼ºåˆ¶æ¸…ç†');
            if (isIOS()) {
                iOSMediaSession.deepCleanup().then(() => {
                    iOSRecorder.cleanup();
                    alert('å¼ºåˆ¶æ¸…ç†å®Œæˆã€‚è¯·ç­‰å¾…3ç§’åé‡è¯•å½•éŸ³ã€‚');
                });
            } else {
                alert('æ­¤åŠŸèƒ½ä»…é€‚ç”¨äºiOSè®¾å¤‡ã€‚');
            }
        }

        async function testMicrophone() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const tracks = stream.getTracks();
                alert(`éº¦å…‹é£æµ‹è¯•æˆåŠŸï¼\nè½¨é“æ•°é‡: ${tracks.length}\nè½¨é“çŠ¶æ€: ${tracks[0].readyState}`);
                tracks.forEach(track => track.stop());
            } catch (error) {
                alert(`éº¦å…‹é£æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        // æš´éœ²ä¸€äº›å‡½æ•°ç»™å…¨å±€ä½œç”¨åŸŸï¼Œç”¨äºè°ƒè¯•
        window.iOSMediaSession = iOSMediaSession;
        window.iOSRecorder = iOSRecorder;
        window.isIOS = isIOS;
    </script>
</body>

</html>