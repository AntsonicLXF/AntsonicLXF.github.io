<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ä¸Šä¼ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .error-container {
            display: none;
            text-align: center;
        }

        .error-content {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 60px 40px;
            max-width: 500px;
            width: 100%;
        }

        .error-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .error-text {
            color: #2d3436;
            font-size: 1.2em;
            line-height: 1.5;
        }

        .main-container {
            display: none;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #2d3436;
            margin-bottom: 10px;
            font-size: 1.8em;
        }

        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-section {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .upload-box {
            width: 200px;
            height: 200px;
            border: 3px dashed #6c5ce7;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            position: relative;
        }

        .upload-box:hover {
            background: #edf2f7;
            transform: translateY(-3px);
            border-color: #a29bfe;
        }

        .upload-box .icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .upload-box p {
            font-weight: bold;
            color: #2d3436;
            margin: 5px 0;
        }

        .upload-box small {
            color: #636e72;
            font-size: 0.85em;
        }

        /* ç§»åŠ¨ç«¯æŒ‰é’® - é‡æ–°è®¾è®¡ */
        .mobile-action-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 1em;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3);
        }

        .mobile-action-btn.photo {
            background: linear-gradient(135deg, #1e90ff, #3742fa);
        }

        /* ä¸Šä¼ æŒ‰é’® */
        .generate-btn {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px auto;
            display: block;
            width: 250px;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
        }

        .generate-btn:disabled {
            background: #b2bec3;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* å…è´£å£°æ˜åŒºåŸŸ */
        .disclaimer-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            text-align: left;
            font-size: 0.9em;
            line-height: 1.6;
            color: #6c757d;
        }

        .disclaimer-box h4 {
            color: #dc3545;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .disclaimer-box ul {
            padding-left: 20px;
        }

        .disclaimer-box li {
            margin-bottom: 8px;
        }

        /* æˆåŠŸæç¤º */
        .success-message {
            background: #d4edda;
            color: #155724;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #c3e6cb;
            display: none;
        }

        /* é¢„è§ˆåŒºåŸŸ */
        .upload-preview {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
        }

        /* æ‘„åƒå¤´æ¨¡æ€æ¡† */
        .camera-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .camera-modal video {
            width: 100%;
            max-width: 500px;
            background: #000;
            border-radius: 10px 10px 0 0;
        }

        .camera-controls {
            width: 100%;
            max-width: 500px;
            background: #333;
            padding: 20px;
            border-radius: 0 0 10px 10px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .camera-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .capture-btn {
            background: #ff4757;
            color: white;
            font-weight: bold;
        }

        .cancel-btn {
            background: #747d8c;
            color: white;
        }

        .switch-camera-btn {
            background: #3742fa;
            color: white;
        }

        /* ç§»åŠ¨ç«¯é¢„è§ˆå®¹å™¨ */
        .mobile-preview-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            padding: 10px;
            text-align: center;
        }

        .mobile-preview-container img {
            max-width: 80px;
            max-height: 80px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .mobile-preview-container .preview-text {
            font-size: 0.9em;
            color: #2d3436;
            margin-bottom: 10px;
        }

        /* ç§»åŠ¨ç«¯æ“ä½œæŒ‰é’®å®¹å™¨ */
        .mobile-action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .mobile-action-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            min-width: 80px;
        }

        .mobile-confirm-btn {
            background: #00b894;
            color: white;
        }

        .mobile-retry-btn {
            background: #ff9f43;
            color: white;
        }

        /* ç§»åŠ¨ç«¯é€‚é… - ä¿®æ”¹éŸ³é¢‘å’Œå›¾ç‰‡ä¸Šä¼ åŒºåŸŸ */
        @media (max-width: 768px) {
            .main-container {
                padding: 20px;
            }

            .upload-section {
                flex-direction: column;
                align-items: center;
            }

            .upload-box {
                width: 100%;
                max-width: 250px;
                height: 180px;
            }

            .generate-btn {
                width: 100%;
                max-width: 250px;
            }

            .camera-modal video {
                max-width: 100%;
            }

            .camera-controls {
                max-width: 100%;
                flex-direction: column;
                gap: 10px;
            }

            .camera-btn {
                width: 100%;
            }

            /* ç§»åŠ¨ç«¯éŸ³é¢‘ä¸Šä¼ åŒºåŸŸç‰¹æ®Šæ ·å¼ */
            #audioUploadBox {
                cursor: default;
            }

            #audioUploadBox .upload-placeholder {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                width: 100%;
            }

            /* éšè—éŸ³é¢‘ä¸Šä¼ åŒºåŸŸåŸæ¥çš„å›¾æ ‡å’Œæ–‡å­— */
            #audioUploadBox .upload-placeholder .icon,
            #audioUploadBox .upload-placeholder p:not(.record-text),
            #audioUploadBox .upload-placeholder small {
                display: none !important;
            }

            /* æ”¾å¤§éº¦å…‹é£å›¾æ ‡å¹¶è°ƒæ•´ä½ç½® */
            #audioUploadBox .mic-icon-large {
                font-size: 3em !important;
                margin-bottom: 15px;
                display: block !important;
            }

            /* å½•åˆ¶æŒ‰é’®æ ·å¼ - è¿™æ˜¯çº¢è‰²å½•éŸ³æŒ‰é’® */
            #audioUploadBox .mobile-action-btn {
                margin-top: 0;
                padding: 10px 20px;
                font-size: 1em;
                font-weight: bold;
                border-radius: 25px;
                width: 80%;
                max-width: 180px;
                justify-content: center;
                background: linear-gradient(135deg, #ff4757, #ff3838);
                box-shadow: 0 4px 12px rgba(255, 71, 87, 0.4);
            }

            /* å½•åˆ¶æŒ‰é’®æ–‡å­—æ ·å¼ */
            #audioUploadBox .record-text {
                color: white;
                font-size: 1em;
                font-weight: bold;
                margin: 0;
            }

            /* ç§»åŠ¨ç«¯å›¾ç‰‡ä¸Šä¼ åŒºåŸŸç‰¹æ®Šæ ·å¼ */
            #imageUploadBox {
                cursor: default;
            }

            #imageUploadBox .upload-placeholder {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                width: 100%;
            }

            /* éšè—å›¾ç‰‡ä¸Šä¼ åŒºåŸŸåŸæ¥çš„å›¾æ ‡å’Œæ–‡å­— */
            #imageUploadBox .upload-placeholder .icon,
            #imageUploadBox .upload-placeholder p:not(.camera-text),
            #imageUploadBox .upload-placeholder small {
                display: none !important;
            }

            /* æ”¾å¤§ç›¸æœºå›¾æ ‡å¹¶è°ƒæ•´ä½ç½® */
            #imageUploadBox .camera-icon-large {
                font-size: 3em !important;
                margin-bottom: 15px;
                display: block !important;
            }

            /* å›¾ç‰‡ä¸Šä¼ åŒºåŸŸæ‹ç…§æŒ‰é’® - ä¸å½•éŸ³æŒ‰é’®å¤§å°ä¸€è‡´ */
            #imageUploadBox .mobile-action-btn.photo {
                margin-top: 0;
                padding: 10px 20px;
                font-size: 1em;
                font-weight: bold;
                border-radius: 25px;
                width: 80%;
                max-width: 180px;
                justify-content: center;
                box-shadow: 0 4px 12px rgba(30, 144, 255, 0.4);
                background: linear-gradient(135deg, #1e90ff, #3742fa);
            }

            /* æ‹ç…§æŒ‰é’®æ–‡å­—æ ·å¼ */
            #imageUploadBox .camera-text {
                color: white;
                font-size: 1em;
                font-weight: bold;
                margin: 0;
            }
        }

        /* æ¡Œé¢ç«¯ä¿æŒåŸæœ‰æ ·å¼ï¼Œä½†éšè—ç§»åŠ¨ç«¯æŒ‰é’® */
        @media (min-width: 769px) {
            .mobile-action-btn {
                display: none;
            }

            .mobile-preview-container {
                display: none !important;
            }

            .mobile-action-buttons {
                display: none !important;
            }

            /* æ¡Œé¢ç«¯æ¢å¤éŸ³é¢‘ä¸Šä¼ åŒºåŸŸåŸå§‹æ ·å¼ */
            #audioUploadBox .upload-placeholder {
                display: flex !important;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            #audioUploadBox .upload-placeholder .icon,
            #audioUploadBox .upload-placeholder p,
            #audioUploadBox .upload-placeholder small {
                display: block !important;
            }

            #audioUploadBox .mic-icon-large {
                display: none !important;
            }

            /* æ¡Œé¢ç«¯æ¢å¤å›¾ç‰‡ä¸Šä¼ åŒºåŸŸåŸå§‹æ ·å¼ */
            #imageUploadBox .upload-placeholder {
                display: flex !important;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            #imageUploadBox .upload-placeholder .icon,
            #imageUploadBox .upload-placeholder p,
            #imageUploadBox .upload-placeholder small {
                display: block !important;
            }

            #imageUploadBox .camera-icon-large {
                display: none !important;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>
</head>

<body>
    <!-- é”™è¯¯å®¹å™¨ï¼ˆéªŒè¯å¤±è´¥æ—¶æ˜¾ç¤ºï¼‰ -->
    <div class="error-container" id="errorContainer">
        <div class="error-content">
            <div class="error-icon">âš ï¸</div>
            <div class="error-text">
                <p>æ— æ•ˆçš„è®¿é—®é“¾æ¥</p>
                <p style="margin-top: 10px;">è¯·é€šè¿‡æ­£ç¡®çš„äºŒç»´ç è¿›å…¥æœ¬é¡µé¢</p>
            </div>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ï¼ˆéªŒè¯æˆåŠŸæ—¶æ˜¾ç¤ºï¼‰ -->
    <div class="main-container" id="mainContainer">
        <h1>â¬†ï¸ è¯·ä¸Šä¼ ä½ çš„å£°éŸ³å’Œå›¾ç‰‡</h1>

        <div class="upload-section" id="uploadSection">
            <!-- éŸ³é¢‘ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-box" id="audioUploadBox">
                <input type="file" id="audioInput" accept="audio/*" hidden>
                <div class="upload-placeholder">
                    <!-- æ¡Œé¢ç«¯æ˜¾ç¤ºçš„åŸå§‹å†…å®¹ -->
                    <span class="icon">ğŸµ</span>
                    <p><strong>ç‚¹å‡»ä¸Šä¼ å£°éŸ³</strong></p>
                    <small>æ”¯æŒ MP3, WAV, M4A ç­‰æ ¼å¼</small>

                    <!-- ç§»åŠ¨ç«¯æ˜¾ç¤ºçš„éº¦å…‹é£å›¾æ ‡ -->
                    <span class="mic-icon-large" style="display: none;">ğŸ¤</span>
                </div>
                <div class="upload-preview" id="audioPreview">
                    <span class="icon">âœ…</span>
                    <p>å£°éŸ³æ–‡ä»¶å·²å‡†å¤‡å°±ç»ª</p>
                    <small id="audioFileName"></small>
                </div>
                <!-- ç§»åŠ¨ç«¯é¢„è§ˆå®¹å™¨ -->
                <div class="mobile-preview-container" id="audioMobilePreview">
                    <span class="icon" style="font-size: 2.5em;">ğŸ¤</span>
                    <div class="preview-text">å·²å½•åˆ¶éŸ³é¢‘</div>
                    <div class="mobile-action-buttons">
                        <button class="mobile-retry-btn" onclick="retryAudioRecording()">é‡æ–°å½•åˆ¶</button>
                        <button class="mobile-confirm-btn" onclick="confirmAudioRecording()">ä½¿ç”¨æ­¤éŸ³é¢‘</button>
                    </div>
                </div>
            </div>

            <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-box" id="imageUploadBox">
                <input type="file" id="imageInput" accept="image/*" hidden>
                <div class="upload-placeholder">
                    <!-- æ¡Œé¢ç«¯æ˜¾ç¤ºçš„åŸå§‹å†…å®¹ -->
                    <span class="icon">ğŸ–¼ï¸</span>
                    <p><strong>ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</strong></p>
                    <small>æ”¯æŒ JPG, PNG, GIF ç­‰æ ¼å¼</small>

                    <!-- ç§»åŠ¨ç«¯æ˜¾ç¤ºçš„ç›¸æœºå›¾æ ‡ -->
                    <span class="camera-icon-large" style="display: none;">ğŸ“·</span>
                </div>
                <div class="upload-preview" id="imagePreview">
                    <img id="imageThumbnail" src="" alt="é¢„è§ˆå›¾"
                        style="max-width: 100px; max-height: 100px; border-radius: 8px; margin-bottom: 10px;">
                    <p>èƒŒæ™¯å›¾ç‰‡å·²å‡†å¤‡å°±ç»ª</p>
                </div>
                <!-- ç§»åŠ¨ç«¯é¢„è§ˆå®¹å™¨ -->
                <div class="mobile-preview-container" id="imageMobilePreview">
                    <img id="imageMobileThumbnail" src="" alt="é¢„è§ˆå›¾"
                        style="max-width: 80px; max-height: 80px; border-radius: 8px; margin-bottom: 10px;">
                    <div class="preview-text">å·²æ‹æ‘„ç…§ç‰‡</div>
                    <div class="mobile-action-buttons">
                        <button class="mobile-retry-btn" onclick="retryPhotoCapture()">é‡æ–°æ‹æ‘„</button>
                        <button class="mobile-confirm-btn" onclick="confirmPhotoCapture()">ä½¿ç”¨æ­¤ç…§ç‰‡</button>
                    </div>
                </div>
            </div>
        </div>

        <button id="uploadBtn" class="generate-btn" disabled>
            è¯·å…ˆé€‰æ‹©å£°éŸ³æˆ–å›¾ç‰‡
        </button>

        <div class="disclaimer-box">
            <h4>ğŸ“œ ç”¨æˆ·è¡Œä¸ºè§„èŒƒä¸å…è´£å£°æ˜</h4>
            <ul>
                <li>æ‚¨æ‰¿è¯ºä¸Šä¼ çš„å†…å®¹å‡ä¸ºåˆæ³•ã€æ­£é¢çš„ä¸ªäººè¡¨è¾¾ã€‚</li>
                <li><strong>ä¸¥ç¦ä¸Šä¼ ä»»ä½•</strong>æ¶‰åŠææ€–ã€å¨èƒã€å‹’ç´¢ã€è¯½è°¤ã€éªšæ‰°ç­‰è¿æ³•æˆ–ä¾µå®³ä»–äººæƒç›Šçš„éŸ³é¢‘å†…å®¹ã€‚</li>
                <li><strong>ä¸¥ç¦ä¸Šä¼ ä»»ä½•</strong>è‰²æƒ…ã€æš´åŠ›ã€è¡€è…¥ã€ä»¤äººæåº¦ä¸é€‚æˆ–è¿åå…¬åºè‰¯ä¿—çš„å›¾ç‰‡å†…å®¹ã€‚</li>
                <li>æˆ‘ä»¬æœ‰æƒå¯¹ä¸Šä¼ å†…å®¹è¿›è¡Œå®¡æŸ¥ã€‚ä¸€ç»å‘ç°è¿è§„å†…å®¹ï¼Œ<strong>å°†ç«‹å³åˆ é™¤ç›¸å…³æ–‡ä»¶ï¼Œå¹¶æ°¸ä¹…ç»ˆæ­¢è¯¥ç”¨æˆ·çš„æ‰€æœ‰æœåŠ¡ï¼Œä¸”ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚</strong></li>
                <li>æ‚¨åº”å•ç‹¬å¯¹ä¸Šä¼ å†…å®¹è´Ÿè´£ã€‚å› å†…å®¹è¿è§„å¼•å‘çš„ä»»ä½•è´£ä»»ï¼Œå‡ç”±æ‚¨è‡ªè¡Œæ‰¿æ‹…ã€‚</li>
            </ul>
        </div>

        <!-- æˆåŠŸæç¤ºåŒºåŸŸ -->
        <div id="successMessage" class="success-message">
            <h3>âœ… ä¸Šä¼ æˆåŠŸï¼</h3>
            <p id="successDetails">ä½ çš„æ–‡ä»¶å·²ä¿å­˜ã€‚</p>
            <p style="margin-top: 10px; font-size: 0.9em;">é¡µé¢å°†åœ¨1.5ç§’ååˆ·æ–°...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ===== é…ç½®åŒºåŸŸ =====
        const SUPABASE_URL = 'https://ysuzytkxvcoorpvsobqd.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzdXp5dGt4dmNvb3JwdnNvYnFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyOTMxMjUsImV4cCI6MjA3OTg2OTEyNX0.mcHqTQmeBFpW8NCCDCAauWAkjNvzOLiGQN5WAhrNC_A';

        // ä»URLå‚æ•°è·å–ç®¡ç†å‘˜åˆ†é…å¥½çš„ç”¨æˆ·ID
        const urlParams = new URLSearchParams(window.location.search);
        const assignedUserId = urlParams.get('user');

        // ===== æ›¿æ¢åŸæ¥çš„æ•´ä¸ª JavaScript éƒ¨åˆ†ï¼ˆä»ç¬¬ 600 è¡Œå¼€å§‹ï¼‰=====



        // DOM å…ƒç´ 
        const errorContainer = document.getElementById('errorContainer');
        const mainContainer = document.getElementById('mainContainer');
        const audioInput = document.getElementById('audioInput');
        const imageInput = document.getElementById('imageInput');
        const audioUploadBox = document.getElementById('audioUploadBox');
        const imageUploadBox = document.getElementById('imageUploadBox');
        const audioPreview = document.getElementById('audioPreview');
        const imagePreview = document.getElementById('imagePreview');
        const uploadBtn = document.getElementById('uploadBtn');
        const successMessage = document.getElementById('successMessage');
        const successDetails = document.getElementById('successDetails');
        const audioMobilePreview = document.getElementById('audioMobilePreview');
        const imageMobilePreview = document.getElementById('imageMobilePreview');
        const imageMobileThumbnail = document.getElementById('imageMobileThumbnail');

        // çŠ¶æ€å˜é‡
        let selectedAudio = null;
        let selectedImage = null;
        let supabaseClient = null;

        // === å½•éŸ³åŠŸèƒ½ç›¸å…³å˜é‡ ===
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordTimeout = null;
        const MAX_RECORD_TIME = 60000;
        let currentRecordedAudioBlob = null;
        let currentAudioStream = null;

        // === æ‹ç…§åŠŸèƒ½ç›¸å…³å˜é‡ ===
        let cameraStream = null;
        let currentCameraMode = 'environment';
        let currentCapturedPhotoBlob = null;

        // ==================== iOS Safari æ£€æµ‹å‡½æ•° ====================
        function isIOS() {
            const ua = navigator.userAgent;
            return /iPhone|iPad|iPod/i.test(ua) &&
                /Safari/i.test(ua) &&
                !/CriOS/i.test(ua) &&
                !/FxiOS/i.test(ua);
        }

        // ==================== iOS åª’ä½“ä¼šè¯ç®¡ç†å™¨ ====================
        const iOSMediaSession = {
            isActive: false,
            hasPermission: false,
            isPageActive: true,

            init() {
                if (!isIOS()) return;

                console.log('ğŸ“± åˆå§‹åŒ–iOSåª’ä½“ä¼šè¯ç®¡ç†å™¨');

                // è·Ÿè¸ªé¡µé¢å¯è§æ€§
                document.addEventListener('visibilitychange', this.handleVisibilityChange.bind(this));

                // è·Ÿè¸ªé¡µé¢å¸è½½
                window.addEventListener('pagehide', this.cleanup.bind(this));
                window.addEventListener('beforeunload', this.cleanup.bind(this));

                // åœ¨é¡µé¢æ˜¾ç¤ºæ—¶é‡ç½®çŠ¶æ€
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.isPageActive = false;
                        this.cleanup();
                    } else {
                        this.isPageActive = true;
                        // é¡µé¢é‡æ–°æ˜¾ç¤ºæ—¶ï¼Œé‡ç½®å½•éŸ³æŒ‰é’®çŠ¶æ€
                        const recordBtn = document.querySelector('#audioUploadBox .mobile-action-btn .record-text');
                        if (recordBtn && recordBtn.textContent.includes('å½•éŸ³ä¸­')) {
                            recordBtn.textContent = 'å½•åˆ¶å£°éŸ³';
                            isRecording = false;
                        }
                    }
                });
            },

            handleVisibilityChange() {
                if (document.hidden) {
                    console.log('ğŸ“± é¡µé¢éšè—ï¼Œæ¸…ç†åª’ä½“èµ„æº');
                    this.cleanup();
                } else {
                    console.log('ğŸ“± é¡µé¢æ˜¾ç¤ºï¼Œé‡ç½®çŠ¶æ€');
                    // é‡ç½®å½•éŸ³çŠ¶æ€
                    if (isRecording && mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                        isRecording = false;
                    }
                }
            },

            async requestPermission() {
                if (!isIOS()) return true;

                try {
                    // iOS Safari éœ€è¦æ˜ç¡®çš„ç”¨æˆ·äº¤äº’æ‰èƒ½è¯·æ±‚æƒé™
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    const audioContext = new AudioContext();

                    if (audioContext.state === 'suspended') {
                        console.log('ğŸ“± éŸ³é¢‘ä¸Šä¸‹æ–‡è¢«æŒ‚èµ·ï¼Œç­‰å¾…ç”¨æˆ·äº¤äº’');
                    }

                    audioContext.close();
                    this.hasPermission = true;
                    return true;
                } catch (error) {
                    console.warn('iOSæƒé™è¯·æ±‚å¤±è´¥:', error);
                    return false;
                }
            },

            cleanup() {
                if (!isIOS()) return;

                console.log('ğŸ§¹ iOSåª’ä½“ä¼šè¯æ¸…ç†');

                // æ¸…ç†åª’ä½“å½•åˆ¶å™¨
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    try {
                        mediaRecorder.stop();
                        console.log('âœ… åœæ­¢åª’ä½“å½•åˆ¶å™¨');
                    } catch (e) {
                        console.warn('åœæ­¢åª’ä½“å½•åˆ¶å™¨å¤±è´¥:', e);
                    }
                    mediaRecorder = null;
                }

                // æ¸…ç†éŸ³é¢‘æµ
                if (currentAudioStream) {
                    currentAudioStream.getTracks().forEach(track => {
                        track.stop();
                        console.log('âœ… åœæ­¢éŸ³é¢‘è½¨é“');
                    });
                    currentAudioStream = null;
                }

                // æ¸…ç†æ‘„åƒå¤´æµ
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => {
                        track.stop();
                        console.log('âœ… åœæ­¢æ‘„åƒå¤´è½¨é“');
                    });
                    cameraStream = null;
                }

                // æ¸…ç†è¶…æ—¶
                if (recordTimeout) {
                    clearTimeout(recordTimeout);
                    recordTimeout = null;
                }

                // é‡ç½®çŠ¶æ€
                isRecording = false;
                audioChunks = [];
                this.isActive = false;

                // å¼ºåˆ¶é‡Šæ”¾å†…å­˜ï¼ˆé’ˆå¯¹iOSçš„ä¼˜åŒ–ï¼‰
                if (isIOS()) {
                    setTimeout(() => {
                        try {
                            // åˆ›å»ºä¸€ä¸ªå¤§çš„ä¸´æ—¶å¯¹è±¡æ¥è§¦å‘åƒåœ¾å›æ”¶
                            const temp = new ArrayBuffer(1024 * 1024 * 2);
                            setTimeout(() => {
                                temp = null;
                            }, 100);
                        } catch (e) {
                            // å¿½ç•¥å†…å­˜é”™è¯¯
                        }
                    }, 500);
                }
            },

            // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¼€å§‹å½•éŸ³
            async canStartRecording() {
                if (!isIOS()) return true;

                // å¦‚æœå½“å‰æœ‰æ´»åŠ¨ä¼šè¯ï¼Œå…ˆæ¸…ç†
                if (this.isActive) {
                    this.cleanup();
                    // ç»™iOSä¸€ç‚¹æ—¶é—´æ¸…ç†èµ„æº
                    await new Promise(resolve => setTimeout(resolve, 300));
                }

                // æ£€æŸ¥é¡µé¢æ˜¯å¦æ´»è·ƒ
                if (!this.isPageActive || document.hidden) {
                    console.warn('ğŸ“± é¡µé¢ä¸æ´»è·ƒï¼Œä¸èƒ½å¼€å§‹å½•éŸ³');
                    return false;
                }

                return true;
            }
        };

        // ==================== é‡æ„åçš„iOSéŸ³é¢‘å½•åˆ¶ç®¡ç†å™¨ ====================
        class iOSAudioRecorder {
            constructor() {
                this.stream = null;
                this.recorder = null;
                this.chunks = [];
                this.isRecording = false;
                this.retryCount = 0;
                this.maxRetries = 2;
            }

            // æ£€æŸ¥å¹¶ä¿®å¤iOSåª’ä½“çŠ¶æ€
            async fixiOSMediaState() {
                console.log('ğŸ”§ æ£€æŸ¥å¹¶ä¿®å¤iOSåª’ä½“çŠ¶æ€');

                try {
                    // 1. å…ˆæšä¸¾æ‰€æœ‰è®¾å¤‡ï¼Œçœ‹éº¦å…‹é£æ˜¯å¦å­˜åœ¨
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const audioInputs = devices.filter(d => d.kind === 'audioinput');
                    console.log('ğŸ¤ å¯ç”¨çš„éŸ³é¢‘è¾“å…¥è®¾å¤‡:', audioInputs.map(d => d.label || 'æœªçŸ¥è®¾å¤‡'));

                    // 2. å¦‚æœæœ‰æ­£åœ¨ä½¿ç”¨çš„åª’ä½“æµï¼Œå…ˆåœæ­¢å®ƒä»¬
                    if (this.stream) {
                        console.log('ğŸ›‘ åœæ­¢ç°æœ‰åª’ä½“æµ');
                        this.stream.getTracks().forEach(track => {
                            track.stop();
                            track.enabled = false;
                        });
                        this.stream = null;
                    }

                    // 3. ç­‰å¾…ä¸€å°æ®µæ—¶é—´è®©ç³»ç»Ÿæ¸…ç†
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // 4. å°è¯•è·å–ä¸€ä¸ªæµ‹è¯•æµï¼ˆä¸ä¿å­˜ï¼‰
                    console.log('ğŸ§ª å°è¯•è·å–æµ‹è¯•æµ...');
                    const testStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false,
                            sampleRate: 44100,
                            channelCount: 1
                        }
                    });

                    // 5. ç«‹å³åœæ­¢æµ‹è¯•æµ
                    console.log('âœ… æµ‹è¯•æµè·å–æˆåŠŸï¼Œç«‹å³åœæ­¢');
                    testStream.getTracks().forEach(track => {
                        track.stop();
                        track.enabled = false;
                    });

                    // 6. å†æ¬¡ç­‰å¾…æ¸…ç†
                    await new Promise(resolve => setTimeout(resolve, 300));

                    console.log('ğŸ”„ iOSåª’ä½“çŠ¶æ€ä¿®å¤å®Œæˆ');
                    return true;

                } catch (error) {
                    console.warn('iOSåª’ä½“çŠ¶æ€ä¿®å¤å¤±è´¥ï¼ˆå¯èƒ½ä¸éœ€è¦ä¿®å¤ï¼‰:', error.message);
                    return true; // å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­ï¼Œå¯èƒ½çŠ¶æ€æœ¬æ¥å°±æ²¡é—®é¢˜
                }
            }

            async start() {
                if (!isIOS()) return false;

                console.log('ğŸ¤ å¼€å§‹iOSå½•éŸ³æµç¨‹ï¼Œé‡è¯•æ¬¡æ•°:', this.retryCount);

                // å¦‚æœå·²ç»é‡è¯•è¿‡ï¼Œå…ˆä¿®å¤åª’ä½“çŠ¶æ€
                if (this.retryCount > 0) {
                    console.log('ğŸ”„ ç¬¬', this.retryCount, 'æ¬¡é‡è¯•ï¼Œå…ˆä¿®å¤åª’ä½“çŠ¶æ€');
                    await this.fixiOSMediaState();
                }

                try {
                    // æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§ä¼šè¯
                    this.cleanup();
                    await new Promise(resolve => setTimeout(resolve, 300));

                    console.log('ğŸ“± è¯·æ±‚éº¦å…‹é£æƒé™...');

                    // ä½¿ç”¨ç®€åŒ–çš„éŸ³é¢‘é…ç½®
                    const constraints = {
                        audio: {
                            channelCount: 1,
                            sampleRate: 44100,
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false,
                            // iOS Safari éœ€è¦æ˜ç¡®çš„è®¾å¤‡IDï¼ˆå¯é€‰ï¼‰
                            deviceId: { ideal: 'default' }
                        }
                    };

                    // ç›´æ¥è·å–æµï¼Œä¸å°è¯•ä¸åŒæ ¼å¼
                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    console.log('âœ… è·å¾—éº¦å…‹é£æƒé™');

                    // æ£€æŸ¥è½¨é“çŠ¶æ€
                    const audioTracks = this.stream.getAudioTracks();
                    console.log('ğŸ“Š éŸ³é¢‘è½¨é“çŠ¶æ€:', audioTracks.map(t => ({
                        kind: t.kind,
                        readyState: t.readyState,
                        enabled: t.enabled,
                        muted: t.muted,
                        label: t.label
                    })));

                    if (audioTracks.length === 0 || audioTracks[0].readyState !== 'live') {
                        console.error('âŒ éŸ³é¢‘è½¨é“ä¸å¯ç”¨');
                        throw new Error('éŸ³é¢‘è½¨é“ä¸å¯ç”¨');
                    }

                    // ç¡®ä¿è½¨é“å·²å¯ç”¨
                    audioTracks[0].enabled = true;

                    // åˆ›å»ºåª’ä½“å½•åˆ¶å™¨
                    // iOS Safari éœ€è¦ç‰¹å®šçš„MIMEç±»å‹
                    let mimeType = '';
                    const possibleTypes = [
                        'audio/mp4',
                        'audio/aac',
                        'audio/mpeg',
                        'audio/webm',
                        'audio/ogg'
                    ];

                    for (const type of possibleTypes) {
                        if (MediaRecorder.isTypeSupported(type)) {
                            mimeType = type;
                            console.log('âœ… æ”¯æŒMIMEç±»å‹:', type);
                            break;
                        }
                    }

                    const options = mimeType ? { mimeType, audioBitsPerSecond: 64000 } : { audioBitsPerSecond: 64000 };
                    this.recorder = new MediaRecorder(this.stream, options);
                    this.chunks = [];

                    // è®¾ç½®äº‹ä»¶å¤„ç†å™¨
                    this.recorder.ondataavailable = (event) => {
                        if (event.data && event.data.size > 0) {
                            this.chunks.push(event.data);
                            console.log('ğŸ“¦ æ”¶åˆ°éŸ³é¢‘æ•°æ®å—:', event.data.size, 'bytes');
                        }
                    };

                    this.recorder.onstop = () => {
                        console.log('â¹ï¸ å½•éŸ³åœæ­¢ï¼Œæ•°æ®å—æ•°é‡:', this.chunks.length);

                        if (this.chunks.length === 0) {
                            console.error('âŒ æ²¡æœ‰å½•åˆ°éŸ³é¢‘æ•°æ®');
                            this.handleRecordingFailure();
                            return;
                        }

                        const audioBlob = new Blob(this.chunks, {
                            type: this.recorder.mimeType || 'audio/mp4'
                        });

                        console.log('ğŸµ å½•éŸ³å®Œæˆï¼Œå¤§å°:', audioBlob.size, 'bytes');

                        if (audioBlob.size === 0) {
                            console.error('âŒ å½•éŸ³æ•°æ®ä¸ºç©º');
                            this.handleRecordingFailure();
                            return;
                        }

                        // ä¿å­˜å½•éŸ³
                        currentRecordedAudioBlob = audioBlob;
                        showAudioMobilePreview();

                        // é‡ç½®é‡è¯•è®¡æ•°
                        this.retryCount = 0;

                        // å»¶è¿Ÿæ¸…ç†æµ
                        setTimeout(() => {
                            this.cleanupStream();
                        }, 500);
                    };

                    this.recorder.onerror = (event) => {
                        console.error('ğŸ¤ å½•éŸ³é”™è¯¯:', event.error);
                        this.handleRecordingError(event.error);
                    };

                    // å¼€å§‹å½•éŸ³
                    this.recorder.start(250); // æ¯250msæ”¶é›†ä¸€æ¬¡æ•°æ®
                    this.isRecording = true;

                    console.log('âœ… iOSå½•éŸ³å¼€å§‹æˆåŠŸï¼ŒMIMEç±»å‹:', this.recorder.mimeType);
                    return true;

                } catch (error) {
                    console.error('ğŸ¤ iOSå½•éŸ³å¯åŠ¨å¤±è´¥:', error);
                    this.handleMediaError(error);
                    return false;
                }
            }

            handleRecordingFailure() {
                this.retryCount++;
                if (this.retryCount <= this.maxRetries) {
                    console.log('ğŸ”„ å½•éŸ³å¤±è´¥ï¼Œå°è¯•é‡è¯•', this.retryCount, '/', this.maxRetries);
                    setTimeout(() => {
                        this.start().then(success => {
                            if (!success) {
                                alert('å½•éŸ³å¤±è´¥ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£æƒé™å¹¶é‡è¯•ã€‚');
                            }
                        });
                    }, 1000);
                } else {
                    alert('å½•éŸ³å¤±è´¥ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£æƒé™å¹¶é‡è¯•ã€‚');
                    this.cleanup();
                }
            }

            handleRecordingError(error) {
                console.error('å½•éŸ³è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                this.isRecording = false;

                this.retryCount++;
                if (this.retryCount <= this.maxRetries) {
                    console.log('ğŸ”„ å‘ç”Ÿé”™è¯¯ï¼Œå°è¯•é‡è¯•', this.retryCount, '/', this.maxRetries);
                    setTimeout(() => {
                        this.start().then(success => {
                            if (!success) {
                                alert('å½•éŸ³å‡ºé”™ï¼Œè¯·é‡è¯•ã€‚é”™è¯¯: ' + error.message);
                            }
                        });
                    }, 1000);
                } else {
                    alert('å½•éŸ³å‡ºé”™: ' + error.message);
                    this.cleanup();
                }
            }

            handleMediaError(error) {
                this.cleanup();

                let errorMessage = 'æ— æ³•è®¿é—®éº¦å…‹é£: ';
                switch (error.name) {
                    case 'NotAllowedError':
                        errorMessage = 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ã€‚è¯·å‰å¾€ã€Œè®¾ç½®ã€>ã€ŒSafariæµè§ˆå™¨ã€>ã€Œéº¦å…‹é£ã€ï¼Œå…è®¸æ­¤ç½‘ç«™ä½¿ç”¨éº¦å…‹é£ã€‚';
                        break;
                    case 'NotFoundError':
                        errorMessage = 'æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡ã€‚è¯·æ£€æŸ¥è®¾å¤‡éº¦å…‹é£æ˜¯å¦æ­£å¸¸ã€‚';
                        break;
                    case 'NotReadableError':
                        errorMessage = 'éº¦å…‹é£æ­£è¢«å…¶ä»–åº”ç”¨å ç”¨ã€‚è¯·å…³é—­å…¶ä»–ä½¿ç”¨éº¦å…‹é£çš„åº”ç”¨åé‡è¯•ã€‚';
                        break;
                    case 'AbortError':
                        errorMessage = 'å½•éŸ³è¢«ä¸­æ–­ã€‚è¯·ä¿æŒåœ¨å½“å‰é¡µé¢å®Œæˆå½•éŸ³ã€‚';
                        break;
                    default:
                        errorMessage += error.message;
                }

                alert(errorMessage);

                // å¦‚æœæ˜¯æƒé™é—®é¢˜ï¼Œç»™ç”¨æˆ·æä¾›ä¿®å¤å»ºè®®
                if (error.name === 'NotAllowedError') {
                    setTimeout(() => {
                        if (confirm('æ˜¯å¦è¦å‰å¾€Safariè®¾ç½®é¡µé¢è°ƒæ•´éº¦å…‹é£æƒé™ï¼Ÿ')) {
                            // åœ¨iOS Safariä¸­æ— æ³•ç›´æ¥è·³è½¬åˆ°è®¾ç½®ï¼Œåªèƒ½æç¤º
                            alert('è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š\n1. ç‚¹å‡»åˆ†äº«æŒ‰é’®\n2. é€‰æ‹©"æ·»åŠ åˆ°ä¸»å±å¹•"\n3. ä»ä¸»å±å¹•é‡æ–°æ‰“å¼€åº”ç”¨\n4. å†æ¬¡å°è¯•å½•éŸ³');
                        }
                    }, 1000);
                }
            }

            stop() {
                if (this.recorder && this.recorder.state === 'recording') {
                    this.recorder.stop();
                    this.isRecording = false;
                }
            }

            cleanup() {
                console.log('ğŸ§¹ æ¸…ç†iOSå½•éŸ³å™¨èµ„æº');

                if (this.recorder) {
                    if (this.recorder.state === 'recording') {
                        try {
                            this.recorder.stop();
                            console.log('âœ… åœæ­¢å½•éŸ³å™¨');
                        } catch (e) {
                            console.warn('åœæ­¢å½•éŸ³å™¨å¤±è´¥:', e);
                        }
                    }
                    this.recorder = null;
                }

                if (this.stream) {
                    const tracks = this.stream.getTracks();
                    console.log('ğŸ“Š æ¸…ç†è½¨é“:', tracks.map(t => t.kind));

                    tracks.forEach(track => {
                        try {
                            // å…ˆç¦ç”¨è½¨é“
                            track.enabled = false;
                            // åœæ­¢è½¨é“
                            track.stop();
                            console.log('âœ… åœæ­¢è½¨é“:', track.kind);
                        } catch (e) {
                            console.warn('åœæ­¢è½¨é“å¤±è´¥:', e);
                        }
                    });
                    this.stream = null;
                    currentAudioStream = null;
                }

                this.chunks = [];
                this.isRecording = false;

                // iOS Safariç‰¹æ®Šæ¸…ç†
                if (isIOS()) {
                    // å¼ºåˆ¶è§¦å‘åƒåœ¾å›æ”¶ï¼ˆé€šè¿‡åˆ›å»ºå’Œé‡Šæ”¾å¤§å¯¹è±¡ï¼‰
                    setTimeout(() => {
                        try {
                            const temp = new ArrayBuffer(1024 * 1024 * 1); // 1MB
                            setTimeout(() => {
                                temp = null;
                            }, 100);
                        } catch (e) {
                            // å¿½ç•¥å†…å­˜é”™è¯¯
                        }
                    }, 200);
                }
            }

            cleanupStream() {
                setTimeout(() => {
                    if (this.stream) {
                        this.stream.getTracks().forEach(track => {
                            track.stop();
                            track.enabled = false;
                        });
                        this.stream = null;
                        currentAudioStream = null;
                    }
                }, 500);
            }
        }

        // åˆ›å»ºiOSå½•éŸ³å™¨å®ä¾‹
        const iOSRecorder = new iOSAudioRecorder();

        // ==================== éŸ³é¢‘è½¬æ¢å‡½æ•° ====================
        async function convertAudioToMP3(audioFile) {
            console.log('ğŸµ å¼€å§‹éŸ³é¢‘è½¬æ¢:', audioFile.name);

            // iOSè®¾å¤‡ä½¿ç”¨ç®€åŒ–è½¬æ¢
            if (isIOS()) {
                console.log('ğŸ“± iOSè®¾å¤‡ï¼Œä½¿ç”¨ç®€åŒ–è½¬æ¢');

                try {
                    // å¯¹äºiOSå½•åˆ¶çš„æ–‡ä»¶ï¼Œå°è¯•ä¿æŒåŸæ ¼å¼
                    if (audioFile.type.includes('m4a') || audioFile.type.includes('mp4') || audioFile.name.includes('m4a')) {
                        console.log('ğŸ“± ä½¿ç”¨iOSåŸå§‹éŸ³é¢‘æ ¼å¼');
                        // å¦‚æœæ˜¯m4aæ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨ï¼Œä½†é‡å‘½åä¸ºmp3
                        const renamedFile = new File([audioFile], `audio_${assignedUserId}.m4a`, {
                            type: 'audio/mp4',
                            lastModified: Date.now()
                        });
                        return renamedFile;
                    }

                    // å¯¹äºå…¶ä»–æ ¼å¼ï¼Œå°è¯•ç®€å•è½¬æ¢
                    console.log('ğŸ“± å°è¯•ç®€å•éŸ³é¢‘è½¬æ¢');
                    const arrayBuffer = await audioFile.arrayBuffer();

                    // å°è¯•ä½¿ç”¨lamejsè¿›è¡Œè½¬æ¢
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

                    const sampleRate = Math.min(44100, audioBuffer.sampleRate);
                    const bitRate = 128;
                    const mp3Encoder = new lamejs.Mp3Encoder(1, sampleRate, bitRate);

                    const channelData = audioBuffer.getChannelData(0);
                    const sampleBlockSize = 1152;
                    let mp3Data = [];

                    const convertBuffer = (input) => {
                        const len = input.length;
                        const output = new Int16Array(len);
                        for (let i = 0; i < len; i++) {
                            const s = Math.max(-1, Math.min(1, input[i]));
                            output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                        }
                        return output;
                    };

                    for (let i = 0; i < channelData.length; i += sampleBlockSize) {
                        const chunk = channelData.subarray(i, i + sampleBlockSize);
                        const int16Data = convertBuffer(chunk);
                        const mp3Chunk = mp3Encoder.encodeBuffer(int16Data);
                        if (mp3Chunk.length > 0) {
                            mp3Data.push(new Int8Array(mp3Chunk));
                        }
                    }

                    const finalChunk = mp3Encoder.flush();
                    if (finalChunk.length > 0) {
                        mp3Data.push(new Int8Array(finalChunk));
                    }

                    const totalLength = mp3Data.reduce((acc, chunk) => acc + chunk.length, 0);
                    const mergedArray = new Int8Array(totalLength);
                    let offset = 0;
                    for (const chunk of mp3Data) {
                        mergedArray.set(chunk, offset);
                        offset += chunk.length;
                    }

                    const mp3Blob = new Blob([mergedArray.buffer], { type: 'audio/mpeg' });
                    const convertedFile = new File([mp3Blob], `audio_${assignedUserId}.mp3`, {
                        type: 'audio/mpeg',
                        lastModified: Date.now()
                    });

                    console.log('âœ… iOSéŸ³é¢‘è½¬æ¢æˆåŠŸï¼å¤§å°:', (convertedFile.size / 1024).toFixed(2), 'KB');
                    return convertedFile;

                } catch (error) {
                    console.error('iOSéŸ³é¢‘è½¬æ¢å¤±è´¥:', error);

                    // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥ä¸Šä¼ åŸå§‹æ–‡ä»¶
                    const safeFile = new File([audioFile], `audio_${assignedUserId}_original.${audioFile.name.split('.').pop() || 'webm'}`, {
                        type: audioFile.type,
                        lastModified: Date.now()
                    });

                    return safeFile;
                }
            }

            // éiOSè®¾å¤‡ä½¿ç”¨æ ‡å‡†è½¬æ¢é€»è¾‘
            try {
                const arrayBuffer = await audioFile.arrayBuffer();
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

                const sampleRate = Math.min(44100, audioBuffer.sampleRate);
                const bitRate = 128;
                const mp3Encoder = new lamejs.Mp3Encoder(1, sampleRate, bitRate);

                const channelData = audioBuffer.getChannelData(0);
                const sampleBlockSize = 1152;
                let mp3Data = [];

                const convertBuffer = (input) => {
                    const len = input.length;
                    const output = new Int16Array(len);
                    for (let i = 0; i < len; i++) {
                        const s = Math.max(-1, Math.min(1, input[i]));
                        output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                    }
                    return output;
                };

                for (let i = 0; i < channelData.length; i += sampleBlockSize) {
                    const chunk = channelData.subarray(i, i + sampleBlockSize);
                    const int16Data = convertBuffer(chunk);
                    const mp3Chunk = mp3Encoder.encodeBuffer(int16Data);
                    if (mp3Chunk.length > 0) {
                        mp3Data.push(new Int8Array(mp3Chunk));
                    }
                }

                const finalChunk = mp3Encoder.flush();
                if (finalChunk.length > 0) {
                    mp3Data.push(new Int8Array(finalChunk));
                }

                const totalLength = mp3Data.reduce((acc, chunk) => acc + chunk.length, 0);
                const mergedArray = new Int8Array(totalLength);
                let offset = 0;
                for (const chunk of mp3Data) {
                    mergedArray.set(chunk, offset);
                    offset += chunk.length;
                }

                const mp3Blob = new Blob([mergedArray.buffer], { type: 'audio/mpeg' });
                const convertedFile = new File([mp3Blob], `audio_${assignedUserId}.mp3`, {
                    type: 'audio/mpeg',
                    lastModified: Date.now()
                });

                console.log('âœ… éŸ³é¢‘è½¬æ¢æˆåŠŸï¼å¤§å°:', (convertedFile.size / 1024).toFixed(2), 'KB');
                return convertedFile;

            } catch (error) {
                console.error('éŸ³é¢‘è½¬æ¢å¤±è´¥:', error);

                // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥ä½¿ç”¨åŸå§‹æ–‡ä»¶
                const safeFile = new File([audioFile], `audio_${assignedUserId}_original.${audioFile.name.split('.').pop() || 'webm'}`, {
                    type: audioFile.type,
                    lastModified: Date.now()
                });

                return safeFile;
            }
        }

        // ==================== å®‰å…¨éªŒè¯å’Œé¡µé¢åˆå§‹åŒ– ====================
        window.addEventListener('DOMContentLoaded', async function () {
            // å®‰å…¨æ ¡éªŒ
            if (!assignedUserId || !assignedUserId.startsWith('user_')) {
                console.error('æ— æ•ˆçš„ç”¨æˆ·IDå‚æ•°:', assignedUserId);
                errorContainer.style.display = 'block';
                mainContainer.style.display = 'none';
                return;
            }

            // éªŒè¯é€šè¿‡ï¼Œæ˜¾ç¤ºä¸»å®¹å™¨ï¼Œéšè—é”™è¯¯å®¹å™¨
            errorContainer.style.display = 'none';
            mainContainer.style.display = 'block';

            console.log('å½“å‰æ“ä½œç”¨æˆ·ID:', assignedUserId);

            // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // iOSä¸“ç”¨åˆå§‹åŒ–
            if (isIOS()) {
                console.log('ğŸ“± iOS Safari è®¾å¤‡æ£€æµ‹åˆ°');
                iOSMediaSession.init();

                // æ·»åŠ iOSä¸“ç”¨æ ·å¼
                const style = document.createElement('style');
                style.textContent = `
            @media (max-width: 768px) {
                #audioUploadBox {
                    position: relative;
                    overflow: hidden;
                }
                
                #audioUploadBox .mobile-action-btn {
                    position: relative;
                    z-index: 10;
                }
                
                * {
                    -webkit-tap-highlight-color: transparent;
                }
                
                .mobile-action-btn:active {
                    transform: scale(0.98);
                }
            }
        `;
                document.head.appendChild(style);
            }

            // ç»§ç»­æ­£å¸¸åˆå§‹åŒ–
            checkUploadButton();
            initRecordingUI();
            initCameraUI();

            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            if (!isMobile) {
                audioUploadBox.addEventListener('click', () => audioInput.click());
                imageUploadBox.addEventListener('click', () => imageInput.click());
            }

            audioInput.addEventListener('change', handleAudioSelect);
            imageInput.addEventListener('change', handleImageSelect);
            uploadBtn.addEventListener('click', handleUpload);

            // æ·»åŠ iOSé¡µé¢çŠ¶æ€ç›‘å¬
            if (isIOS()) {
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        const recordBtn = document.querySelector('#audioUploadBox .mobile-action-btn .record-text');
                        if (recordBtn) {
                            recordBtn.textContent = 'å½•åˆ¶å£°éŸ³';
                        }
                        isRecording = false;
                    }
                });
            }
        });

        // ==================== æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ====================

        // å¤„ç†éŸ³é¢‘é€‰æ‹©
        function handleAudioSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('audio/')) {
                selectedAudio = file;
                document.getElementById('audioFileName').textContent = file.name;
                audioPreview.style.display = 'flex';
                audioUploadBox.querySelector('.upload-placeholder').style.display = 'none';

                audioMobilePreview.style.display = 'none';

                checkUploadButton();
            } else {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„éŸ³é¢‘æ–‡ä»¶ã€‚');
            }
        }

        // å¤„ç†å›¾ç‰‡é€‰æ‹©
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                processImageFile(file);
            } else {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ã€‚');
            }
        }

        // å¤„ç†å›¾ç‰‡æ–‡ä»¶
        function processImageFile(file) {
            selectedImage = file;
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('imageThumbnail').src = e.target.result;
            };
            reader.readAsDataURL(file);
            imagePreview.style.display = 'flex';
            imageUploadBox.querySelector('.upload-placeholder').style.display = 'none';

            imageMobilePreview.style.display = 'none';

            checkUploadButton();
        }

        // æ£€æŸ¥ä¸Šä¼ æŒ‰é’®çŠ¶æ€
        function checkUploadButton() {
            uploadBtn.disabled = !(selectedAudio || selectedImage);

            if (selectedAudio && selectedImage) {
                uploadBtn.textContent = 'ä¸Šä¼ å£°éŸ³ä¸å›¾ç‰‡';
                uploadBtn.style.background = 'linear-gradient(135deg, #fd79a8, #e84393)';
            } else if (selectedAudio) {
                uploadBtn.textContent = 'ä»…ä¸Šä¼ å£°éŸ³';
                uploadBtn.style.background = 'linear-gradient(135deg, #6c5ce7, #a29bfe)';
            } else if (selectedImage) {
                uploadBtn.textContent = 'ä»…ä¸Šä¼ å›¾ç‰‡';
                uploadBtn.style.background = 'linear-gradient(135deg, #00b894, #00cec9)';
            } else {
                uploadBtn.textContent = 'è¯·å…ˆé€‰æ‹©å£°éŸ³æˆ–å›¾ç‰‡';
                uploadBtn.style.background = 'linear-gradient(135deg, #6c5ce7, #a29bfe)';
            }
        }

        // ==================== ç§»åŠ¨ç«¯å½•éŸ³åŠŸèƒ½ ====================

        // åˆå§‹åŒ–å½•éŸ³UI
        function initRecordingUI() {
            const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

            if (isMobile) {
                const audioPlaceholder = document.querySelector('#audioUploadBox .upload-placeholder');
                if (audioPlaceholder) {
                    audioPlaceholder.querySelector('.icon').style.display = 'none';
                    audioPlaceholder.querySelector('p').style.display = 'none';
                    audioPlaceholder.querySelector('small').style.display = 'none';

                    const micIconLarge = audioPlaceholder.querySelector('.mic-icon-large');
                    if (micIconLarge) {
                        micIconLarge.style.display = 'block';
                    }

                    const recordBtn = document.createElement('button');
                    recordBtn.className = 'mobile-action-btn';

                    const btnContent = document.createElement('span');
                    btnContent.className = 'record-text';
                    btnContent.textContent = 'å½•åˆ¶å£°éŸ³';

                    recordBtn.appendChild(btnContent);
                    recordBtn.onclick = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        toggleRecording();
                    };

                    audioPlaceholder.appendChild(recordBtn);

                    audioUploadBox.style.cursor = 'default';
                }
            }
        }

        // å½•éŸ³æ§åˆ¶å‡½æ•°
        async function toggleRecording() {
            if (!isRecording) {
                if (isIOS()) {
                    console.log('ğŸ“± iOSå½•éŸ³å¼€å§‹');

                    const recordBtn = document.querySelector('#audioUploadBox .mobile-action-btn .record-text');
                    if (recordBtn) {
                        recordBtn.textContent = 'å‡†å¤‡ä¸­...';
                    }

                    if (!(await iOSMediaSession.canStartRecording())) {
                        alert('å½“å‰æ— æ³•å¼€å§‹å½•éŸ³ï¼Œè¯·ç¡®ä¿é¡µé¢å®Œå…¨æ˜¾ç¤ºå¹¶ä¿æŒæ´»è·ƒã€‚');
                        if (recordBtn) {
                            recordBtn.textContent = 'å½•åˆ¶å£°éŸ³';
                        }
                        return;
                    }

                    await new Promise(resolve => setTimeout(resolve, 100));

                    const success = await iOSRecorder.start();

                    if (success) {
                        isRecording = true;
                        if (recordBtn) {
                            recordBtn.textContent = 'âºï¸ å½•éŸ³ä¸­... ç‚¹å‡»åœæ­¢';
                        }

                        recordTimeout = setTimeout(() => {
                            if (iOSRecorder.isRecording) {
                                console.log('â±ï¸ è¾¾åˆ°æœ€å¤§å½•éŸ³æ—¶é—´');
                                iOSRecorder.stop();
                                isRecording = false;
                                if (recordBtn) {
                                    recordBtn.textContent = 'å½•åˆ¶å£°éŸ³';
                                }
                            }
                        }, MAX_RECORD_TIME);
                    } else {
                        if (recordBtn) {
                            recordBtn.textContent = 'å½•åˆ¶å£°éŸ³';
                        }
                    }
                    return;
                }

                // éiOSè®¾å¤‡çš„å½•éŸ³é€»è¾‘
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    currentAudioStream = stream;

                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        currentRecordedAudioBlob = audioBlob;
                        showAudioMobilePreview();
                        stream.getTracks().forEach(track => track.stop());
                        currentAudioStream = null;
                    };

                    mediaRecorder.start();
                    isRecording = true;

                    const recordBtn = document.querySelector('#audioUploadBox .mobile-action-btn .record-text');
                    if (recordBtn) {
                        recordBtn.textContent = 'âºï¸ å½•éŸ³ä¸­... ç‚¹å‡»åœæ­¢';
                    }

                    recordTimeout = setTimeout(() => {
                        if (isRecording && mediaRecorder && mediaRecorder.state === 'recording') {
                            mediaRecorder.stop();
                            isRecording = false;
                            clearTimeout(recordTimeout);

                            if (recordBtn) {
                                recordBtn.textContent = 'å½•åˆ¶å£°éŸ³';
                            }
                        }
                    }, MAX_RECORD_TIME);

                } catch (error) {
                    console.error('æ— æ³•è®¿é—®éº¦å…‹é£:', error);
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®ã€‚');
                }
            } else {
                // åœæ­¢å½•éŸ³
                if (isIOS()) {
                    iOSRecorder.stop();
                } else if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }

                isRecording = false;
                if (recordTimeout) {
                    clearTimeout(recordTimeout);
                    recordTimeout = null;
                }

                const recordBtn = document.querySelector('#audioUploadBox .mobile-action-btn .record-text');
                if (recordBtn) {
                    recordBtn.textContent = 'å½•åˆ¶å£°éŸ³';
                }
            }
        }

        // æ˜¾ç¤ºéŸ³é¢‘ç§»åŠ¨ç«¯é¢„è§ˆ
        function showAudioMobilePreview() {
            const audioPlaceholder = document.querySelector('#audioUploadBox .upload-placeholder');
            audioPlaceholder.style.display = 'none';
            audioPreview.style.display = 'none';
            audioMobilePreview.style.display = 'flex';
        }

        // é‡æ–°å½•åˆ¶éŸ³é¢‘
        function retryAudioRecording() {
            audioMobilePreview.style.display = 'none';

            const audioPlaceholder = document.querySelector('#audioUploadBox .upload-placeholder');
            audioPlaceholder.style.display = 'flex';

            if (isIOS()) {
                iOSRecorder.cleanup();
            }
            currentRecordedAudioBlob = null;
            selectedAudio = null;
            checkUploadButton();
        }

        // ç¡®è®¤ä½¿ç”¨å½•åˆ¶çš„éŸ³é¢‘
        async function confirmAudioRecording() {
            if (!currentRecordedAudioBlob) {
                alert('è¯·å…ˆå½•åˆ¶éŸ³é¢‘');
                return;
            }

            const recordedFile = new File([currentRecordedAudioBlob], `recording_${Date.now()}.${isIOS() ? 'm4a' : 'webm'}`, {
                type: isIOS() ? 'audio/mp4' : 'audio/webm'
            });

            handleAudioSelect({ target: { files: [recordedFile] } });
        }

        // ==================== ç§»åŠ¨ç«¯æ‹ç…§åŠŸèƒ½ ====================
        function initCameraUI() {
            const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

            if (isMobile) {
                const imagePlaceholder = document.querySelector('#imageUploadBox .upload-placeholder');
                if (imagePlaceholder) {
                    imagePlaceholder.querySelector('.icon').style.display = 'none';
                    imagePlaceholder.querySelector('p').style.display = 'none';
                    imagePlaceholder.querySelector('small').style.display = 'none';

                    const cameraIconLarge = imagePlaceholder.querySelector('.camera-icon-large');
                    if (cameraIconLarge) {
                        cameraIconLarge.style.display = 'block';
                    }

                    const cameraBtn = document.createElement('button');
                    cameraBtn.className = 'mobile-action-btn photo';

                    const btnContent = document.createElement('span');
                    btnContent.className = 'camera-text';
                    btnContent.textContent = 'æ‹ç…§ä¸Šä¼ ';

                    cameraBtn.appendChild(btnContent);
                    cameraBtn.onclick = (e) => {
                        e.stopPropagation();
                        openCamera();
                    };

                    imagePlaceholder.appendChild(cameraBtn);

                    imageUploadBox.style.cursor = 'default';
                }
            }
        }

        async function openCamera() {
            try {
                if (isIOS()) {
                    iOSMediaSession.cleanup();
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                currentCameraMode = 'environment';

                await startCamera(currentCameraMode);

            } catch (error) {
                console.error('æ— æ³•è®¿é—®æ‘„åƒå¤´:', error);
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®ã€‚');
            }
        }

        async function startCamera(cameraMode) {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }

            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: cameraMode },
                    audio: false
                });

                const cameraModal = document.createElement('div');
                cameraModal.className = 'camera-modal';

                const video = document.createElement('video');
                video.srcObject = cameraStream;
                video.autoplay = true;
                video.playsInline = true;

                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'camera-controls';

                const captureBtn = document.createElement('button');
                captureBtn.innerHTML = 'ğŸ“¸ æ‹ç…§';
                captureBtn.className = 'camera-btn capture-btn';

                const switchBtn = document.createElement('button');
                switchBtn.innerHTML = currentCameraMode === 'environment' ? 'ğŸ”„ å‰ç½®æ‘„åƒå¤´' : 'ğŸ”„ åç½®æ‘„åƒå¤´';
                switchBtn.className = 'camera-btn switch-camera-btn';

                const cancelBtn = document.createElement('button');
                cancelBtn.innerHTML = 'å–æ¶ˆ';
                cancelBtn.className = 'camera-btn cancel-btn';

                buttonContainer.appendChild(captureBtn);
                buttonContainer.appendChild(switchBtn);
                buttonContainer.appendChild(cancelBtn);

                cameraModal.appendChild(video);
                cameraModal.appendChild(buttonContainer);
                document.body.appendChild(cameraModal);

                captureBtn.onclick = () => capturePhoto(video, cameraModal);

                switchBtn.onclick = () => {
                    currentCameraMode = currentCameraMode === 'environment' ? 'user' : 'environment';
                    switchBtn.innerHTML = currentCameraMode === 'environment' ? 'ğŸ”„ å‰ç½®æ‘„åƒå¤´' : 'ğŸ”„ åç½®æ‘„åƒå¤´';

                    startCamera(currentCameraMode).then(() => {
                        video.srcObject = cameraStream;

                        if (cameraModal && cameraModal.parentNode) {
                            cameraModal.parentNode.removeChild(cameraModal);
                        }
                    });
                };

                cancelBtn.onclick = () => closeCamera(cameraModal);

            } catch (error) {
                console.error('å¯åŠ¨æ‘„åƒå¤´å¤±è´¥:', error);
                if (cameraMode === 'environment') {
                    alert('æ— æ³•è®¿é—®åç½®æ‘„åƒå¤´ï¼Œå°è¯•ä½¿ç”¨å‰ç½®æ‘„åƒå¤´...');
                    currentCameraMode = 'user';
                    await startCamera(currentCameraMode);
                } else {
                    alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®ã€‚');
                }
            }
        }

        function capturePhoto(videoElement, modalElement) {
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;

            const context = canvas.getContext('2d');
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

            canvas.toBlob((blob) => {
                if (blob) {
                    currentCapturedPhotoBlob = blob;
                    showPhotoMobilePreview(blob);
                }
                closeCamera(modalElement);
            }, 'image/jpeg', 0.9);
        }

        function showPhotoMobilePreview(blob) {
            const imageUrl = URL.createObjectURL(blob);
            imageMobileThumbnail.src = imageUrl;

            const imagePlaceholder = document.querySelector('#imageUploadBox .upload-placeholder');
            imagePlaceholder.style.display = 'none';
            imagePreview.style.display = 'none';
            imageMobilePreview.style.display = 'flex';
        }

        function retryPhotoCapture() {
            imageMobilePreview.style.display = 'none';

            const imagePlaceholder = document.querySelector('#imageUploadBox .upload-placeholder');
            imagePlaceholder.style.display = 'flex';

            if (imageMobileThumbnail.src.startsWith('blob:')) {
                URL.revokeObjectURL(imageMobileThumbnail.src);
            }
            currentCapturedPhotoBlob = null;
            selectedImage = null;
            imageMobileThumbnail.src = '';
            checkUploadButton();
        }

        function confirmPhotoCapture() {
            if (!currentCapturedPhotoBlob) {
                alert('è¯·å…ˆæ‹æ‘„ç…§ç‰‡');
                return;
            }

            const photoFile = new File([currentCapturedPhotoBlob], `photo_${Date.now()}.jpg`, {
                type: 'image/jpeg'
            });

            processImageFile(photoFile);
        }

        function closeCamera(modalElement) {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            if (modalElement && modalElement.parentNode) {
                modalElement.parentNode.removeChild(modalElement);
            }
        }

        // ==================== ä¸Šä¼ å‡½æ•° ====================
        async function handleUpload() {
            const client = supabaseClient;
            let uploadAudio = selectedAudio !== null;
            let uploadImage = selectedImage !== null;

            if (!uploadAudio && !uploadImage) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ ã€‚');
                return;
            }

            const MAX_AUDIO_SIZE = 5 * 1024 * 1024;
            const MAX_IMAGE_SIZE = 2 * 1024 * 1024;

            if (uploadAudio && selectedAudio.size > MAX_AUDIO_SIZE) {
                alert(`éŸ³é¢‘æ–‡ä»¶å¤§å°è¯·æ§åˆ¶åœ¨5MBä»¥å†…ã€‚`);
                return;
            }
            if (uploadImage && selectedImage.size > MAX_IMAGE_SIZE) {
                alert(`å›¾ç‰‡æ–‡ä»¶å¤§å°è¯·æ§åˆ¶åœ¨2MBä»¥å†…ã€‚`);
                return;
            }

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'å¤„ç†ä¸­...';
            let uploadSuccess = { audio: false, image: false };

            try {
                console.log(`å¼€å§‹ä¸ºç”¨æˆ· ${assignedUserId} å¤„ç†æ–‡ä»¶...`);

                // 1. å›¾ç‰‡å¤„ç†
                if (uploadImage) {
                    uploadBtn.textContent = 'æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...';
                    const { error: imageError } = await client.storage
                        .from('love-letters')
                        .upload(`${assignedUserId}/image.jpg`, selectedImage, {
                            upsert: true,
                            cacheControl: 'public, max-age=31536000'
                        });
                    if (imageError) throw new Error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${imageError.message}`);
                    uploadSuccess.image = true;
                    console.log('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ');
                }

                // 2. éŸ³é¢‘å¤„ç†
                if (uploadAudio) {
                    uploadBtn.textContent = 'æ­£åœ¨å¤„ç†éŸ³é¢‘...';

                    // ä½¿ç”¨ convertAudioToMP3 å‡½æ•°ï¼ˆæ³¨æ„ï¼šä¸æ˜¯ convertAudioToMP3_iOSï¼‰
                    const finalAudioFile = await convertAudioToMP3(selectedAudio);

                    uploadBtn.textContent = 'æ­£åœ¨ä¸Šä¼ éŸ³é¢‘...';
                    const { error: audioError } = await client.storage
                        .from('love-letters')
                        .upload(`${assignedUserId}/audio.mp3`, finalAudioFile, {
                            upsert: true,
                            cacheControl: 'public, max-age=31536000',
                            contentType: 'audio/mpeg'
                        });
                    if (audioError) throw new Error(`éŸ³é¢‘ä¸Šä¼ å¤±è´¥: ${audioError.message}`);
                    uploadSuccess.audio = true;
                    console.log('âœ… éŸ³é¢‘ä¸Šä¼ æˆåŠŸ');
                }

                // 3. ç”ŸæˆæˆåŠŸä¿¡æ¯
                let successText = '';
                if (uploadSuccess.audio && uploadSuccess.image) {
                    successText = 'å£°éŸ³å’Œå›¾ç‰‡æ–‡ä»¶éƒ½å·²ä¸Šä¼ æˆåŠŸï¼';
                } else if (uploadSuccess.audio) {
                    successText = 'å£°éŸ³æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼';
                } else if (uploadSuccess.image) {
                    successText = 'å›¾ç‰‡æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼';
                }

                successDetails.textContent = successText;
                successMessage.style.display = 'block';
                uploadBtn.textContent = 'âœ… ä¸Šä¼ å®Œæˆ';
                uploadBtn.style.background = '#00b894';
                successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // iOS Safari ä¼˜åŒ–
                if (isIOS()) {
                    console.log('ğŸ“± iOSä¸Šä¼ å®Œæˆï¼Œæ¸…ç†èµ„æº...');

                    setTimeout(() => {
                        iOSMediaSession.cleanup();
                        iOSRecorder.cleanup();
                        console.log('ğŸ§¹ iOSèµ„æºæ¸…ç†å®Œæˆ');
                    }, 100);
                }

                // é¡µé¢åˆ·æ–°
                const refreshDelay = isIOS() ? 2000 : 1500;

                setTimeout(() => {
                    if (isIOS()) {
                        iOSMediaSession.cleanup();
                        iOSRecorder.cleanup();
                    }

                    safePageRefresh();
                }, refreshDelay);

            } catch (error) {
                console.error('ä¸Šä¼ è¿‡ç¨‹å‡ºé”™:', error);
                alert(`ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚\né”™è¯¯ä¿¡æ¯: ${error.message}`);

                uploadBtn.disabled = false;
                checkUploadButton();

                if (isIOS()) {
                    setTimeout(() => {
                        iOSMediaSession.cleanup();
                        iOSRecorder.cleanup();
                    }, 100);
                }
            }
        }

        // ==================== å®‰å…¨é¡µé¢åˆ·æ–°å‡½æ•° ====================
        function safePageRefresh() {
            if (isIOS()) {
                const timestamp = new Date().getTime();
                const currentUrl = new URL(window.location.href);

                currentUrl.searchParams.delete('_t');
                currentUrl.searchParams.set('_t', timestamp);

                window.location.replace(currentUrl.toString());
            } else {
                window.location.reload();
            }
        }

        // ==================== é‡ç½®ä¸Šä¼ ç•Œé¢ ====================
        function resetUploadInterface() {
            selectedAudio = null;
            selectedImage = null;

            audioPreview.style.display = 'none';
            audioUploadBox.querySelector('.upload-placeholder').style.display = 'flex';
            audioInput.value = '';
            audioMobilePreview.style.display = 'none';

            imagePreview.style.display = 'none';
            imageUploadBox.querySelector('.upload-placeholder').style.display = 'flex';
            imageInput.value = '';
            document.getElementById('imageThumbnail').src = '';
            imageMobilePreview.style.display = 'none';

            if (imageMobileThumbnail.src.startsWith('blob:')) {
                URL.revokeObjectURL(imageMobileThumbnail.src);
                imageMobileThumbnail.src = '';
            }

            currentRecordedAudioBlob = null;
            currentCapturedPhotoBlob = null;

            if (isIOS()) {
                iOSRecorder.cleanup();
                iOSMediaSession.cleanup();
            }

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'è¯·å…ˆé€‰æ‹©å£°éŸ³æˆ–å›¾ç‰‡';
            uploadBtn.style.background = 'linear-gradient(135deg, #6c5ce7, #a29bfe)';

            successMessage.style.display = 'none';
        }

        // ==================== æ·»åŠ è°ƒè¯•ä¿¡æ¯ ====================
        if (window.location.hostname.includes('localhost') || window.location.hostname.includes('netlify')) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const debugDiv = document.createElement('div');
                    debugDiv.style.cssText = `
                position: fixed;
                top: 10px;
                left: 10px;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 10px;
                border-radius: 5px;
                font-size: 12px;
                z-index: 9999;
                max-width: 300px;
                display: ${isIOS() ? 'block' : 'none'};
            `;
                    debugDiv.innerHTML = `
                <div>iOS: ${isIOS() ? 'âœ…' : 'âŒ'}</div>
                <div>ç”¨æˆ·: ${assignedUserId || 'æ— '}</div>
                <button onclick="iOSMediaSession.cleanup(); alert('æ¸…ç†å®Œæˆ')" 
                    style="margin-top:5px; padding:5px; background:#ff4757; color:white; border:none; border-radius:3px;">
                    æ¸…ç†iOSèµ„æº
                </button>
            `;
                    document.body.appendChild(debugDiv);
                }, 1000);
            });
        }
    </script>
</body>

</html>