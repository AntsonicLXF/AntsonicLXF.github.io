<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <!-- 关键Meta标签：移动端优化 -->
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- iOS Safari特定设置 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="播放">
    <!-- Android Chrome特定设置 -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <!-- 防止缓存，确保每次都是新页面 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- 预连接Supabase，优化连接速度 -->
    <link rel="preconnect" href="https://ysuzytkxvcoorpvsobqd.supabase.co">
    <link rel="dns-prefetch" href="https://ysuzytkxvcoorpvsobqd.supabase.co">
    <title>播放</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        #backgroundImage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .image-loaded {
            opacity: 1 !important;
        }

        .audio-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px 10px 30px;
            z-index: 2;
            backdrop-filter: blur(10px);
        }

        #audioPlayer {
            width: 100%;
            height: 40px;
            opacity: 0.9;
        }

        @supports (padding: max(0px)) {
            .audio-controls {
                padding-bottom: max(30px, env(safe-area-inset-bottom));
            }
        }

        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 3;
        }

        .hidden {
            display: none !important;
        }

        .error {
            color: #ff6b6b;
        }

        .play-prompt {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 4;
            color: white;
            font-size: 18px;
            text-align: center;
            padding: 20px;
            cursor: pointer;
        }

        /* ==================== 进度条样式 ==================== */
        .progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            transition: opacity 0.5s;
        }

        .progress-container.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .progress-bar {
            width: 80%;
            max-width: 400px;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            margin: 30px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg,
                    #6c5ce7 0%,
                    #a29bfe 25%,
                    #74b9ff 50%,
                    #0984e3 75%,
                    #6c5ce7 100%);
            border-radius: 6px;
            transition: width 0.3s ease-out;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.3) 50%,
                    transparent 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        .progress-text {
            color: white;
            font-size: 20px;
            font-weight: 500;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .progress-details {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            text-align: center;
            min-height: 20px;
            margin-top: 10px;
        }

        /* 加载完成动画 */
        .loading-complete {
            animation: completePulse 0.5s ease-out;
        }

        @keyframes completePulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        /* 加载阶段标记 */
        .loading-stages {
            display: flex;
            justify-content: space-between;
            width: 80%;
            max-width: 400px;
            margin-top: 20px;
        }

        .loading-stage {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s;
        }

        .loading-stage.active {
            background: #6c5ce7;
            transform: scale(1.3);
            box-shadow: 0 0 10px rgba(108, 92, 231, 0.5);
        }

        .loading-stage.complete {
            background: #00b894;
        }

        /* 错误状态 */
        .progress-error {
            background: linear-gradient(90deg, #ff6b6b, #ee5a52) !important;
        }

        .progress-error::after {
            animation: none;
        }

        /* 移动端适配 */
        @media screen and (max-width: 767px) {
            .progress-bar {
                width: 90%;
                height: 10px;
            }

            .progress-text {
                font-size: 18px;
            }

            .progress-details {
                font-size: 13px;
            }
        }

        @media screen and (max-width: 767px) {
            body {
                height: 100vh;
                height: -webkit-fill-available;
            }

            #backgroundImage {
                height: 100vh;
                height: -webkit-fill-available;
            }
        }
    </style>
</head>

<body>
    <!-- 加载进度条容器 -->
    <div id="progressContainer" class="progress-container">
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
        </div>
        <div id="progressText" class="progress-text">正在加载中...</div>
        <div id="progressDetails" class="progress-details"></div>
    </div>

    <div id="loading">正在加载...</div>
    <div class="play-prompt hidden" id="playPrompt">点击播放</div>
    <img id="backgroundImage" alt="图片" crossorigin="anonymous">
    <div class="audio-controls">
        <audio id="audioPlayer" controls loop crossorigin="anonymous">浏览器不支持音频播放</audio>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://ysuzytkxvcoorpvsobqd.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzdXp5dGt4dmNvb3JwdnNvYnFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyOTMxMjUsImV4cCI6MjA3OTg2OTEyNX0.mcHqTQmeBFpW8NCCDCAauWAkjNvzOLiGQN5WAhrNC_A';
        let supabaseClient = null;
        const DEFAULT_IMAGE = 'https://ysuzytkxvcoorpvsobqd.supabase.co/storage/v1/object/public/love-letters/defaults/default-image.jpg';
        const DEFAULT_AUDIO = 'https://ysuzytkxvcoorpvsobqd.supabase.co/storage/v1/object/public/love-letters/defaults/default-audio.mp3';
        const backgroundImage = document.getElementById('backgroundImage');
        const audioPlayer = document.getElementById('audioPlayer');
        const loading = document.getElementById('loading');
        const playPrompt = document.getElementById('playPrompt');
        let isMediaLoaded = false;
        let playPromptActive = false;

        // ==================== 进度管理变量和函数 ====================
        let progressData = {
            image: { loaded: 0, total: 0, percentage: 0 },
            audio: { loaded: 0, total: 0, percentage: 0 }
        };
        let currentStage = 'checking'; // checking, image, audio, complete
        let lastProgressUpdateTime = 0;
        const PROGRESS_UPDATE_INTERVAL = 100; // 最小更新间隔(ms)

        // 进度条DOM元素
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const progressDetails = document.getElementById('progressDetails');

        // 初始化进度条
        function initProgressBar() {
            progressData = {
                image: { loaded: 0, total: 0, percentage: 0 },
                audio: { loaded: 0, total: 0, percentage: 0 }
            };
            currentStage = 'checking';
            updateProgressUI();
            progressContainer.classList.remove('hidden');
        }

        // 更新进度UI
        function updateProgressUI() {
            const now = Date.now();
            // 限制更新频率，避免性能问题
            if (now - lastProgressUpdateTime < PROGRESS_UPDATE_INTERVAL) {
                return;
            }

            lastProgressUpdateTime = now;

            // 计算总体进度
            let totalProgress = 0;
            let currentText = '正在加载中...';
            let currentDetails = '';

            switch (currentStage) {
                case 'checking':
                    totalProgress = 10;
                    currentText = '检查用户状态...';
                    currentDetails = '正在验证用户权限和时间限制';
                    break;

                case 'image':
                    totalProgress = 30 + (progressData.image.percentage * 0.5);
                    currentText = '加载背景图片...';
                    currentDetails = formatBytes(progressData.image.loaded) + ' / ' +
                        formatBytes(progressData.image.total) +
                        ` (${progressData.image.percentage.toFixed(1)}%)`;
                    break;

                case 'audio':
                    totalProgress = 60 + (progressData.audio.percentage * 0.3);
                    currentText = '加载音频文件...';
                    currentDetails = formatBytes(progressData.audio.loaded) + ' / ' +
                        formatBytes(progressData.audio.total) +
                        ` (${progressData.audio.percentage.toFixed(1)}%)`;
                    break;

                case 'complete':
                    totalProgress = 100;
                    currentText = '加载完成！';
                    currentDetails = '准备播放...';
                    break;

                default:
                    totalProgress = 0;
            }

            // 更新UI
            progressFill.style.width = totalProgress + '%';
            progressText.textContent = currentText;
            progressDetails.textContent = currentDetails;

            // 完成时的特殊效果
            if (totalProgress >= 100) {
                progressFill.classList.add('loading-complete');
                setTimeout(() => {
                    hideProgressBar();
                }, 500);
            }
        }

        // 隐藏进度条
        function hideProgressBar() {
            progressContainer.classList.add('hidden');
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 500);
        }

        // 设置加载阶段
        function setProgressStage(stage) {
            currentStage = stage;
            updateProgressUI();
        }

        // 更新图片加载进度
        function updateImageProgress(loaded, total) {
            if (total === 0) return;

            progressData.image.loaded = loaded;
            progressData.image.total = total;
            progressData.image.percentage = (loaded / total) * 100;
            updateProgressUI();
        }

        // 更新音频加载进度
        function updateAudioProgress(loaded, total) {
            if (total === 0) return;

            progressData.audio.loaded = loaded;
            progressData.audio.total = total;
            progressData.audio.percentage = (loaded / total) * 100;
            updateProgressUI();
        }

        // 格式化字节大小
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';

            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 设置进度错误状态
        function setProgressError(message) {
            progressFill.classList.add('progress-error');
            progressText.textContent = '加载出错';
            progressDetails.textContent = message;

            // 3秒后隐藏进度条
            setTimeout(() => {
                hideProgressBar();
            }, 3000);
        }

        // ==================== 页面状态管理 ====================
        let pageHiddenTime = null;
        const MAX_INACTIVE_TIME = 1 * 60 * 1000; // 1分钟后自动刷新（单位：毫秒）
        let refreshTimer = null;

        // 检测页面可见性变化
        document.addEventListener('visibilitychange', handleVisibilityChange);

        function handleVisibilityChange() {
            if (document.hidden) {
                // 页面隐藏（用户切换到其他应用或关闭浏览器）
                pageHiddenTime = Date.now();
                console.log('页面隐藏，开始计时...');

                // 停止音频播放
                if (!audioPlayer.paused) {
                    audioPlayer.pause();
                }

                // 设置定时刷新（5分钟后）
                refreshTimer = setTimeout(() => {
                    if (document.hidden) {
                        console.log('页面已隐藏5分钟，准备刷新');
                        // 页面处于隐藏状态超过5分钟，刷新页面
                        window.location.reload();
                    }
                }, MAX_INACTIVE_TIME);

            } else {
                // 页面恢复可见
                console.log('页面恢复可见');

                // 清除刷新定时器
                if (refreshTimer) {
                    clearTimeout(refreshTimer);
                    refreshTimer = null;
                }

                // 如果页面隐藏时间超过10秒，自动刷新
                if (pageHiddenTime && (Date.now() - pageHiddenTime) > 10000) {
                    console.log('页面隐藏超过30秒，自动刷新');
                    window.location.reload();
                    return;
                }

                // 如果之前有播放，继续播放
                if (isMediaLoaded && !audioPlayer.paused) {
                    audioPlayer.play().catch(e => {
                        console.log('恢复播放失败:', e);
                        showPlayPrompt();
                    });
                }
            }
        }

        // 监听页面关闭/刷新事件
        window.addEventListener('beforeunload', function () {
            // 页面即将关闭，清除定时器
            if (refreshTimer) {
                clearTimeout(refreshTimer);
            }

            // 停止音频播放
            if (!audioPlayer.paused) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
            }
        });

        // 监听页面恢复（浏览器恢复上次会话）
        window.addEventListener('pageshow', function (event) {
            if (event.persisted) {
                // 页面是从缓存中恢复的（浏览器恢复上次会话）
                console.log('页面从缓存恢复，重新加载');
                window.location.reload();
            }
        });

        document.addEventListener('DOMContentLoaded', init);
        // ==================== 修改init函数 ====================
        async function init() {
            try {
                console.log('初始化播放页面...');

                // 初始化进度条
                initProgressBar();

                supabaseClient = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

                // 设置检查阶段
                setProgressStage('checking');

                // 测试 Supabase 连接
                const { data, error } = await supabaseClient.storage
                    .from('love-letters')
                    .list('', { limit: 1 });

                if (error) {
                    console.error('Supabase 连接失败:', error);
                    setProgressError('服务器连接失败，请检查网络');
                    return;
                }

                document.addEventListener('touchmove', e => e.preventDefault(), { passive: false });
                const urlParams = new URLSearchParams(window.location.search);
                const userId = urlParams.get('user');
                if (!userId) {
                    setProgressError('用户ID无效');
                    return;
                }

                await loadMedia(userId);

                // 标记加载完成
                setProgressStage('complete');

                loading.classList.add('hidden');
                isMediaLoaded = true;
                tryAutoPlay();
            } catch (error) {
                console.error('初始化失败:', error);
                setProgressError('加载失败，请重试');
            }
        }

        // ==================== 时间限制检查函数 ====================
        async function checkTimeRestriction(userId) {
            if (!supabaseClient) {
                console.log('Supabase客户端未初始化，默认允许播放');
                return true;
            }

            try {
                console.log(`检查用户 ${userId} 的时间限制...`);

                // 查询用户的时间设置
                const { data, error } = await supabaseClient
                    .from('user_time_settings')
                    .select('enabled, start_time, end_time')
                    .eq('user_id', userId)
                    .single();

                if (error) {
                    // 如果没找到记录或查询失败，默认允许播放
                    if (error.code === 'PGRST116') {
                        console.log('用户未设置时间限制，允许播放');
                        return true;
                    }

                    // 如果是RLS错误，记录但不阻止播放
                    if (error.message.includes('row-level security') ||
                        error.message.includes('RLS') ||
                        error.code === '42501') {
                        console.warn('RLS策略错误，默认允许播放:', error.message);
                        return true;
                    }

                    console.error('查询时间设置失败:', error);
                    return true; // 出错时默认允许
                }

                console.log('查询到时间设置:', data);

                // 检查 enabled 字段
                if (!data || data.enabled === false) {
                    console.log('时间限制未启用 (enabled=false)，允许播放');
                    return true;
                }

                // 如果启用了但没有设置时间，也允许播放
                if (!data.start_time || !data.end_time) {
                    console.log('时间限制已启用但没有设置时间，允许播放');
                    return true;
                }

                // 检查当前时间是否在允许范围内
                const now = new Date();
                const currentTime = now.getHours() * 60 + now.getMinutes(); // 转换为分钟数

                // 解析开始和结束时间
                const startTimeParts = data.start_time.split(':');
                const endTimeParts = data.end_time.split(':');

                const startTime = parseInt(startTimeParts[0]) * 60 + parseInt(startTimeParts[1]);
                const endTime = parseInt(endTimeParts[0]) * 60 + parseInt(endTimeParts[1]);

                console.log(`时间检查: 当前时间 ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}, 允许时间段 ${data.start_time} - ${data.end_time}`);

                // 检查是否在时间段内
                if (currentTime >= startTime && currentTime <= endTime) {
                    console.log('✅ 当前时间在允许范围内，播放用户内容');
                    return true;
                } else {
                    console.log('⏰ 当前时间不在允许范围内，播放默认内容');
                    return false;
                }

            } catch (error) {
                console.error('检查时间限制时出错:', error);
                return true; // 出错时默认允许
            }
        }

        // ==================== 修改loadMedia函数 ====================
        async function loadMedia(userId) {
            console.log('开始加载用户媒体文件:', userId);

            // 检查时间限制
            const isTimeAllowed = await checkTimeRestriction(userId);

            if (isTimeAllowed) {
                // 时间允许，加载用户内容
                await Promise.all([loadImage(userId), loadAudio(userId)]);
                console.log('加载用户自定义内容');
            } else {
                // 时间不允许，直接使用默认内容
                console.log('使用默认内容（时间限制生效）');
                await loadDefaultContent();
            }
            console.log('媒体文件加载完成');
        }

        // ==================== 修改loadDefaultContent函数 ====================
        async function loadDefaultContent() {
            return new Promise((resolve) => {
                try {
                    const timestamp = new Date().getTime();

                    // 设置图片加载阶段
                    setProgressStage('image');

                    // 使用XHR加载默认图片以获取进度
                    const xhrImage = new XMLHttpRequest();
                    xhrImage.open('GET', DEFAULT_IMAGE + '?t=' + timestamp, true);
                    xhrImage.responseType = 'blob';

                    xhrImage.addEventListener('progress', function (e) {
                        if (e.lengthComputable) {
                            updateImageProgress(e.loaded, e.total);
                        }
                    });

                    xhrImage.addEventListener('load', function () {
                        if (xhrImage.status === 200) {
                            const blob = xhrImage.response;
                            const blobUrl = URL.createObjectURL(blob);
                            backgroundImage.src = blobUrl;

                            backgroundImage.onload = () => {
                                backgroundImage.classList.add('image-loaded');
                                updateImageProgress(100, 100);
                                URL.revokeObjectURL(blobUrl);

                                // 设置音频加载阶段
                                setProgressStage('audio');

                                // 加载默认音频
                                audioPlayer.src = DEFAULT_AUDIO + '?t=' + timestamp;
                                audioPlayer.oncanplaythrough = () => {
                                    updateAudioProgress(100, 100);
                                    resolve();
                                };

                                audioPlayer.onerror = () => {
                                    updateAudioProgress(100, 100);
                                    resolve();
                                };
                            };
                        }
                    });

                    xhrImage.addEventListener('error', function () {
                        // XHR失败，回退到img元素
                        backgroundImage.src = DEFAULT_IMAGE + '?t=' + timestamp;
                        backgroundImage.onload = () => {
                            backgroundImage.classList.add('image-loaded');
                            updateImageProgress(100, 100);

                            // 加载默认音频
                            audioPlayer.src = DEFAULT_AUDIO + '?t=' + timestamp;
                            audioPlayer.oncanplaythrough = () => {
                                updateAudioProgress(100, 100);
                                resolve();
                            };

                            audioPlayer.onerror = () => {
                                updateAudioProgress(100, 100);
                                resolve();
                            };
                        };
                    });

                    xhrImage.send();

                } catch (error) {
                    console.error('加载默认内容时出错:', error);
                    // 出错时直接标记完成
                    updateImageProgress(100, 100);
                    updateAudioProgress(100, 100);
                    resolve();
                }
            });
        }

        // ==================== 修改loadImage函数 ====================
        async function loadImage(userId) {
            return new Promise((resolve) => {
                try {
                    // 设置图片加载阶段
                    setProgressStage('image');

                    // 检查时间限制
                    checkTimeRestriction(userId).then(isAllowed => {
                        if (!isAllowed) {
                            // 时间不允许，使用默认图片
                            const timestamp = new Date().getTime();
                            backgroundImage.src = DEFAULT_IMAGE + '?t=' + timestamp;
                            backgroundImage.onload = () => {
                                backgroundImage.classList.add('image-loaded');
                                updateImageProgress(100, 100);
                                resolve();
                            };
                            backgroundImage.onerror = () => {
                                backgroundImage.classList.add('image-loaded');
                                updateImageProgress(100, 100);
                                resolve();
                            };
                            return;
                        }

                        // 时间允许，加载用户图片
                        const userImagePath = `${userId}/image.jpg`;
                        const userImageUrl = `${supabaseUrl}/storage/v1/object/public/love-letters/${encodeURIComponent(userImagePath)}`;
                        const timestamp = new Date().getTime();
                        const imageUrlWithCacheBust = `${userImageUrl}?t=${timestamp}`;

                        // 使用XMLHttpRequest来获取加载进度
                        const xhr = new XMLHttpRequest();
                        xhr.open('GET', imageUrlWithCacheBust, true);
                        xhr.responseType = 'blob';

                        xhr.addEventListener('progress', function (e) {
                            if (e.lengthComputable) {
                                updateImageProgress(e.loaded, e.total);
                            }
                        });

                        xhr.addEventListener('load', function () {
                            if (xhr.status === 200) {
                                const blob = xhr.response;
                                const blobUrl = URL.createObjectURL(blob);
                                backgroundImage.src = blobUrl;

                                const timeoutId = setTimeout(() => {
                                    console.log('用户图片加载超时，使用默认图片');
                                    backgroundImage.src = DEFAULT_IMAGE + '?t=' + timestamp;
                                    backgroundImage.onload = () => {
                                        backgroundImage.classList.add('image-loaded');
                                        updateImageProgress(100, 100);
                                        resolve();
                                    };
                                }, 10000);

                                backgroundImage.onload = () => {
                                    clearTimeout(timeoutId);
                                    console.log('用户图片加载成功');
                                    backgroundImage.classList.add('image-loaded');
                                    updateImageProgress(100, 100);
                                    URL.revokeObjectURL(blobUrl);
                                    resolve();
                                };

                                backgroundImage.onerror = (e) => {
                                    clearTimeout(timeoutId);
                                    console.error('用户图片加载失败:', e);
                                    backgroundImage.src = DEFAULT_IMAGE + '?t=' + new Date().getTime();
                                    backgroundImage.onload = () => {
                                        backgroundImage.classList.add('image-loaded');
                                        updateImageProgress(100, 100);
                                        resolve();
                                    };
                                    URL.revokeObjectURL(blobUrl);
                                };
                            } else {
                                // XHR失败，回退到img元素
                                console.warn('XHR加载失败，回退到img元素');
                                backgroundImage.src = imageUrlWithCacheBust;

                                backgroundImage.onload = () => {
                                    console.log('回退方式图片加载成功');
                                    backgroundImage.classList.add('image-loaded');
                                    updateImageProgress(100, 100);
                                    resolve();
                                };

                                backgroundImage.onerror = () => {
                                    console.error('回退方式图片也失败');
                                    backgroundImage.src = DEFAULT_IMAGE + '?t=' + new Date().getTime();
                                    backgroundImage.onload = () => {
                                        backgroundImage.classList.add('image-loaded');
                                        updateImageProgress(100, 100);
                                        resolve();
                                    };
                                };
                            }
                        });

                        xhr.addEventListener('error', function () {
                            console.warn('XHR错误，回退到img元素');
                            // XHR错误，回退到img元素
                            backgroundImage.src = imageUrlWithCacheBust;

                            backgroundImage.onload = () => {
                                console.log('回退方式图片加载成功');
                                backgroundImage.classList.add('image-loaded');
                                updateImageProgress(100, 100);
                                resolve();
                            };

                            backgroundImage.onerror = () => {
                                console.error('回退方式图片也失败');
                                backgroundImage.src = DEFAULT_IMAGE + '?t=' + new Date().getTime();
                                backgroundImage.onload = () => {
                                    backgroundImage.classList.add('image-loaded');
                                    updateImageProgress(100, 100);
                                    resolve();
                                };
                            };
                        });

                        xhr.send();
                    });
                } catch (error) {
                    console.error('加载图片时出错:', error);
                    backgroundImage.src = DEFAULT_IMAGE;
                    backgroundImage.onload = () => {
                        backgroundImage.classList.add('image-loaded');
                        updateImageProgress(100, 100);
                        resolve();
                    };
                }
            });
        }

        // ==================== 修改loadAudio函数 ====================
        async function loadAudio(userId) {
            return new Promise((resolve) => {
                console.log(`加载用户 ${userId} 的音频文件`);

                // 设置音频加载阶段
                setProgressStage('audio');

                // 检查时间限制
                checkTimeRestriction(userId).then(isAllowed => {
                    if (!isAllowed) {
                        // 时间不允许，使用默认音频
                        console.log('时间限制生效，使用默认音频');
                        audioPlayer.src = DEFAULT_AUDIO + '?t=' + Date.now();
                        audioPlayer.oncanplaythrough = () => {
                            updateAudioProgress(100, 100);
                            resolve();
                        };
                        return;
                    }

                    // 首先检查文件是否存在
                    checkAudioExists(userId).then(exists => {
                        if (!exists) {
                            console.log('音频文件不存在，使用默认音频');
                            audioPlayer.src = DEFAULT_AUDIO + '?t=' + Date.now();
                            audioPlayer.oncanplaythrough = () => {
                                updateAudioProgress(100, 100);
                                resolve();
                            };
                            return;
                        }

                        // 直接使用标准URL（不带download参数）
                        const audioUrl = `${supabaseUrl}/storage/v1/object/public/love-letters/${userId}/audio.mp3?t=${Date.now()}`;
                        console.log(`尝试加载音频: ${audioUrl}`);

                        // 使用XMLHttpRequest来获取加载进度
                        const xhr = new XMLHttpRequest();
                        xhr.open('GET', audioUrl, true);
                        xhr.responseType = 'blob';

                        xhr.addEventListener('progress', function (e) {
                            if (e.lengthComputable) {
                                updateAudioProgress(e.loaded, e.total);
                            }
                        });

                        xhr.addEventListener('load', function () {
                            if (xhr.status === 200) {
                                const blob = xhr.response;
                                const blobUrl = URL.createObjectURL(blob);
                                audioPlayer.src = blobUrl;

                                audioPlayer.oncanplaythrough = () => {
                                    console.log('音频加载成功');
                                    updateAudioProgress(100, 100);
                                    URL.revokeObjectURL(blobUrl);
                                    resolve();
                                };

                                audioPlayer.onerror = () => {
                                    console.log('音频加载失败，使用默认音频');
                                    audioPlayer.src = DEFAULT_AUDIO + '?t=' + Date.now();
                                    audioPlayer.oncanplaythrough = () => {
                                        updateAudioProgress(100, 100);
                                        resolve();
                                    };
                                    URL.revokeObjectURL(blobUrl);
                                };
                            } else {
                                // XHR失败，回退到audio元素
                                console.warn('XHR加载失败，回退到audio元素');
                                audioPlayer.src = audioUrl;

                                audioPlayer.oncanplaythrough = () => {
                                    console.log('回退方式音频加载成功');
                                    updateAudioProgress(100, 100);
                                    resolve();
                                };

                                audioPlayer.onerror = () => {
                                    console.log('回退方式音频也失败，使用默认音频');
                                    audioPlayer.src = DEFAULT_AUDIO + '?t=' + Date.now();
                                    audioPlayer.oncanplaythrough = () => {
                                        updateAudioProgress(100, 100);
                                        resolve();
                                    };
                                };
                            }
                        });

                        xhr.addEventListener('error', function () {
                            console.warn('XHR错误，回退到audio元素');
                            audioPlayer.src = audioUrl;

                            audioPlayer.oncanplaythrough = () => {
                                console.log('回退方式音频加载成功');
                                updateAudioProgress(100, 100);
                                resolve();
                            };

                            audioPlayer.onerror = () => {
                                console.log('回退方式音频也失败，使用默认音频');
                                audioPlayer.src = DEFAULT_AUDIO + '?t=' + Date.now();
                                audioPlayer.oncanplaythrough = () => {
                                    updateAudioProgress(100, 100);
                                    resolve();
                                };
                            };
                        });

                        xhr.send();

                        // 设置超时
                        setTimeout(() => {
                            if (xhr.readyState !== 4) {
                                xhr.abort();
                                console.warn('音频加载超时，尝试回退方式');
                                audioPlayer.src = audioUrl;
                                resolve();
                            }
                        }, 30000);
                    });
                });
            });
        }

        // iOS 特殊预加载函数
        async function preloadAudioForIOS(audioUrl) {
            return new Promise((resolve) => {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', audioUrl, true);
                xhr.responseType = 'blob';

                xhr.onload = function () {
                    if (xhr.status === 200) {
                        const blob = xhr.response;
                        // 检查是否是有效的音频文件
                        if (blob.type.startsWith('audio/') && blob.size > 0) {
                            console.log('iOS音频预加载成功，文件大小:', blob.size, '类型:', blob.type);
                            resolve(true);
                        } else {
                            console.warn('文件不是有效的音频文件');
                            resolve(false);
                        }
                    } else {
                        console.warn('预加载失败，状态码:', xhr.status);
                        resolve(false);
                    }
                };

                xhr.onerror = function () {
                    console.warn('预加载请求失败');
                    resolve(false);
                };

                xhr.send();

                // 设置超时
                setTimeout(() => {
                    if (xhr.readyState !== 4) {
                        xhr.abort();
                        console.warn('预加载超时');
                        resolve(false);
                    }
                }, 10000);
            });
        }

        // 检查音频文件是否存在
        async function checkAudioExists(userId) {
            try {
                const { data, error } = await supabaseClient.storage
                    .from('love-letters')
                    .list(userId);

                if (error) {
                    console.error('检查文件列表失败:', error);
                    return false;
                }

                const audioExists = data.some(file =>
                    file.name === 'audio.mp3' ||
                    file.name === 'audio.m4a' ||
                    file.name.startsWith('audio_')
                );

                console.log(`音频文件${audioExists ? '存在' : '不存在'}`);
                return audioExists;
            } catch (error) {
                console.error('检查音频存在时出错:', error);
                return false;
            }
        }
        // ==================== loadAudio 函数修改结束 ====================

        function tryAutoPlay() {
            if (!isMediaLoaded) { console.log('媒体未加载完成，等待...'); return; }
            console.log('尝试自动播放音频...');
            audioPlayer.currentTime = 0;
            const playPromise = audioPlayer.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log('自动播放成功');
                    if (playPromptActive) { playPrompt.classList.add('hidden'); playPromptActive = false; }
                }).catch(error => {
                    console.log('自动播放被阻止:', error);
                    showPlayPrompt();
                });
            } else {
                try {
                    audioPlayer.play(); console.log('自动播放成功（旧版浏览器）');
                    if (playPromptActive) { playPrompt.classList.add('hidden'); playPromptActive = false; }
                } catch (error) { console.log('自动播放失败:', error); showPlayPrompt(); }
            }
        }

        function showPlayPrompt() {
            playPrompt.classList.remove('hidden'); playPromptActive = true;
            const playOnClick = () => {
                audioPlayer.play().then(() => {
                    console.log('点击播放成功'); playPrompt.classList.add('hidden'); playPromptActive = false;
                }).catch(e => { console.error('点击播放失败:', e); showError('播放失败，请检查音频文件'); });
            };
            playPrompt.removeEventListener('click', playOnClick); document.removeEventListener('touchstart', playOnClick);
            playPrompt.addEventListener('click', playOnClick, { once: true }); document.addEventListener('touchstart', playOnClick, { once: true });
            setTimeout(() => { if (playPromptActive) { audioPlayer.play().then(() => { playPrompt.classList.add('hidden'); playPromptActive = false; }); } }, 5000);
        }

        function showError(message) {
            loading.textContent = message; loading.classList.remove('hidden'); loading.classList.add('error');
            if (!playPromptActive) { showPlayPrompt(); }
            setTimeout(() => { location.reload(); }, 10000);
        }

        audioPlayer.addEventListener('play', () => { console.log('音频开始播放'); if (playPromptActive) { playPrompt.classList.add('hidden'); playPromptActive = false; } });
        audioPlayer.addEventListener('error', (e) => { console.error('音频播放错误:', e); if (!playPromptActive) { showPlayPrompt(); } });

        if (/(iPhone|iPod|iPad)/i.test(navigator.userAgent)) {
            window.addEventListener('load', () => { setTimeout(() => { window.scrollTo(0, 1); }, 100); });
            document.body.addEventListener('touchmove', (e) => { if (document.body.scrollHeight <= window.innerHeight) { e.preventDefault(); } }, { passive: false });
        }

        let startY; document.addEventListener('touchstart', (e) => { startY = e.touches[0].clientY; }, { passive: true });
        document.addEventListener('touchmove', (e) => { if (e.touches[0].clientY > startY && window.scrollY === 0) { e.preventDefault(); } }, { passive: false });
        window.addEventListener('load', () => {
            console.log('页面完全加载'); console.log('图片源:', backgroundImage.src); console.log('图片完成状态:', backgroundImage.complete);
            console.log('图片自然尺寸:', backgroundImage.naturalWidth, 'x', backgroundImage.naturalHeight); console.log('音频源:', audioPlayer.src); console.log('音频时长:', audioPlayer.duration);
        });
    </script>
</body>

</html>